================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\analysis\page.tsx
================================================================================
'use client';
import { useQuery } from '@tanstack/react-query';
import { useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { StatusBadge } from '../../components/StatusBadge';
import { BarChart3, TrendingUp, AlertTriangle, CheckCircle2, Package, DatabaseZap, Clock } from 'lucide-react';
import { ColumnDef } from '@tanstack/react-table';

export default function AnalysisPage() {
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080';

    const { data: stats, isLoading: statsLoading } = useQuery({
        queryKey: ['full-stats'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/analysis/stats`);
            if (!res.ok) throw new Error('Failed to fetch stats');
            return res.json();
        }
    });

    const { data: gap, isLoading: gapLoading } = useQuery({
        queryKey: ['full-gap'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/analysis/gap`);
            if (!res.ok) throw new Error('Failed to fetch gap analysis');
            return res.json();
        }
    });

    const gapColumns = useMemo<ColumnDef<any>[]>(() => [
        {
            header: 'Product / SKU',
            size: 300,
            cell: ({ row }) => (
                <div className="flex flex-col">
                    <span className="font-bold text-[11px] text-primary-900 uppercase truncate">{row.original.itemName}</span>
                    <span className="text-[9px] text-neutral-400 font-bold uppercase tracking-widest leading-none mt-0.5">OrderID: {row.original.orderId}</span>
                </div>
            )
        },
        {
            header: 'Target Qty',
            accessorKey: 'qty',
            size: 100,
            cell: (info) => <span className="tabular-nums font-bold text-neutral-400">{info.getValue() as number}</span>
        },
        {
            header: 'Actual Received',
            accessorKey: 'qtyReceived',
            size: 150,
            cell: ({ row }) => {
                const item = row.original;
                const isUnder = item.qtyReceived < item.qty;
                return (
                    <div className="flex items-center gap-2">
                        <span className={`tabular-nums font-bold ${isUnder ? 'text-error-600' : 'text-accent-600'}`}>
                            {item.qtyReceived || 0}
                        </span>
                        {isUnder && <AlertTriangle size={14} className="text-error-600" />}
                    </div>
                );
            }
        },
        {
            header: 'Variance',
            size: 120,
            cell: ({ row }) => {
                const item = row.original;
                const diff = (item.qtyReceived || 0) - item.qty;
                return (
                    <span className={`tabular-nums font-bold text-[11px] ${diff < 0 ? 'text-error-600' : diff > 0 ? 'text-accent-600' : 'text-neutral-400'}`}>
                        {diff > 0 ? `+${diff}` : diff}
                    </span>
                );
            }
        },
        {
            header: 'Stage',
            size: 150,
            cell: ({ row }) => <StatusBadge status={row.original.status} className="scale-90 origin-left" />
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent font-sans">
            <header className="mb-10 flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-extrabold text-neutral-900 tracking-tight flex items-center gap-4">
                        <div className="w-12 h-12 bg-white rounded-none shadow-[0_1px_3px_rgba(16_24_40/0.1)] flex items-center justify-center border border-neutral-200/80">
                            <BarChart3 size={28} className="text-brand-600" />
                        </div>
                        System Performance Analysis
                    </h1>
                    <p className="text-sm text-neutral-400 font-medium mt-2">Statistical deep-dive and supply chain reconciliation intelligence.</p>
                </div>
            </header>

            <main className="space-y-10">
                {/* Executive Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <AnalysisCard
                        title="Average Processing Time"
                        value="1.4h"
                        desc="Ingestion to Dispatch"
                        icon={<Clock size={20} />}
                        color="brand"
                    />
                    <AnalysisCard
                        title="Reconciliation Rate"
                        value="98.2%"
                        desc="Inventory accuracy"
                        icon={<CheckCircle2 size={20} />}
                        color="success"
                    />
                    <AnalysisCard
                        title="Critical Stock Outs"
                        value={gap?.filter((i: any) => i.qtyReceived === 0).length || 0}
                        desc="Action required"
                        icon={<AlertTriangle size={20} />}
                        color="danger"
                    />
                    <AnalysisCard
                        title="Daily Throughput"
                        value={stats?.executed || 0}
                        desc="Executed orders today"
                        icon={<TrendingUp size={20} />}
                        color="brand"
                    />
                </div>

                <div className="grid grid-cols-1">
                    {/* Gap Analysis Table */}
                    <section className="flex flex-col gap-4">
                        <div className="flex items-center justify-between px-2 mb-1">
                            <div className="flex items-center gap-3">
                                <h2 className="text-sm font-semibold text-neutral-800">Comprehensive Gap Analysis</h2>
                                <span className="text-[10px] text-neutral-400 uppercase tracking-widest font-medium">Discrepancy Audit</span>
                            </div>
                            <span className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">Global SKU Registry</span>
                        </div>
                        <div className="app-card overflow-hidden bg-white">
                            <DataGrid
                                data={gap || []}
                                columns={gapColumns}
                                isLoading={gapLoading}
                            />
                        </div>
                    </section>
                </div>
            </main>
        </div>
    );
}

function AnalysisCard({
    title,
    value,
    desc,
    icon,
    color
}: {
    title: string,
    value: string | number,
    desc: string,
    icon: React.ReactNode,
    color: 'brand' | 'success' | 'danger'
}) {
    const statusConfig = {
        brand: { badge: 'bg-brand-50 text-brand-700 border-brand-100', icon: 'text-brand-600' },
        success: { badge: 'bg-success-50 text-success-700 border-success-100', icon: 'text-success-600' },
        danger: { badge: 'bg-danger-50 text-danger-700 border-danger-100', icon: 'text-danger-600' },
    }[color];

    return (
        <div className="app-card p-6 flex flex-col gap-4 group">
            <div className="flex items-start justify-between">
                <div className="w-10 h-10 rounded-none bg-neutral-100 border border-neutral-200 flex items-center justify-center smooth-transition group-hover:border-brand-200 group-hover:bg-brand-50/50">
                    <div className={statusConfig.icon}>
                        {icon}
                    </div>
                </div>
                <div className="text-[9px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-full bg-neutral-50 text-neutral-400 border border-neutral-200/60">
                    Live Audit
                </div>
            </div>

            <div className="flex flex-col">
                <div className="text-[11px] font-semibold text-neutral-500 uppercase tracking-wider mb-1">
                    {title}
                </div>
                <div className="text-3xl font-extrabold text-neutral-900 tabular-nums tracking-tight">
                    {value}
                </div>
                <div className="mt-1 text-[11px] text-neutral-400 font-medium flex items-center gap-2">
                    <div className={`w-1.5 h-1.5 rounded-full ${color === 'danger' ? 'bg-danger-500' : color === 'success' ? 'bg-success-500' : 'bg-brand-500'}`} />
                    {desc}
                </div>
            </div>
        </div>
    );
}

// Update the main return to include section headers as per Fix #5
// ... [Lines 84-154 will be updated in the caller]





================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\billing\page.tsx
================================================================================
'use client';
import { DollarSign, Receipt } from 'lucide-react';

export default function BillingPlaceholder() {
    return (
        <div className="flex flex-col h-full bg-transparent">
            <header className="mb-6">
                <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-3">
                    <div className="w-10 h-10 bg-white rounded-none shadow-soft flex items-center justify-center border border-neutral-200/60">
                        <DollarSign size={22} className="text-brand-600" />
                    </div>
                    Billing Management
                </h1>
                <p className="text-sm text-neutral-500 mt-1">Invoice processing and status updates</p>
            </header>

            <div className="app-card overflow-hidden flex-1">
                <div className="p-12 text-center">
                    <Receipt className="w-16 h-16 mx-auto text-neutral-300 mb-4" />
                    <h3 className="text-lg font-bold text-neutral-700 mb-2">Coming Soon</h3>
                    <p className="text-sm text-neutral-500">Billing interface will be available shortly.</p>
                    <p className="text-xs text-neutral-400 mt-2">Note: Billing features may be redundant with order-slips/:id page</p>
                </div>
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\duty-sessions\page.tsx
================================================================================
'use client';
import { useQuery } from '@tanstack/react-query';
import { useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { Clock } from 'lucide-react';
import type { ColumnDef } from '@tanstack/react-table';

interface DutySession {
    id: string;
    userId: string;
    startTime: string;
    endTime: string | null;
    active: boolean;
}

export default function DutySessionsPage() {
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';

    const { data: sessions, isLoading } = useQuery({
        queryKey: ['duty-sessions'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/duty-sessions`);
            if (!res.ok) throw new Error('Failed to fetch duty sessions');
            return res.json();
        }
    });

    const columns = useMemo<ColumnDef<DutySession>[]>(() => [
        {
            header: 'User ID',
            accessorKey: 'userId',
            size: 280,
            cell: ({ row }) => (
                <span className="text-xs font-mono text-neutral-600">{row.original.userId}</span>
            )
        },
        {
            header: 'Start Time',
            accessorKey: 'startTime',
            size: 160,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-900">
                    {new Date(row.original.startTime).toLocaleString()}
                </span>
            )
        },
        {
            header: 'End Time',
            accessorKey: 'endTime',
            size: 160,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-900">
                    {row.original.endTime ? new Date(row.original.endTime).toLocaleString() : '-'}
                </span>
            )
        },
        {
            header: 'Status',
            accessorKey: 'active',
            size: 100,
            cell: ({ row }) => (
                <span className={`text-xs font-bold ${row.original.active ? 'text-success-600' : 'text-neutral-400'}`}>
                    {row.original.active ? 'Active' : 'Ended'}
                </span>
            )
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent">
            <header className="mb-6">
                <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-3">
                    <div className="w-10 h-10 bg-white shadow-soft flex items-center justify-center border border-neutral-200/60">
                        <Clock size={22} className="text-brand-600" />
                    </div>
                    Duty Sessions
                </h1>
                <p className="text-sm text-neutral-500 mt-1">Track billing staff duty sessions</p>
            </header>

            <div className="app-card overflow-hidden flex-1">
                <DataGrid data={sessions || []} columns={columns} isLoading={isLoading} />
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\ledger\page.tsx
================================================================================
'use client';
import { useQuery } from '@tanstack/react-query';
import { useState, useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { FilterBar } from '../../components/FilterBar';
import { StatusBadge } from '../../components/StatusBadge';
import { ListChecks, Search, Info } from 'lucide-react';
import { ColumnDef } from '@tanstack/react-table';

export default function MasterLedgerPage() {
    const [searchTerm, setSearchTerm] = useState('');
    const [filters, setFilters] = useState<Record<string, string>>({});

    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080';

    const { data: ledger, isLoading } = useQuery({
        queryKey: ['master-ledger', filters, searchTerm],
        queryFn: async () => {
            const params = new URLSearchParams({
                ...filters,
                search: searchTerm,
                limit: '100' // Show more on the full ledger page
            });
            const res = await fetch(`${apiUrl}/analysis/ledger?${params.toString()}`);
            if (!res.ok) throw new Error('Failed to fetch ledger');
            return res.json();
        }
    });

    const columns = useMemo<ColumnDef<any>[]>(() => [
        {
            header: 'Timestamp',
            size: 180,
            cell: ({ row }) => (
                <div className="flex flex-col">
                    <span className="tabular-nums text-[10px] font-bold text-primary-900 uppercase">
                        {new Date(row.original.eventDatetime).toLocaleDateString()}
                    </span>
                    <span className="tabular-nums text-[9px] text-neutral-400 font-bold uppercase tracking-tighter">
                        {new Date(row.original.eventDatetime).toLocaleTimeString()}
                    </span>
                </div>
            )
        },
        {
            header: 'Item Identifier',
            size: 250,
            cell: ({ row }) => (
                <div className="flex flex-col">
                    <span className="text-[11px] font-bold text-primary-900 uppercase truncate">{row.original.itemNew}</span>
                    <span className="text-[9px] text-neutral-400 font-bold uppercase tracking-widest leading-none mt-0.5">Ref: {row.original.id.substring(0, 12)}</span>
                </div>
            )
        },
        {
            header: 'Supplier',
            accessorKey: 'supplier',
            size: 150,
            cell: (info) => <span className="text-[10px] font-bold text-primary-700 uppercase tracking-tight">{info.getValue() as string}</span>
        },
        {
            header: 'Current Status',
            size: 180,
            cell: ({ row }) => <StatusBadge status={row.original.status} />
        },
        {
            header: 'Processing Staff',
            size: 150,
            cell: ({ row }) => (
                <div className="flex items-center gap-2">
                    <div className="w-5 h-5 rounded-full bg-neutral-100 border border-neutral-200 flex items-center justify-center text-[8px] font-bold text-neutral-500 uppercase">
                        {row.original.staff?.substring(0, 2).toUpperCase()}
                    </div>
                    <span className="text-[10px] font-bold text-neutral-500 uppercase tracking-tighter">{row.original.staff?.split('@')[0]}</span>
                </div>
            )
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent font-sans">
            <header className="mb-10 flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-extrabold text-neutral-900 tracking-tight flex items-center gap-4">
                        <div className="w-12 h-12 bg-white rounded-none shadow-soft flex items-center justify-center border border-neutral-200/60">
                            <ListChecks size={28} className="text-brand-600" />
                        </div>
                        Master Status Ledger
                    </h1>
                    <p className="text-sm text-neutral-500 font-medium mt-2">End-to-end transaction transparency and procurement audit trail.</p>
                </div>
                <div className="flex items-center gap-4">
                    <FilterBar
                        filters={[
                            {
                                key: 'status', label: 'Status', options: [
                                    { label: 'PENDING', value: 'PENDING' },
                                    { label: 'REP_ALLOCATION', value: 'REP_ALLOCATION' },
                                    { label: 'SLIP_GENERATED', value: 'SLIP_GENERATED' },
                                    { label: 'BILLED', value: 'BILLED' },
                                    { label: 'DAMAGED', value: 'DAMAGED' },
                                    { label: 'MISSING', value: 'MISSING' }
                                ]
                            }
                        ]}
                        onFilterChange={(key, val) => setFilters(prev => ({ ...prev, [key]: val }))}
                        onSearch={setSearchTerm}
                        onReset={() => { setFilters({}); setSearchTerm(''); }}
                    />
                </div>
            </header>

            <main className="space-y-6">
                <div className="app-card bg-white p-2">
                    <DataGrid
                        data={ledger || []}
                        columns={columns}
                        isLoading={isLoading}
                    />
                </div>

                {!isLoading && ledger?.length === 0 && (
                    <div className="app-card bg-white p-20 text-center">
                        <div className="max-w-xs mx-auto">
                            <div className="w-16 h-16 bg-neutral-100/50 rounded-none flex items-center justify-center mx-auto mb-6">
                                <Search size={32} className="text-neutral-300" />
                            </div>
                            <h3 className="text-base font-bold text-neutral-900">No Records Found</h3>
                            <p className="text-xs text-neutral-400 mt-2 font-medium">Adjust your search or filters to locate specific entries in the ledger.</p>
                        </div>
                    </div>
                )}
            </main>
        </div>
    );
}





================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\login\page.tsx
================================================================================
'use client';
import { useState } from 'react';
import { auth } from '../../src/lib/firebase';
import { signInWithEmailAndPassword } from 'firebase/auth';
import { useRouter } from 'next/navigation';

export default function LoginPage() {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const router = useRouter();

    const handleLogin = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
            await signInWithEmailAndPassword(auth, email, password);
            router.push('/');
        } catch (err: any) {
            setError(err.message || 'Login failed');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-neutral-50 px-4 relative overflow-hidden">
            {/* Background Decor */}
            <div className="absolute -top-24 -left-24 w-96 h-96 bg-brand-500/10 blur-[120px] rounded-full" />
            <div className="absolute -bottom-32 -right-32 w-80 h-80 bg-success-500/10 blur-[100px] rounded-full" />

            <div className="w-full max-w-md relative">
                <div className="bg-white/80 backdrop-blur-xl border border-white/50 rounded-[32px] shadow-2xl p-10 relative z-10 transition-all">
                    <div className="text-center mb-10">
                        <div className="w-16 h-16 bg-gradient-to-br from-brand-500 to-brand-600 rounded-none shadow-lg shadow-brand-500/20 flex items-center justify-center mx-auto mb-6 active:scale-95 transition-transform cursor-default">
                            <div className="w-8 h-8 bg-white/20 rounded-none backdrop-blur-sm border border-white/30" />
                        </div>
                        <h1 className="text-3xl font-extrabold text-neutral-900 tracking-tight">Sahakar PPO</h1>
                        <p className="text-xs text-neutral-400 font-bold uppercase tracking-widest mt-2">Intelligent Procurement Infrastructure</p>
                    </div>

                    <div className="mb-8 p-6 bg-neutral-50/50 rounded-none border border-neutral-200/50">
                        <label className="block text-[10px] font-bold text-neutral-400 uppercase tracking-widest mb-3">Dev Identity Selector</label>
                        <select
                            className="w-full px-4 py-3 rounded-none border border-neutral-200 text-sm bg-white focus:ring-2 focus:ring-brand-500/20 outline-none transition-all font-semibold text-neutral-700 appearance-none shadow-sm cursor-pointer"
                            onChange={(e) => {
                                const [selectedEmail, selectedPassword] = e.target.value.split('|');
                                if (selectedEmail && selectedPassword) {
                                    setEmail(selectedEmail);
                                    setPassword(selectedPassword);
                                }
                            }}
                            defaultValue=""
                        >
                            <option value="">Select a user role...</option>
                            <option value="drisya.purchase.sahakar@gmail.com|R8@dQ7!MZxP2#c">Drisya (Purchase Staff)</option>
                            <option value="jamsheera.purchase.sahakar@gmail.com|K!4sWQ9@b#2LrZ">Jamsheera (Purchase Staff)</option>
                            <option value="sujitha.purchase.sahakar@gmail.com|ZC#8@wM!5L2R9">Sujitha (Purchase Staff)</option>
                            <option value="abhi.billinghead.sahakar@gmail.com|@9KZr!5C7W2#b">Abhi (Billing Head)</option>
                            <option value="sujeev.billing.sahakar@gmail.com|B7!@MZC9#2rW5">Sujeev (Billing Staff)</option>
                            <option value="shafi.billing.sahakar@gmail.com|#C5Z!9W7@2MrB">Shafi (Billing Staff)</option>
                            <option value="shiji.billing.sahakar@gmail.com|9@#B7ZC!5WMr2">Shiji (Billing Staff)</option>
                            <option value="vivek.billing.sahakar@gmail.com|Z!C@9#7W2MBr5">Vivek (Billing Staff)</option>
                            <option value="jalvan.billing.sahakar@gmail.com|@WZ9#7!B2CMr5">Jalvan (Billing Staff)</option>
                            <option value="suhail.billing.sahakar@gmail.com|5Z@#C9!7WM2Br">Suhail (Billing Staff)</option>
                            <option value="fayis.billing.sahakar@gmail.com|7!Z@C#9WMB2r5">Fayis (Billing Staff)</option>
                            <option value="ashiqmohammedmannarppil@gmail.com|@9C7Z!W#2MB5r">Ashiq (Admin)</option>
                            <option value="sarath.purchase.sahakar@gmail.com|Z#@7C!9WMB2r5">Sarath (Admin)</option>
                            <option value="frpboy12@gmail.com|C9Z@#7!WMB2r5">Rahul (Super Admin)</option>
                            <option value="sahakarhoit@gmail.com|@ZC9#7!WMB2r5">Zabnix (Super Admin)</option>
                            <option value="zabnixprivatelimited@gmail.com|7Z@C9#!WMB2r5">Zabnix Co (Super Admin)</option>
                            <option value="vipeesh.purchase.sahakar@gmail.com|!ZC@9#7WMB2r5">Vipeesh (Procurement Head)</option>
                        </select>
                    </div>

                    <form onSubmit={handleLogin} className="space-y-6">
                        <div className="space-y-2">
                            <label className="block text-[10px] font-bold text-neutral-400 uppercase tracking-widest ml-1">Secure Email</label>
                            <input
                                type="email"
                                required
                                className="w-full px-5 py-4 rounded-none bg-neutral-50/50 border border-neutral-200 text-sm focus:ring-4 focus:ring-brand-500/10 focus:border-brand-500 outline-none transition-all font-medium"
                                placeholder="name@sahakar.com"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                            />
                        </div>

                        <div className="space-y-2">
                            <label className="block text-[10px] font-bold text-neutral-400 uppercase tracking-widest ml-1">Access Passphrase</label>
                            <input
                                type="password"
                                required
                                className="w-full px-5 py-4 rounded-none bg-neutral-50/50 border border-neutral-200 text-sm focus:ring-4 focus:ring-brand-500/10 focus:border-brand-500 outline-none transition-all font-medium"
                                placeholder="••••••••"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                            />
                        </div>

                        {error && (
                            <div className="p-4 rounded-none bg-danger-50 text-danger-600 text-[11px] font-bold border border-danger-100 uppercase tracking-tight animate-in shake-in duration-300">
                                {error}
                            </div>
                        )}

                        <button
                            type="submit"
                            disabled={loading}
                            className="w-full py-4 bg-brand-600 text-white rounded-none font-bold hover:bg-brand-700 shadow-xl shadow-brand-500/20 active:scale-[0.98] disabled:opacity-50 disabled:pointer-events-none transition-all text-sm uppercase tracking-widest"
                        >
                            {loading ? 'Verifying Credentials...' : 'Access Command Center'}
                        </button>
                    </form>

                    <div className="mt-12 pt-8 border-t border-neutral-100/50">
                        <div className="flex justify-center items-center gap-6 text-[10px] text-neutral-400 font-bold uppercase tracking-[0.2em] opacity-60">
                            <span>GCP Enterprise</span>
                            <div className="w-1 h-1 bg-neutral-200 rounded-full" />
                            <span>Vercel Edge</span>
                            <div className="w-1 h-1 bg-neutral-200 rounded-full" />
                            <span>AES-256</span>
                        </div>
                    </div>
                </div>

                {/* Decorative Elements */}
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] border border-brand-500/5 rounded-full pointer-events-none -z-10" />
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[140%] h-[140%] border border-brand-500/5 rounded-full pointer-events-none -z-10" />
            </div>
        </div>
    );
}





================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\logs\page.tsx
================================================================================
'use client';
import { useQuery } from '@tanstack/react-query';
import { useState, useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { FileText } from 'lucide-react';
import type { ColumnDef } from '@tanstack/react-table';

interface AuditEvent {
    id: string;
    entityType: string;
    entityId: string;
    action: string;
    beforeState: string;
    afterState: string;
    actor: string;
    createdAt: string;
}

export default function LogsPage() {
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';
    const [filters, setFilters] = useState({ entityType: '', action: '', actor: '' });

    const { data: logs, isLoading } = useQuery({
        queryKey: ['audit-events', filters],
        queryFn: async () => {
            const params = new URLSearchParams();
            if (filters.entityType) params.append('entityType', filters.entityType);
            if (filters.action) params.append('action', filters.action);
            if (filters.actor) params.append('actor', filters.actor);
            const res = await fetch(`${apiUrl}/audit-events?${params}`);
            if (!res.ok) throw new Error('Failed to fetch audit logs');
            return res.json();
        }
    });

    const columns = useMemo<ColumnDef<AuditEvent>[]>(() => [
        {
            header: 'Timestamp',
            accessorKey: 'createdAt',
            size: 160,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-900">
                    {new Date(row.original.createdAt).toLocaleString()}
                </span>
            )
        },
        {
            header: 'Entity',
            accessorKey: 'entityType',
            size: 140,
            cell: ({ row }) => (
                <span className="text-xs font-bold text-brand-600">{row.original.entityType}</span>
            )
        },
        {
            header: 'Action',
            accessorKey: 'action',
            size: 120,
            cell: ({ row }) => (
                <span className="text-xs font-semibold text-neutral-900">{row.original.action}</span>
            )
        },
        {
            header: 'Actor',
            accessorKey: 'actor',
            size: 200,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-600">{row.original.actor}</span>
            )
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent">
            <header className="mb-6">
                <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-3">
                    <div className="w-10 h-10 bg-white shadow-soft flex items-center justify-center border border-neutral-200/60">
                        <FileText size={22} className="text-brand-600" />
                    </div>
                    Audit Logs
                </h1>
                <p className="text-sm text-neutral-500 mt-1">System activity and audit trail</p>
            </header>

            <div className="mb-4 grid grid-cols-3 gap-3">
                <input
                    type="text"
                    placeholder="Entity Type (e.g. ORDER_SLIP)"
                    value={filters.entityType}
                    onChange={(e) => setFilters({ ...filters, entityType: e.target.value })}
                    className="px-3 py-2 border border-neutral-300 focus:ring-2 focus:ring-brand-500 text-sm"
                />
                <input
                    type="text"
                    placeholder="Action (e.g. CREATE)"
                    value={filters.action}
                    onChange={(e) => setFilters({ ...filters, action: e.target.value })}
                    className="px-3 py-2 border border-neutral-300 focus:ring-2 focus:ring-brand-500 text-sm"
                />
                <input
                    type="text"
                    placeholder="Actor (email)"
                    value={filters.actor}
                    onChange={(e) => setFilters({ ...filters, actor: e.target.value })}
                    className="px-3 py-2 border border-neutral-300 focus:ring-2 focus:ring-brand-500 text-sm"
                />
            </div>

            <div className="app-card overflow-hidden flex-1">
                <DataGrid data={logs || []} columns={columns} isLoading={isLoading} />
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\name-changes\page.tsx
================================================================================
'use client';
import { useQuery } from '@tanstack/react-query';
import { useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { Edit3 } from 'lucide-react';
import type { ColumnDef } from '@tanstack/react-table';

interface NameChange {
    id: string;
    productId: string;
    supplierId?: string;
    oldName: string;
    newName: string;
    reason?: string;
    effectiveFrom: string;
    effectiveTo?: string;
    createdAt: string;
    productName?: string;
    supplierName?: string;
}

export default function NameChangesPage() {
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';

    const { data: nameChanges, isLoading } = useQuery({
        queryKey: ['name-changes'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/name-changes`);
            if (!res.ok) throw new Error('Failed to fetch name changes');
            return res.json();
        }
    });

    const columns = useMemo<ColumnDef<NameChange>[]>(() => [
        {
            header: 'Date',
            accessorKey: 'createdAt',
            size: 120,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-900">
                    {new Date(row.original.createdAt).toLocaleDateString()}
                </span>
            )
        },
        {
            header: 'Product',
            accessorKey: 'productName',
            size: 180,
            cell: ({ row }) => (
                <span className="text-xs font-semibold text-brand-600">{row.original.productName || 'Unknown'}</span>
            )
        },
        {
            header: 'Old Name',
            accessorKey: 'oldName',
            size: 200,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-600">{row.original.oldName}</span>
            )
        },
        {
            header: 'New Name',
            accessorKey: 'newName',
            size: 200,
            cell: ({ row }) => (
                <span className="text-xs font-semibold text-neutral-900">{row.original.newName}</span>
            )
        },
        {
            header: 'Supplier',
            accessorKey: 'supplierName',
            size: 150,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-600">{row.original.supplierName || '-'}</span>
            )
        },
        {
            header: 'Reason',
            accessorKey: 'reason',
            size: 250,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-600">{row.original.reason || '-'}</span>
            )
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent">
            <header className="mb-6">
                <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-3">
                    <div className="w-10 h-10 bg-white shadow-soft flex items-center justify-center border border-neutral-200/60">
                        <Edit3 size={22} className="text-brand-600" />
                    </div>
                    Product Name Changes
                </h1>
                <p className="text-sm text-neutral-500 mt-1">Track product name modification history</p>
            </header>

            <div className="app-card overflow-hidden flex-1">
                <DataGrid data={nameChanges || []} columns={columns} isLoading={isLoading} />
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\order-import\page.tsx
================================================================================
'use client';
import { useState, useMemo } from 'react';
import { Upload, CheckCircle, AlertTriangle, Info, FileText, LayoutDashboard, Archive, Package, BarChart3, ListChecks } from 'lucide-react';
import { DataGrid } from '../../components/DataGrid';
import { ColumnDef } from '@tanstack/react-table';
import { useUserRole } from '../../context/UserRoleContext';

export default function OrderImportPage() {
    const { currentUser } = useUserRole();
    const [file, setFile] = useState<File | null>(null);
    const [uploading, setUploading] = useState(false);
    const [result, setResult] = useState<any>(null);

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files) {
            setFile(e.target.files[0]);
        }
    };

    const handleUpload = async () => {
        console.log('handleUpload triggered', { file, currentUser });
        if (!file) {
            alert('Please select a file first');
            return;
        }
        if (!currentUser) {
            console.error('User not logged in or role not fetched');
            alert('User context missing. Please refresh the page.');
            return;
        }

        setUploading(true);
        setResult(null);

        const formData = new FormData();
        formData.append('file', file);
        formData.append('userEmail', currentUser.email || 'unknown@sahakar.com');

        try {
            const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';
            console.log('Fetching from:', apiUrl);
            const res = await fetch(`${apiUrl}/ppo/import/upload`, {
                method: 'POST',
                body: formData,
            });

            const data = await res.json();
            setResult(data);
        } catch (error) {
            console.error(error);
            setResult({ error: 'Upload failed' });
        } finally {
            setUploading(false);
        }
    };

    const columns = useMemo<ColumnDef<any>[]>(() => [
        { header: 'Row', accessorKey: 'row', size: 60 },
        { header: 'Product', accessorKey: 'productName', size: 250 },
        { header: 'Qty', accessorKey: 'qty', size: 80, cell: (info) => <span className="tabular-nums font-medium">{info.getValue() as number}</span> },
        { header: 'Supplier', accessorKey: 'supplierName', size: 200 },
        {
            header: 'Status', accessorKey: 'status', size: 120, cell: (info) => {
                const status = info.getValue() as string;
                const isError = status.toLowerCase().includes('error');
                return (
                    <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${isError ? 'bg-error-100 text-error-600' : 'bg-accent-100 text-accent-600'}`}>
                        {status.toUpperCase()}
                    </span>
                );
            }
        },
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent font-sans">
            <header className="mb-10 flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-extrabold text-neutral-900 tracking-tight flex items-center gap-4">
                        <div className="w-12 h-12 bg-white rounded-none shadow-[0_1px_3px_rgba(16_24_40/0.1)] flex items-center justify-center border border-neutral-200/80">
                            <Upload size={28} className="text-brand-600" />
                        </div>
                        PPO Input & Ingestion
                    </h1>
                    <p className="text-sm text-neutral-400 font-medium mt-2">Bulk import purchase orders and convert them into system-tracked allocations.</p>
                </div>
            </header>

            <main className="space-y-10">
                <section className="app-card p-12 bg-white flex flex-col items-center">
                    <div className="max-w-2xl w-full text-center">
                        <div className="w-16 h-16 bg-neutral-100 border border-neutral-200 rounded-none flex items-center justify-center mx-auto mb-6">
                            <FileText size={32} className="text-brand-600" />
                        </div>
                        <h2 className="text-xl font-bold text-neutral-900 mb-2 tracking-tight">Upload Purchase Orders</h2>
                        <p className="text-sm text-neutral-400 font-medium mb-10">Select one or multiple PPO files to begin the ingestion process.</p>

                        <div className="flex items-center justify-center">
                            <input
                                type="file"
                                accept=".xlsx"
                                onChange={handleFileChange}
                                className="hidden"
                                id="file-upload"
                            />
                            <label
                                htmlFor="file-upload"
                                className="btn-brand cursor-pointer flex items-center gap-3 shadow-xl shadow-brand-500/20"
                            >
                                <LayoutDashboard size={20} />
                                Select PPO SpreadSheet
                            </label>
                        </div>
                        {file && (
                            <div className="mt-6 flex flex-col items-center gap-4 animate-in fade-in zoom-in-95 duration-200">
                                <div className="px-4 py-2 bg-neutral-50 border border-neutral-200 rounded-none text-sm font-semibold text-neutral-700 flex items-center gap-2">
                                    <FileText size={16} className="text-brand-600" />
                                    {file.name}
                                </div>
                                <button
                                    onClick={handleUpload}
                                    disabled={uploading}
                                    className="btn-brand w-full max-w-xs"
                                >
                                    {uploading ? 'Processing Pipeline...' : 'Execute Ingestion'}
                                </button>
                            </div>
                        )}
                    </div>
                </section>

                {result && !result.error && (
                    <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <SummaryCard
                                label="Total Orders"
                                value={result.totalOrders}
                                icon={<Archive size={20} />}
                                color="brand"
                            />
                            <SummaryCard
                                label="Total Items"
                                value={result.totalItems}
                                icon={<Package size={20} />}
                                color="brand"
                            />
                            <SummaryCard
                                label="Total Quantity"
                                value={result.totalQty}
                                icon={<BarChart3 size={20} />}
                                color="success"
                            />
                            <SummaryCard
                                label="Suppliers Found"
                                value={result.suppliers?.length}
                                icon={<ListChecks size={20} />}
                                color="brand"
                            />
                        </div>

                        <div className="flex items-center justify-between px-2 mb-1">
                            <div className="flex items-center gap-3">
                                <h2 className="text-sm font-semibold text-neutral-800">Processed Items Preview</h2>
                                <span className="text-[10px] text-neutral-400 uppercase tracking-widest font-medium">Data Validation Registry</span>
                            </div>
                        </div>

                        <div className="app-card overflow-hidden bg-white">
                            <DataGrid
                                data={result.preview || []}
                                columns={columns}
                            />
                        </div>

                        {/* Error Log */}
                        {result.errors && result.errors.length > 0 && (
                            <div className="app-card overflow-hidden border-danger-200/50">
                                <div className="bg-danger-50 px-6 py-4 border-b border-danger-200/50">
                                    <h3 className="text-sm font-bold text-danger-700 flex items-center gap-2 uppercase tracking-wide">
                                        <AlertTriangle size={18} />
                                        Validation Error Report
                                    </h3>
                                </div>
                                <div className="max-h-80 overflow-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-neutral-50 text-[10px] text-neutral-400 font-bold uppercase sticky top-0 shadow-sm border-b border-neutral-200/60">
                                            <tr>
                                                <th className="px-6 py-3 text-left">Excel Row</th>
                                                <th className="px-6 py-3 text-left">Validation Issue</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-neutral-100/60">
                                            {result.errors.map((err: any, i: number) => (
                                                <tr key={i} className="hover:bg-danger-50 transition-colors">
                                                    <td className="px-6 py-3 tabular-nums font-bold text-danger-600">{err.row}</td>
                                                    <td className="px-6 py-3 text-neutral-600 text-xs font-medium">{err.error}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </main>
        </div>
    );
}

function SummaryCard({ label, value, icon, color }: { label: string, value: any, icon: React.ReactNode, color: 'brand' | 'success' }) {
    const statusConfig = {
        brand: { badge: 'bg-brand-50 text-brand-700 border-brand-100', icon: 'text-brand-600' },
        success: { badge: 'bg-success-50 text-success-700 border-success-100', icon: 'text-success-600' },
    }[color];

    return (
        <div className="app-card p-6 flex flex-col gap-4 group">
            <div className="flex items-start justify-between">
                <div className="w-10 h-10 rounded-none bg-neutral-100 border border-neutral-200 flex items-center justify-center smooth-transition group-hover:border-brand-200 group-hover:bg-brand-50/50">
                    <div className={statusConfig.icon}>
                        {icon}
                    </div>
                </div>
                <div className="text-[9px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-full bg-neutral-50 text-neutral-400 border border-neutral-200/60">
                    System Meta
                </div>
            </div>

            <div className="flex flex-col">
                <div className="text-[11px] font-semibold text-neutral-500 uppercase tracking-wider mb-1">
                    {label}
                </div>
                <div className="text-3xl font-extrabold text-neutral-900 tabular-nums tracking-tight">
                    {value || 0}
                </div>
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\order-slips\[id]\page.tsx
================================================================================



================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\order-slips\history\page.tsx
================================================================================
'use client';
import { History, FileStack } from 'lucide-react';

export default function SlipHistoryPage() {
    return (
        <div className="flex flex-col h-full bg-transparent">
            <header className="mb-6">
                <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-3">
                    <div className="w-10 h-10 bg-white rounded-none shadow-soft flex items-center justify-center border border-neutral-200/60">
                        <History size={22} className="text-brand-600" />
                    </div>
                    Order Slip History
                </h1>
                <p className="text-sm text-neutral-500 mt-1">Historical order slips archive</p>
            </header>

            <div className="app-card overflow-hidden flex-1">
                <div className="p-12 text-center">
                    <FileStack className="w-16 h-16 mx-auto text-neutral-300 mb-4" />
                    <h3 className="text-lg font-bold text-neutral-700 mb-2">Coming Soon</h3>
                    <p className="text-sm text-neutral-500">Historical slip viewer will be available shortly.</p>
                    <p className="text-xs text-neutral-400 mt-2">Can reuse existing order-slips queries with date range filters</p>
                </div>
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\order-slips\page.tsx
================================================================================
'use client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { useState, useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { ConfirmModal } from '../../components/ConfirmModal';
import { useToast } from '../../components/Toast';
import { useUserRole } from '../../context/UserRoleContext';
import { FileSearch, Plus, Printer, Info } from 'lucide-react';
import { ColumnDef } from '@tanstack/react-table';

export default function OrderSlipsPage() {
    const { currentUser, can } = useUserRole();
    const queryClient = useQueryClient();
    const router = useRouter();
    const { showToast } = useToast();

    const [isGenerateModalOpen, setIsGenerateModalOpen] = useState(false);

    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8080';

    const { data: slips, isLoading } = useQuery({
        queryKey: ['order-slips'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/order-slips`);
            if (!res.ok) throw new Error('Failed to fetch slips');
            return res.json();
        },
    });

    const generateMutation = useMutation({
        mutationFn: async () => {
            const res = await fetch(`${apiUrl}/order-slips/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userEmail: currentUser?.email || 'unknown@sahakar.com' }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'Generation failed');
            return data;
        },
        onSuccess: (data) => {
            showToast(data.message || 'Slips generated successfully', 'success');
            queryClient.invalidateQueries({ queryKey: ['order-slips'] });
            queryClient.invalidateQueries({ queryKey: ['rep-items'] });
            queryClient.invalidateQueries({ queryKey: ['pending-items'] });
            setIsGenerateModalOpen(false);
        },
        onError: (err: any) => {
            showToast(err.message, 'error');
        }
    });

    const columns = useMemo<ColumnDef<any>[]>(() => [
        {
            header: 'Slip Reference',
            size: 150,
            cell: ({ row }) => (
                <div className="flex flex-col">
                    <span className="font-mono text-[10px] text-primary-700 font-bold tracking-tight uppercase">#{row.original.id.substring(0, 8)}</span>
                    <span className="text-[9px] text-neutral-400 font-bold uppercase tracking-widest">Sahakar Internal</span>
                </div>
            )
        },
        {
            header: 'Supplier Name',
            accessorKey: 'supplier',
            size: 250,
            cell: (info) => <span className="font-bold text-primary-900 group-hover:text-primary-700 transition-colors uppercase text-[11px] tracking-tight">{info.getValue() as string}</span>
        },
        {
            header: 'Created On',
            size: 150,
            cell: ({ row }) => (
                <span className="tabular-nums text-[11px] font-bold text-neutral-500 uppercase">
                    {new Date(row.original.slipDate).toLocaleDateString(undefined, { day: '2-digit', month: 'short', year: 'numeric' })}
                </span>
            )
        },
        {
            header: 'Items',
            size: 100,
            cell: ({ row }) => (
                <div className="flex items-center gap-2">
                    <span className="tabular-nums font-bold text-primary-900">{row.original._count?.items || 0}</span>
                    <span className="text-[9px] font-bold text-neutral-400 uppercase tracking-widest">SKUs</span>
                </div>
            )
        },
        {
            header: 'Actions',
            size: 150,
            cell: ({ row }) => (
                <div className="flex items-center gap-3">
                    <Link href={`/order-slips/${row.original.id}`} className="px-3 py-1 text-primary-700 bg-neutral-50 hover:bg-neutral-100 border border-neutral-200 rounded text-[10px] font-bold uppercase tracking-widest transition-all flex items-center gap-2">
                        <FileSearch size={14} /> View Slip
                    </Link>
                </div>
            )
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent font-sans">
            <header className="mb-10 flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-extrabold text-neutral-900 tracking-tight flex items-center gap-4">
                        <div className="w-12 h-12 bg-white rounded-none shadow-soft flex items-center justify-center border border-neutral-200/60">
                            <Printer size={28} className="text-brand-600" />
                        </div>
                        Order Slips Ledger
                    </h1>
                    <p className="text-sm text-neutral-500 font-medium mt-2">Billing consolidation and dispatch readiness for supplier orders.</p>
                </div>

                {can('generate_slips') && (
                    <button
                        onClick={() => setIsGenerateModalOpen(true)}
                        className="btn-brand shadow-lg shadow-brand-500/20"
                        disabled={generateMutation.isPending}
                    >
                        <Plus size={18} />
                        {generateMutation.isPending ? 'Processing...' : 'Batch Generate Slips'}
                    </button>
                )}
            </header>

            <main className="space-y-6">
                <div className="app-card bg-white p-2">
                    <DataGrid
                        data={slips || []}
                        columns={columns}
                        isLoading={isLoading}
                        onRowClick={(row) => router.push(`/order-slips/${row.id}`)}
                    />
                </div>

                {!isLoading && slips?.length === 0 && (
                    <div className="app-card bg-white p-20 text-center">
                        <div className="max-w-xs mx-auto">
                            <div className="w-16 h-16 bg-neutral-100/50 rounded-none flex items-center justify-center mx-auto mb-6">
                                <Info size={32} className="text-neutral-300" />
                            </div>
                            <h3 className="text-base font-bold text-neutral-900">No Active Slips Found</h3>
                            <p className="text-xs text-neutral-400 mt-2 font-medium">Generate slips from the REP Allocation ledger to begin processing.</p>
                        </div>
                    </div>
                )}
            </main>

            <ConfirmModal
                isOpen={isGenerateModalOpen}
                onConfirm={() => generateMutation.mutate()}
                onCancel={() => setIsGenerateModalOpen(false)}
                title="Batch Slips Generation"
                message="This will automatically group all current allocations by supplier and create printable order slips. This action is final and will move items out of the allocation stage. Proceed?"
                confirmLabel="Begin Generation"
                variant="primary"
            />
        </div>
    );
}






================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\pending-orders\page.tsx
================================================================================
'use client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useState, useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { FilterBar } from '../../components/FilterBar';
import { StatusBadge } from '../../components/StatusBadge';
import { ConfirmModal } from '../../components/ConfirmModal';
import { useToast } from '../../components/Toast';
import { ClipboardList, Edit, Send, Info, CheckCircle2, XCircle } from 'lucide-react';
import { ColumnDef } from '@tanstack/react-table';
import { useUserRole } from '../../context/UserRoleContext';
import { useOfflineSync } from '../../hooks/useOfflineSync';

// Types
type PendingItem = {
    id: string;
    orderRequest: {
        productName: string;
        orderId: string;
        customerId: string;
        reqQty: number;
        primarySupplier?: string;
        secondarySupplier?: string;
    };
    orderedQty: number;
    stockQty: number;
    offerQty: number;
    notes: string;
    orderedSupplier: string;
    decidedSupplier: string;
};

export default function PendingOrdersPage() {
    const { currentUser } = useUserRole();
    const { isOnline } = useOfflineSync();
    const queryClient = useQueryClient();
    const { showToast } = useToast();

    // State
    const [editingId, setEditingId] = useState<string | null>(null);
    const [editFormData, setEditFormData] = useState<Partial<PendingItem>>({});
    const [confirmMoveId, setConfirmMoveId] = useState<string | null>(null);

    // Filter State
    const [filters, setFilters] = useState<Record<string, string>>({});
    const [searchTerm, setSearchTerm] = useState('');

    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';

    const { data: items, isLoading } = useQuery({
        queryKey: ['pending-items'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/pending-items`);
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        },
    });

    const updateMutation = useMutation({
        mutationFn: async (data: { id: string; payload: any }) => {
            const res = await fetch(`${apiUrl}/pending-items/${data.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data.payload),
            });
            if (!res.ok) throw new Error('Update failed');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['pending-items'] });
            setEditingId(null);
            showToast('Order updated successfully', 'success');
        },
        onError: () => {
            showToast('Failed to update order', 'error');
        }
    });

    const moveToRepMutation = useMutation({
        mutationFn: async (id: string) => {
            const res = await fetch(`${apiUrl}/pending-items/${id}/move-to-rep`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userEmail: currentUser?.email || 'unknown@sahakar.com' }),
            });
            if (!res.ok) throw new Error('Move failed');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['pending-items'] });
            setConfirmMoveId(null);
            showToast('Item moved to Rep Allocation', 'success');
        },
        onError: () => {
            showToast('Failed to move item', 'error');
        }
    });

    const handleEditClick = (item: PendingItem) => {
        setEditingId(item.id);
        setEditFormData({
            orderedQty: item.orderedQty,
            stockQty: item.stockQty,
            offerQty: item.offerQty,
            notes: item.notes,
            decidedSupplier: item.decidedSupplier || item.orderedSupplier,
        });
    };

    const handleSave = (id: string) => {
        updateMutation.mutate({ id, payload: editFormData });
    };

    const handleInputChange = (field: string, value: any) => {
        setEditFormData((prev) => ({ ...prev, [field]: value }));
    };

    const filteredItems = useMemo(() => {
        if (!items) return [];
        return items.filter((item: PendingItem) => {
            const searchLower = searchTerm.toLowerCase();
            const matchesSearch =
                item.orderRequest.productName.toLowerCase().includes(searchLower) ||
                item.orderRequest.orderId.toLowerCase().includes(searchLower) ||
                item.orderRequest.customerId.toLowerCase().includes(searchLower);

            if (!matchesSearch) return false;
            if (filters.supplier && item.orderedSupplier !== filters.supplier) return false;

            return true;
        });
    }, [items, searchTerm, filters]);

    const uniqueSuppliers = useMemo(() => {
        if (!items) return [];
        const suppliers = new Set(items.map((i: PendingItem) => i.orderedSupplier).filter(Boolean));
        return Array.from(suppliers).map(s => ({ label: s as string, value: s as string }));
    }, [items]);

    const columns = useMemo<ColumnDef<PendingItem>[]>(() => [
        {
            header: 'Product Details',
            size: 250,
            cell: ({ row }) => {
                const item = row.original;
                return (
                    <div className="flex flex-col">
                        <span className="font-bold text-primary-900 group-hover:text-primary-700 transition-colors uppercase text-[11px] tracking-tight">{item.orderRequest.productName}</span>
                        <span className="text-[10px] text-neutral-400 font-bold uppercase tracking-tighter">{item.orderRequest.primarySupplier}</span>
                    </div>
                );
            }
        },
        {
            header: 'Customer Info',
            size: 150,
            cell: ({ row }) => {
                const item = row.original;
                return (
                    <div className="flex flex-col">
                        <span className="text-[10px] font-bold text-primary-700">{item.orderRequest.customerId}</span>
                        <span className="text-[10px] text-neutral-400 font-bold">{item.orderRequest.orderId}</span>
                    </div>
                );
            }
        },
        {
            header: 'Req',
            accessorKey: 'orderRequest.reqQty',
            size: 60,
            cell: (info) => <span className="tabular-nums font-bold text-neutral-400">{info.getValue() as number}</span>
        },
        {
            header: 'Ordered',
            size: 100,
            cell: ({ row }) => {
                const item = row.original;
                return editingId === item.id ? (
                    <input
                        type="number"
                        className="w-full bg-white border border-primary-500 rounded px-1 py-1 text-xs font-bold tabular-nums focus:ring-2 focus:ring-primary-500/20 outline-none"
                        value={editFormData.orderedQty}
                        onChange={(e) => handleInputChange('orderedQty', parseInt(e.target.value))}
                    />
                ) : <span className="tabular-nums font-bold text-primary-900">{item.orderedQty}</span>;
            }
        },
        {
            header: 'Stock',
            size: 100,
            cell: ({ row }) => {
                const item = row.original;
                return editingId === item.id ? (
                    <input
                        type="number"
                        className="w-full bg-white border border-primary-500 rounded px-1 py-1 text-xs font-bold tabular-nums focus:ring-2 focus:ring-primary-500/20 outline-none"
                        value={editFormData.stockQty}
                        onChange={(e) => handleInputChange('stockQty', parseInt(e.target.value))}
                    />
                ) : <span className="tabular-nums font-bold text-primary-900">{item.stockQty}</span>;
            }
        },
        {
            header: 'Offer',
            size: 100,
            cell: ({ row }) => {
                const item = row.original;
                return editingId === item.id ? (
                    <input
                        type="number"
                        className="w-full bg-white border border-primary-500 rounded px-1 py-1 text-xs font-bold tabular-nums focus:ring-2 focus:ring-primary-500/20 outline-none"
                        value={editFormData.offerQty}
                        onChange={(e) => handleInputChange('offerQty', parseInt(e.target.value))}
                    />
                ) : <span className="tabular-nums font-bold text-primary-900">{item.offerQty}</span>;
            }
        },
        {
            header: 'Actions',
            size: 150,
            cell: ({ row }) => {
                const item = row.original;
                return (
                    <div className="flex items-center gap-3">
                        {editingId === item.id ? (
                            <>
                                <button
                                    onClick={() => handleSave(item.id)}
                                    className="p-1 text-accent-600 hover:bg-accent-100 rounded transition-colors"
                                    title="Save Changes"
                                >
                                    <CheckCircle2 size={18} />
                                </button>
                                <button
                                    onClick={() => setEditingId(null)}
                                    className="p-1 text-error-600 hover:bg-error-100 rounded transition-colors"
                                    title="Cancel"
                                >
                                    <XCircle size={18} />
                                </button>
                            </>
                        ) : (
                            <>
                                <button
                                    onClick={() => handleEditClick(item)}
                                    className="text-neutral-400 hover:text-primary-700 transition-colors"
                                    title="Edit Row"
                                >
                                    <Edit size={18} />
                                </button>
                                <button
                                    onClick={() => setConfirmMoveId(item.id)}
                                    className="text-neutral-400 hover:text-accent-600 transition-colors"
                                    title="Move to Rep"
                                >
                                    <Send size={18} />
                                </button>
                            </>
                        )}
                    </div>
                );
            }
        }
    ], [editingId, editFormData]);

    return (
        <div className="flex flex-col h-full bg-transparent font-sans">
            <header className="mb-10 flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-extrabold text-neutral-900 tracking-tight flex items-center gap-4">
                        <div className="w-12 h-12 bg-white rounded-none shadow-[0_1px_3px_rgba(16_24_40/0.1)] flex items-center justify-center border border-neutral-200/80">
                            <ClipboardList size={28} className="text-brand-600" />
                        </div>
                        Pending PO Ledger
                    </h1>
                    <p className="text-sm text-neutral-400 font-medium mt-2">Awaiting supplier confirmation and inventory mapping for incoming orders.</p>
                </div>
                <div className="flex items-center gap-4">
                    <FilterBar
                        filters={[
                            { key: 'supplier', label: 'Supplier', options: uniqueSuppliers }
                        ]}
                        onFilterChange={(key, val) => setFilters(prev => ({ ...prev, [key]: val }))}
                        onSearch={setSearchTerm}
                        onReset={() => { setFilters({}); setSearchTerm(''); }}
                    />
                </div>
            </header>

            <main className="space-y-4">
                <div className="flex items-center justify-between px-2 mb-1">
                    <div className="flex items-center gap-3">
                        <h2 className="text-sm font-semibold text-neutral-800">Supply Chain Reconciliation</h2>
                        <span className="text-[10px] text-neutral-400 uppercase tracking-widest font-medium">Pending Allocations</span>
                    </div>
                </div>
                <div className="app-card bg-white overflow-hidden">
                    <DataGrid
                        data={filteredItems}
                        columns={columns}
                        isLoading={isLoading}
                        onRowClick={(item) => !editingId && handleEditClick(item)}
                    />
                </div>
            </main>

            <ConfirmModal
                isOpen={!!confirmMoveId}
                onConfirm={() => confirmMoveId && moveToRepMutation.mutate(confirmMoveId)}
                onCancel={() => setConfirmMoveId(null)}
                title="Consolidate & Move to REP"
                message="This will lock the current quantities and move the item to the Representation Allocation stage. Are you sure?"
                confirmLabel="Confirm Move"
                variant="primary"
            />

            {/* Edit Drawer Overlay Placeholder (Actually a modal/overlay in System) */}
            {editingId && (
                <div className="fixed inset-0 bg-neutral-900/40 backdrop-blur-[2px] z-[60] flex items-center justify-center animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-md rounded-none shadow-2xl p-8 animate-in slide-in-from-bottom-4 duration-300">
                        <h3 className="text-xl font-bold text-neutral-900 mb-6 flex items-center gap-2">
                            <Edit size={20} className="text-brand-600" />
                            Update Allocation
                        </h3>

                        <div className="space-y-5">
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1.5">Ordered Quantity</label>
                                <input
                                    type="number"
                                    className="w-full bg-neutral-50 border border-neutral-200 rounded-none px-4 py-3 text-sm font-bold tabular-nums focus:ring-2 focus:ring-brand-500/20 outline-none transition-all"
                                    value={editFormData.orderedQty}
                                    onChange={(e) => handleInputChange('orderedQty', parseInt(e.target.value))}
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1.5">Stock Available</label>
                                <input
                                    type="number"
                                    className="w-full bg-neutral-50 border border-neutral-200 rounded-none px-4 py-3 text-sm font-bold tabular-nums focus:ring-2 focus:ring-brand-500/20 outline-none transition-all"
                                    value={editFormData.stockQty}
                                    onChange={(e) => handleInputChange('stockQty', parseInt(e.target.value))}
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1.5">Special Offer Qty</label>
                                <input
                                    type="number"
                                    className="w-full bg-neutral-50 border border-neutral-200 rounded-none px-4 py-3 text-sm font-bold tabular-nums focus:ring-2 focus:ring-brand-500/20 outline-none transition-all"
                                    value={editFormData.offerQty}
                                    onChange={(e) => handleInputChange('offerQty', parseInt(e.target.value))}
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1.5">Allocator Notes</label>
                                <textarea
                                    className="w-full bg-neutral-50 border border-neutral-200 rounded-none px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-brand-500/20 outline-none transition-all"
                                    rows={3}
                                    value={editFormData.notes}
                                    onChange={(e) => handleInputChange('notes', e.target.value)}
                                    placeholder="Add any internal remarks here..."
                                />
                            </div>
                        </div>

                        <div className="flex gap-4 mt-8">
                            <button
                                onClick={() => handleSave(editingId)}
                                className="flex-1 btn-brand shadow-lg shadow-brand-500/20"
                            >
                                {updateMutation.isPending ? 'Saving...' : 'Save Changes'}
                            </button>
                            <button
                                onClick={() => setEditingId(null)}
                                className="flex-1 px-4 py-3 rounded-none border border-neutral-200 text-sm font-bold text-neutral-500 hover:bg-neutral-50 smooth-transition"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}





================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\products\page.tsx
================================================================================
'use client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useState, useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { ExcelImportButton } from '../../components/ExcelImportButton';
import { Package, Plus, Edit, Trash2 } from 'lucide-react';
import type { ColumnDef } from '@tanstack/react-table';

interface Product {
    id: string;
    legacyId?: string;
    productCode?: string;
    itemName: string;
    packing?: string;
    category?: string;
    subcategory?: string;
    mrp?: number;
    active: boolean;
    createdAt: string;
}

export default function ProductsPage() {
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';
    const queryClient = useQueryClient();
    const [search, setSearch] = useState('');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingProduct, setEditingProduct] = useState<Product | null>(null);
    const [formData, setFormData] = useState({
        legacyId: '',
        productCode: '',
        itemName: '',
        packing: '',
        category: '',
        subcategory: '',
        mrp: ''
    });

    const { data: products, isLoading } = useQuery({
        queryKey: ['products', search],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/products?search=${search}`);
            if (!res.ok) throw new Error('Failed to fetch products');
            return res.json();
        }
    });

    const createMutation = useMutation({
        mutationFn: async (data: any) => {
            const res = await fetch(`${apiUrl}/products`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to create product');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['products'] });
            setIsModalOpen(false);
            resetForm();
        }
    });

    const updateMutation = useMutation({
        mutationFn: async ({ id, data }: { id: string; data: any }) => {
            const res = await fetch(`${apiUrl}/products/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to update product');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['products'] });
            setIsModalOpen(false);
            setEditingProduct(null);
            resetForm();
        }
    });

    const deleteMutation = useMutation({
        mutationFn: async (id: string) => {
            const res = await fetch(`${apiUrl}/products/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete product');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['products'] });
        }
    });

    const handleExcelImport = async (data: any[]) => {
        try {
            let successCount = 0;
            let errorCount = 0;

            for (const row of data) {
                try {
                    await createMutation.mutateAsync({
                        legacyId: row['Legacy ID'] || row['legacyId'],
                        productCode: row['Product Code'] || row['productCode'],
                        itemName: row['Item Name'] || row['itemName'] || row['name'],
                        packing: row['Packing'] || row['packing'],
                        category: row['Category'] || row['category'],
                        subcategory: row['Subcategory'] || row['subcategory'],
                        mrp: row['MRP'] || row['mrp']
                    });
                    successCount++;
                } catch (err) {
                    errorCount++;
                }
            }

            alert(`Import complete: ${successCount} products added, ${errorCount} errors`);
        } catch (error) {
            alert('Error importing products');
        }
    };

    const resetForm = () => {
        setFormData({
            legacyId: '',
            productCode: '',
            itemName: '',
            packing: '',
            category: '',
            subcategory: '',
            mrp: ''
        });
    };

    const handleEdit = (product: Product) => {
        setEditingProduct(product);
        setFormData({
            legacyId: product.legacyId || '',
            productCode: product.productCode || '',
            itemName: product.itemName,
            packing: product.packing || '',
            category: product.category || '',
            subcategory: product.subcategory || '',
            mrp: product.mrp?.toString() || ''
        });
        setIsModalOpen(true);
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        const data = {
            legacyId: formData.legacyId?.toUpperCase() || undefined,
            productCode: formData.productCode?.toUpperCase() || undefined,
            itemName: formData.itemName.toUpperCase(),
            packing: formData.packing?.toUpperCase() || undefined,
            category: formData.category?.toUpperCase() || undefined,
            subcategory: formData.subcategory?.toUpperCase() || undefined,
            mrp: formData.mrp ? parseFloat(formData.mrp) : undefined
        };

        if (editingProduct) {
            updateMutation.mutate({ id: editingProduct.id, data });
        } else {
            createMutation.mutate(data);
        }
    };

    const handleNumericInput = (e: React.ChangeEvent<HTMLInputElement>, field: string) => {
        const value = e.target.value;
        // Allow only numbers and decimal point
        if (value === '' || /^\d*\.?\d*$/.test(value)) {
            setFormData({ ...formData, [field]: value });
        }
    };

    const columns = useMemo<ColumnDef<Product>[]>(() => [
        {
            header: 'Product Code',
            accessorKey: 'productCode',
            size: 100,
            cell: ({ row }) => (
                <span className="text-xs font-bold text-brand-600">{row.original.productCode || '-'}</span>
            )
        },
        {
            header: 'Item Name',
            accessorKey: 'itemName',
            size: 250,
            cell: ({ row }) => (
                <span className="text-xs font-semibold text-neutral-900">{row.original.itemName}</span>
            )
        },
        {
            header: 'Packing',
            accessorKey: 'packing',
            size: 100,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-600">{row.original.packing || '-'}</span>
            )
        },
        {
            header: 'Category',
            accessorKey: 'category',
            size: 120,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-600">{row.original.category || '-'}</span>
            )
        },
        {
            header: 'MRP',
            accessorKey: 'mrp',
            size: 80,
            cell: ({ row }) => (
                <span className="text-xs font-bold text-neutral-900">₹{row.original.mrp?.toFixed(2) || '0.00'}</span>
            )
        },
        {
            header: 'Actions',
            size: 100,
            cell: ({ row }) => (
                <div className="flex gap-2">
                    <button
                        onClick={() => handleEdit(row.original)}
                        className="p-1 text-brand-600 hover:bg-brand-100 transition-colors"
                    >
                        <Edit size={16} />
                    </button>
                    <button
                        onClick={() => {
                            if (confirm('Delete this product?')) {
                                deleteMutation.mutate(row.original.id);
                            }
                        }}
                        className="p-1 text-danger-600 hover:bg-danger-100 transition-colors"
                    >
                        <Trash2 size={16} />
                    </button>
                </div>
            )
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent">
            <header className="mb-6 flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-3">
                        <div className="w-10 h-10 bg-white rounded-none shadow-soft flex items-center justify-center border border-neutral-200/60">
                            <Package size={22} className="text-brand-600" />
                        </div>
                        Products Master
                    </h1>
                    <p className="text-sm text-neutral-500 mt-1">Manage product catalog and inventory items</p>
                </div>
                <div className="flex gap-3">
                    <ExcelImportButton onImport={handleExcelImport} entityType="products" />
                    <button
                        onClick={() => {
                            resetForm();
                            setEditingProduct(null);
                            setIsModalOpen(true);
                        }}
                        className="btn-brand flex items-center gap-2"
                    >
                        <Plus size={18} />
                        Add Product
                    </button>
                </div>
            </header>

            <div className="mb-4">
                <input
                    type="text"
                    placeholder="Search by name, code, or legacy ID..."
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className="w-full px-4 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                />
            </div>

            <div className="app-card overflow-hidden flex-1">
                <DataGrid data={products || []} columns={columns} isLoading={isLoading} />
            </div>

            {isModalOpen && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-none shadow-xl max-w-2xl w-full p-6">
                        <h2 className="text-xl font-bold text-neutral-900 mb-4">
                            {editingProduct ? 'Edit Product' : 'Add New Product'}
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">Legacy ID</label>
                                    <input
                                        type="text"
                                        value={formData.legacyId}
                                        onChange={(e) => setFormData({ ...formData, legacyId: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">Product Code</label>
                                    <input
                                        type="text"
                                        value={formData.productCode}
                                        onChange={(e) => setFormData({ ...formData, productCode: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">Item Name *</label>
                                <input
                                    type="text"
                                    required
                                    value={formData.itemName}
                                    onChange={(e) => setFormData({ ...formData, itemName: e.target.value })}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">Packing</label>
                                    <input
                                        type="text"
                                        value={formData.packing}
                                        onChange={(e) => setFormData({ ...formData, packing: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">MRP (₹)</label>
                                    <input
                                        type="text"
                                        value={formData.mrp}
                                        onChange={(e) => handleNumericInput(e, 'mrp')}
                                        placeholder="0.00"
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">Category</label>
                                    <input
                                        type="text"
                                        value={formData.category}
                                        onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">Subcategory</label>
                                    <input
                                        type="text"
                                        value={formData.subcategory}
                                        onChange={(e) => setFormData({ ...formData, subcategory: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                            </div>
                            <div className="flex gap-3 justify-end mt-6">
                                <button
                                    type="button"
                                    onClick={() => {
                                        setIsModalOpen(false);
                                        setEditingProduct(null);
                                        resetForm();
                                    }}
                                    className="px-4 py-2 text-neutral-700 border border-neutral-300 rounded-none hover:bg-neutral-50"
                                >
                                    Cancel
                                </button>
                                <button type="submit" className="btn-brand">
                                    {editingProduct ? 'Update' : 'Create'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\rep-allocation\page.tsx
================================================================================
'use client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useState, useMemo } from 'react';
import groupBy from 'lodash/groupBy';
import { DataGrid } from '../../components/DataGrid';
import { FilterBar } from '../../components/FilterBar';
import { ConfirmModal } from '../../components/ConfirmModal';
import { StatusBadge } from '../../components/StatusBadge';
import { useToast } from '../../components/Toast';
import { useUserRole } from '../../context/UserRoleContext';
import { UserCircle, Edit, Undo, Info, CheckCircle2, XCircle } from 'lucide-react';
import { ColumnDef } from '@tanstack/react-table';

// Types
type RepItem = {
    id: string;
    orderStatus?: string;
    pendingItem: {
        id: string;
        orderedQty: number;
        stockQty: number;
        offerQty: number;
        notes: string;
        orderRequest: {
            productName: string;
            orderId: string;
            customerId: string;
            reqQty: number;
        }
    }
};

export default function RepAllocationPage() {
    const { currentUser, can } = useUserRole();
    const queryClient = useQueryClient();
    const { showToast } = useToast();

    const [editingId, setEditingId] = useState<string | null>(null);
    const [editFormData, setEditFormData] = useState<any>({});
    const [returnId, setReturnId] = useState<string | null>(null);
    const [searchTerm, setSearchTerm] = useState('');

    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';

    const { data: items, isLoading } = useQuery({
        queryKey: ['rep-items'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/rep-items`);
            if (!res.ok) throw new Error('Failed to fetch');
            return res.json();
        },
    });

    const updateMutation = useMutation({
        mutationFn: async (data: { id: string; payload: any }) => {
            const res = await fetch(`${apiUrl}/rep-items/${data.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data.payload),
            });
            if (!res.ok) throw new Error('Update failed');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['rep-items'] });
            setEditingId(null);
            showToast('Allocation updated successfully', 'success');
        },
        onError: () => showToast('Failed to update allocation', 'error')
    });

    const returnToPendingMutation = useMutation({
        mutationFn: async (id: string) => {
            const res = await fetch(`${apiUrl}/rep-items/${id}/return`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userEmail: currentUser?.email || 'unknown@sahakar.com' }),
            });
            if (!res.ok) throw new Error('Return failed');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['rep-items'] });
            setReturnId(null);
            showToast('Item returned to Pending POs', 'success');
        },
        onError: (err: any) => showToast(err.message, 'error')
    });

    const groupedItems = useMemo(() => {
        if (!items) return {};
        const filtered = items.filter((item: RepItem) => {
            const searchLower = searchTerm.toLowerCase();
            return (
                item.pendingItem.orderRequest.productName.toLowerCase().includes(searchLower) ||
                item.pendingItem.orderRequest.customerId.toLowerCase().includes(searchLower)
            );
        });
        return groupBy(filtered, (item: RepItem) => item.pendingItem.orderRequest.productName);
    }, [items, searchTerm]);

    const handleEditClick = (item: RepItem) => {
        setEditingId(item.id);
        setEditFormData({
            orderedQty: item.pendingItem.orderedQty,
            stockQty: item.pendingItem.stockQty,
            offerQty: item.pendingItem.offerQty,
            notes: item.pendingItem.notes,
        });
    };

    const handleSave = (id: string) => {
        updateMutation.mutate({ id, payload: editFormData });
    };

    const handleInputChange = (field: string, value: any) => {
        setEditFormData((prev: any) => ({ ...prev, [field]: value }));
    };

    const columns = useMemo<ColumnDef<RepItem>[]>(() => [
        {
            header: 'Customer',
            size: 200,
            cell: ({ row }) => {
                const item = row.original;
                return (
                    <div className="flex flex-col">
                        <span className="font-bold text-primary-900 text-[11px] uppercase tracking-tight">{item.pendingItem.orderRequest.customerId}</span>
                        <span className="text-[10px] text-neutral-400 font-bold tracking-widest">{item.pendingItem.orderRequest.orderId}</span>
                    </div>
                );
            }
        },
        {
            header: 'Req',
            size: 60,
            cell: ({ row }) => <span className="tabular-nums font-bold text-neutral-400">{row.original.pendingItem.orderRequest.reqQty}</span>
        },
        {
            header: 'Buy Qty',
            size: 100,
            cell: ({ row }) => {
                const item = row.original;
                return editingId === item.id ? (
                    <input
                        type="number"
                        className="w-full bg-white border border-primary-500 rounded px-1 py-1 text-xs font-bold tabular-nums focus:ring-2 focus:ring-primary-500/20 outline-none"
                        value={editFormData.orderedQty}
                        onChange={(e) => handleInputChange('orderedQty', parseInt(e.target.value))}
                    />
                ) : <span className="tabular-nums font-bold text-primary-700">{item.pendingItem.orderedQty}</span>;
            }
        },
        {
            header: 'Stock',
            size: 100,
            cell: ({ row }) => {
                const item = row.original;
                return editingId === item.id ? (
                    <input
                        type="number"
                        className="w-full bg-white border border-primary-500 rounded px-1 py-1 text-xs font-bold tabular-nums focus:ring-2 focus:ring-primary-500/20 outline-none"
                        value={editFormData.stockQty}
                        onChange={(e) => handleInputChange('stockQty', parseInt(e.target.value))}
                    />
                ) : <span className="tabular-nums font-bold text-primary-900">{item.pendingItem.stockQty}</span>;
            }
        },
        {
            header: 'Actions',
            size: 120,
            cell: ({ row }) => {
                const item = row.original;
                return (
                    <div className="flex items-center gap-3">
                        {editingId === item.id ? (
                            <>
                                <button onClick={() => handleSave(item.id)} className="p-1 text-accent-600 hover:bg-accent-100 rounded transition-colors"><CheckCircle2 size={18} /></button>
                                <button onClick={() => setEditingId(null)} className="p-1 text-error-600 hover:bg-error-100 rounded transition-colors"><XCircle size={18} /></button>
                            </>
                        ) : (
                            <>
                                {can('edit_rep') && (
                                    <button onClick={() => handleEditClick(item)} className="text-neutral-400 hover:text-primary-700 transition-colors" title="Edit Allocation"><Edit size={18} /></button>
                                )}
                                {can('return_to_pending') && (
                                    <button onClick={() => setReturnId(item.id)} className="text-neutral-400 hover:text-error-600 transition-colors" title="Return to Pending"><Undo size={18} /></button>
                                )}
                            </>
                        )}
                    </div>
                );
            }
        }
    ], [editingId, editFormData, can]);

    return (
        <div className="flex flex-col h-full bg-transparent font-sans">
            <header className="mb-10 flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-extrabold text-neutral-900 tracking-tight flex items-center gap-4">
                        <div className="w-12 h-12 bg-white rounded-none shadow-[0_1px_3px_rgba(16_24_40/0.1)] flex items-center justify-center border border-neutral-200/80">
                            <UserCircle size={28} className="text-brand-600" />
                        </div>
                        Representation Allocation
                    </h1>
                    <p className="text-sm text-neutral-400 font-medium mt-2">Final representative validation and stock assignment for fulfillment.</p>
                </div>
                <div className="flex items-center gap-4">
                    <FilterBar
                        filters={[]}
                        onFilterChange={() => { }}
                        onSearch={setSearchTerm}
                        onReset={() => setSearchTerm('')}
                    />
                </div>
            </header>

            <main className="space-y-10">
                {Object.entries(groupedItems).map(([productName, groupItems]: [string, any[]]) => (
                    <section key={productName} className="flex flex-col gap-4">
                        <div className="flex items-center justify-between px-2 mb-1">
                            <div className="flex items-center gap-3">
                                <h2 className="text-sm font-semibold text-neutral-800">{productName}</h2>
                                <span className="text-[10px] text-neutral-400 uppercase tracking-widest font-medium">Product Allocation Group</span>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex flex-col items-end">
                                    <span className="text-[9px] font-bold text-neutral-400 uppercase tracking-widest">Target</span>
                                    <span className="text-xs font-bold text-neutral-900 tabular-nums">
                                        {groupItems.reduce((acc, i) => acc + (i.pendingItem?.orderRequest?.reqQty || 0), 0)}
                                    </span>
                                </div>
                                <div className="w-px h-6 bg-neutral-200" />
                                <div className="flex flex-col items-end">
                                    <span className="text-[9px] font-bold text-brand-500 uppercase tracking-widest">Allocated</span>
                                    <span className="text-xs font-bold text-brand-600 tabular-nums">
                                        {groupItems.reduce((acc, i) => acc + (i.pendingItem?.orderedQty || 0), 0)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div className="app-card overflow-hidden bg-white">
                            <DataGrid
                                data={groupItems}
                                columns={columns}
                            />
                        </div>
                    </section>
                ))}

                {Object.keys(groupedItems).length === 0 && !isLoading && (
                    <div className="app-card bg-white p-20 text-center">
                        <div className="max-w-xs mx-auto">
                            <div className="w-16 h-16 bg-neutral-50 rounded-none flex items-center justify-center mx-auto mb-6">
                                <Info size={32} className="text-neutral-300" />
                            </div>
                            <h3 className="text-base font-bold text-neutral-900">No Allocations Found</h3>
                            <p className="text-xs text-neutral-400 mt-2 font-medium">Try adjusting your search criteria or check the pending orders queue.</p>
                        </div>
                    </div>
                )}
            </main>

            <ConfirmModal
                isOpen={!!returnId}
                onConfirm={() => returnId && returnToPendingMutation.mutate(returnId)}
                onCancel={() => setReturnId(null)}
                title="Rollback to Pending"
                message="This will remove the item from Rep Allocation and return it to the Pending stage for re-verification. Continue?"
                confirmLabel="Confirm Rollback"
                variant="danger"
            />

            {/* Edit Modal same as PendingOrders */}
            {editingId && (
                <div className="fixed inset-0 bg-neutral-900/40 backdrop-blur-[2px] z-[60] flex items-center justify-center animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-md rounded-none shadow-2xl p-8 animate-in slide-in-from-bottom-4 duration-300">
                        <h3 className="text-xl font-bold text-neutral-900 mb-6 flex items-center gap-2">
                            <Edit size={20} className="text-brand-600" />
                            Update Allocation
                        </h3>

                        <div className="space-y-5">
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1.5">Consolidated Buy Qty</label>
                                <input
                                    type="number"
                                    className="w-full bg-neutral-50 border border-neutral-200 rounded-none px-4 py-3 text-sm font-bold tabular-nums focus:ring-2 focus:ring-brand-500/20 outline-none transition-all"
                                    value={editFormData.orderedQty}
                                    onChange={(e) => handleInputChange('orderedQty', parseInt(e.target.value))}
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1.5">Direct Stock</label>
                                <input
                                    type="number"
                                    className="w-full bg-neutral-50 border border-neutral-200 rounded-none px-4 py-3 text-sm font-bold tabular-nums focus:ring-2 focus:ring-brand-500/20 outline-none transition-all"
                                    value={editFormData.stockQty}
                                    onChange={(e) => handleInputChange('stockQty', parseInt(e.target.value))}
                                />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest block mb-1.5">Allocator Notes</label>
                                <textarea
                                    className="w-full bg-neutral-50 border border-neutral-200 rounded-none px-4 py-3 text-sm font-medium focus:ring-2 focus:ring-brand-500/20 outline-none transition-all"
                                    rows={3}
                                    value={editFormData.notes}
                                    onChange={(e) => handleInputChange('notes', e.target.value)}
                                    placeholder="Final remarks for this allocation..."
                                />
                            </div>
                        </div>

                        <div className="flex gap-4 mt-8">
                            <button
                                onClick={() => handleSave(editingId)}
                                className="flex-1 btn-brand shadow-lg shadow-brand-500/20"
                            >
                                {updateMutation.isPending ? 'Saving...' : 'Save Changes'}
                            </button>
                            <button
                                onClick={() => setEditingId(null)}
                                className="flex-1 px-4 py-3 rounded-none border border-neutral-200 text-sm font-bold text-neutral-500 hover:bg-neutral-50 smooth-transition"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}





================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\rep-master\page.tsx
================================================================================
'use client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useState, useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { ExcelImportButton } from '../../components/ExcelImportButton';
import { Users as UsersIcon, Plus, Edit, Trash2 } from 'lucide-react';
import type { ColumnDef } from '@tanstack/react-table';

interface RepMaster {
    id: string;
    name: string;
    mobile?: string;
    email?: string;
    designation?: string;
    active: boolean;
}

export default function RepMasterPage() {
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';
    const queryClient = useQueryClient();
    const [search, setSearch] = useState('');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingRep, setEditingRep] = useState<RepMaster | null>(null);
    const [formData, setFormData] = useState({
        name: '',
        mobile: '',
        email: '',
        designation: ''
    });

    const { data: reps, isLoading } = useQuery({
        queryKey: ['rep-master', search],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/rep-master?search=${search}`);
            if (!res.ok) throw new Error('Failed to fetch REPs');
            return res.json();
        }
    });

    const createMutation = useMutation({
        mutationFn: async (data: any) => {
            const res = await fetch(`${apiUrl}/rep-master`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to create REP');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['rep-master'] });
            setIsModalOpen(false);
            resetForm();
        }
    });

    const updateMutation = useMutation({
        mutationFn: async ({ id, data }: { id: string; data: any }) => {
            const res = await fetch(`${apiUrl}/rep-master/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to update REP');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['rep-master'] });
            setIsModalOpen(false);
            setEditingRep(null);
            resetForm();
        }
    });

    const deleteMutation = useMutation({
        mutationFn: async (id: string) => {
            const res = await fetch(`${apiUrl}/rep-master/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete REP');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['rep-master'] });
        }
    });

    const handleExcelImport = async (data: any[]) => {
        try {
            let successCount = 0;
            let errorCount = 0;

            for (const row of data) {
                try {
                    await createMutation.mutateAsync({
                        name: row['Name'] || row['name'] || row['REP Name'],
                        mobile: row['Mobile'] || row['mobile'] || row['phone'],
                        email: row['Email'] || row['email'],
                        designation: row['Designation'] || row['designation']
                    });
                    successCount++;
                } catch (err) {
                    errorCount++;
                }
            }

            alert(`Import complete: ${successCount} REPs added, ${errorCount} errors`);
        } catch (error) {
            alert('Error importing REPs');
        }
    };

    const resetForm = () => {
        setFormData({ name: '', mobile: '', email: '', designation: '' });
    };

    const handleEdit = (rep: RepMaster) => {
        setEditingRep(rep);
        setFormData({
            name: rep.name,
            mobile: rep.mobile || '',
            email: rep.email || '',
            designation: rep.designation || ''
        });
        setIsModalOpen(true);
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        const data = {
            name: formData.name.toUpperCase(),
            mobile: formData.mobile || undefined,
            email: formData.email || undefined,
            designation: formData.designation?.toUpperCase() || undefined
        };

        if (editingRep) {
            updateMutation.mutate({ id: editingRep.id, data });
        } else {
            createMutation.mutate(data);
        }
    };

    const columns = useMemo<ColumnDef<RepMaster>[]>(() => [
        {
            header: 'Name',
            accessorKey: 'name',
            size: 180,
            cell: ({ row }) => (
                <span className="text-xs font-semibold text-neutral-900">{row.original.name}</span>
            )
        },
        {
            header: 'Designation',
            accessorKey: 'designation',
            size: 140,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-600">{row.original.designation || '-'}</span>
            )
        },
        {
            header: 'Mobile',
            accessorKey: 'mobile',
            size: 120,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-900">{row.original.mobile || '-'}</span>
            )
        },
        {
            header: 'Email',
            accessorKey: 'email',
            size: 200,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-600">{row.original.email || '-'}</span>
            )
        },
        {
            header: 'Actions',
            size: 100,
            cell: ({ row }) => (
                <div className="flex gap-2">
                    <button
                        onClick={() => handleEdit(row.original)}
                        className="p-1 text-brand-600 hover:bg-brand-100 transition-colors"
                    >
                        <Edit size={16} />
                    </button>
                    <button
                        onClick={() => {
                            if (confirm('Delete this REP?')) {
                                deleteMutation.mutate(row.original.id);
                            }
                        }}
                        className="p-1 text-danger-600 hover:bg-danger-100 transition-colors"
                    >
                        <Trash2 size={16} />
                    </button>
                </div>
            )
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent">
            <header className="mb-6 flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-3">
                        <div className="w-10 h-10 bg-white rounded-none shadow-soft flex items-center justify-center border border-neutral-200/60">
                            <UsersIcon size={22} className="text-brand-600" />
                        </div>
                        REP Master
                    </h1>
                    <p className="text-sm text-neutral-500 mt-1">Manage sales representatives and field staff</p>
                </div>
                <div className="flex gap-3">
                    <ExcelImportButton onImport={handleExcelImport} entityType="rep-master" />
                    <button
                        onClick={() => {
                            resetForm();
                            setEditingRep(null);
                            setIsModalOpen(true);
                        }}
                        className="btn-brand flex items-center gap-2"
                    >
                        <Plus size={18} />
                        Add REP
                    </button>
                </div>
            </header>

            <div className="mb-4">
                <input
                    type="text"
                    placeholder="Search by name, mobile, or designation..."
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className="w-full px-4 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                />
            </div>

            <div className="app-card overflow-hidden flex-1">
                <DataGrid data={reps || []} columns={columns} isLoading={isLoading} />
            </div>

            {isModalOpen && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-none shadow-xl max-w-lg w-full p-6">
                        <h2 className="text-xl font-bold text-neutral-900 mb-4">
                            {editingRep ? 'Edit REP' : 'Add New REP'}
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">Name *</label>
                                <input
                                    type="text"
                                    required
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">Designation</label>
                                <input
                                    type="text"
                                    value={formData.designation}
                                    onChange={(e) => setFormData({ ...formData, designation: e.target.value })}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">Mobile</label>
                                <input
                                    type="tel"
                                    value={formData.mobile}
                                    onChange={(e) => setFormData({ ...formData, mobile: e.target.value })}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">Email</label>
                                <input
                                    type="email"
                                    value={formData.email}
                                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                />
                            </div>
                            <div className="flex gap-3 justify-end mt-6">
                                <button
                                    type="button"
                                    onClick={() => {
                                        setIsModalOpen(false);
                                        setEditingRep(null);
                                        resetForm();
                                    }}
                                    className="px-4 py-2 text-neutral-700 border border-neutral-300 rounded-none hover:bg-neutral-50"
                                >
                                    Cancel
                                </button>
                                <button type="submit" className="btn-brand">
                                    {editingRep ? 'Update' : 'Create'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\settings\page.tsx
================================================================================
'use client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useState, useEffect } from 'react';
import { Settings as SettingsIcon, Save } from 'lucide-react';

interface AppSettings {
    dateFormat: string;
    currency: string;
    timezone: string;
    autoBackup: boolean;
    notificationsEnabled: boolean;
}

export default function SettingsPage() {
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';
    const queryClient = useQueryClient();
    const [settings, setSettings] = useState<AppSettings>({
        dateFormat: 'DD/MM/YYYY',
        currency: 'INR',
        timezone: 'Asia/Kolkata',
        autoBackup: true,
        notificationsEnabled: true
    });

    const { data: serverSettings } = useQuery({
        queryKey: ['settings'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/settings`);
            if (!res.ok) throw new Error('Failed to fetch settings');
            return res.json();
        }
    });

    useEffect(() => {
        if (serverSettings) {
            setSettings(serverSettings);
        }
    }, [serverSettings]);

    const saveMutation = useMutation({
        mutationFn: async (data: Partial<AppSettings>) => {
            const res = await fetch(`${apiUrl}/settings`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to save settings');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['settings'] });
            alert('Settings saved successfully!');
        }
    });

    const handleSave = () => {
        saveMutation.mutate(settings);
    };

    return (
        <div className="flex flex-col h-full bg-transparent">
            <header className="mb-6 flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-3">
                        <div className="w-10 h-10 bg-white shadow-soft flex items-center justify-center border border-neutral-200/60">
                            <SettingsIcon size={22} className="text-brand-600" />
                        </div>
                        System Settings
                    </h1>
                    <p className="text-sm text-neutral-500 mt-1">Configure application preferences</p>
                </div>
                <button onClick={handleSave} disabled={saveMutation.isPending} className="btn-brand flex items-center gap-2">
                    <Save size={18} />
                    {saveMutation.isPending ? 'Saving...' : 'Save Changes'}
                </button>
            </header>

            <div className="app-card p-6">
                <div className="space-y-6">
                    <div>
                        <label className="block text-sm font-medium text-neutral-700 mb-2">Date Format</label>
                        <select
                            value={settings.dateFormat}
                            onChange={(e) => setSettings({ ...settings, dateFormat: e.target.value })}
                            className="w-full px-3 py-2 border border-neutral-300 focus:ring-2 focus:ring-brand-500"
                        >
                            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                        </select>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-neutral-700 mb-2">Currency</label>
                        <select
                            value={settings.currency}
                            onChange={(e) => setSettings({ ...settings, currency: e.target.value })}
                            className="w-full px-3 py-2 border border-neutral-300 focus:ring-2 focus:ring-brand-500"
                        >
                            <option value="INR">INR (₹)</option>
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                        </select>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-neutral-700 mb-2">Timezone</label>
                        <select
                            value={settings.timezone}
                            onChange={(e) => setSettings({ ...settings, timezone: e.target.value })}
                            className="w-full px-3 py-2 border border-neutral-300 focus:ring-2 focus:ring-brand-500"
                        >
                            <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
                            <option value="UTC">UTC</option>
                            <option value="America/New_York">America/New_York (EST)</option>
                        </select>
                    </div>

                    <div className="border-t pt-4">
                        <h3 className="text-sm font-semibold text-neutral-900 mb-3">Preferences</h3>

                        <div className="flex items-center justify-between mb-3">
                            <label className="text-sm text-neutral-700">Auto Backup</label>
                            <input
                                type="checkbox"
                                checked={settings.autoBackup}
                                onChange={(e) => setSettings({ ...settings, autoBackup: e.target.checked })}
                                className="w-5 h-5"
                            />
                        </div>

                        <div className="flex items-center justify-between">
                            <label className="text-sm text-neutral-700">Enable Notifications</label>
                            <input
                                type="checkbox"
                                checked={settings.notificationsEnabled}
                                onChange={(e) => setSettings({ ...settings, notificationsEnabled: e.target.checked })}
                                className="w-5 h-5"
                            />
                        </div>
                    </div>

                    <div className="bg-success-50 p-4 border border-success-200">
                        <p className="text-xs text-success-800">
                            <strong>✅ Persistent Storage:</strong> Settings are now saved to the backend API. Changes will be preserved across sessions.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\suppliers\page.tsx
================================================================================
'use client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useState, useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { ExcelImportButton } from '../../components/ExcelImportButton';
import { Store, Plus, Edit, Trash2 } from 'lucide-react';
import type { ColumnDef } from '@tanstack/react-table';

interface Supplier {
    id: string;
    supplierCode?: string;
    supplierName: string;
    contactPerson?: string;
    mobile?: string;
    email?: string;
    gstNumber?: string;
    address?: string;
    creditDays?: number;
    active: boolean;
}

export default function SuppliersPage() {
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';
    const queryClient = useQueryClient();
    const [search, setSearch] = useState('');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingSupplier, setEditingSupplier] = useState<Supplier | null>(null);
    const [formData, setFormData] = useState({
        supplierCode: '',
        supplierName: '',
        contactPerson: '',
        mobile: '',
        email: '',
        gstNumber: '',
        address: '',
        creditDays: ''
    });

    const { data: suppliers, isLoading } = useQuery({
        queryKey: ['suppliers', search],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/suppliers?search=${search}`);
            if (!res.ok) throw new Error('Failed to fetch suppliers');
            return res.json();
        }
    });

    const createMutation = useMutation({
        mutationFn: async (data: any) => {
            const res = await fetch(`${apiUrl}/suppliers`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to create supplier');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['suppliers'] });
            setIsModalOpen(false);
            resetForm();
        }
    });

    const updateMutation = useMutation({
        mutationFn: async ({ id, data }: { id: string; data: any }) => {
            const res = await fetch(`${apiUrl}/suppliers/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to update supplier');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['suppliers'] });
            setIsModalOpen(false);
            setEditingSupplier(null);
            resetForm();
        }
    });

    const deleteMutation = useMutation({
        mutationFn: async (id: string) => {
            const res = await fetch(`${apiUrl}/suppliers/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Failed to delete supplier');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['suppliers'] });
        }
    });

    const handleExcelImport = async (data: any[]) => {
        try {
            let successCount = 0;
            let errorCount = 0;

            for (const row of data) {
                try {
                    await createMutation.mutateAsync({
                        supplierCode: row['Supplier Code'] || row['supplierCode'],
                        supplierName: row['Supplier Name'] || row['supplierName'] || row['name'],
                        contactPerson: row['Contact Person'] || row['contactPerson'],
                        mobile: row['Mobile'] || row['mobile'] || row['phone'],
                        email: row['Email'] || row['email'],
                        gstNumber: row['GST Number'] || row['gstNumber'] || row['gst'],
                        address: row['Address'] || row['address'],
                        creditDays: row['Credit Days'] || row['creditDays']
                    });
                    successCount++;
                } catch (err) {
                    errorCount++;
                }
            }

            alert(`Import complete: ${successCount} suppliers added, ${errorCount} errors`);
        } catch (error) {
            alert('Error importing suppliers');
        }
    };

    const resetForm = () => {
        setFormData({
            supplierCode: '',
            supplierName: '',
            contactPerson: '',
            mobile: '',
            email: '',
            gstNumber: '',
            address: '',
            creditDays: ''
        });
    };

    const handleEdit = (supplier: Supplier) => {
        setEditingSupplier(supplier);
        setFormData({
            supplierCode: supplier.supplierCode || '',
            supplierName: supplier.supplierName,
            contactPerson: supplier.contactPerson || '',
            mobile: supplier.mobile || '',
            email: supplier.email || '',
            gstNumber: supplier.gstNumber || '',
            address: supplier.address || '',
            creditDays: supplier.creditDays?.toString() || ''
        });
        setIsModalOpen(true);
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        const data = {
            supplierCode: formData.supplierCode?.toUpperCase() || undefined,
            supplierName: formData.supplierName.toUpperCase(),
            contactPerson: formData.contactPerson?.toUpperCase() || undefined,
            mobile: formData.mobile || undefined,
            email: formData.email || undefined,
            gstNumber: formData.gstNumber?.toUpperCase() || undefined,
            address: formData.address?.toUpperCase() || undefined,
            creditDays: formData.creditDays ? parseInt(formData.creditDays) : undefined
        };

        if (editingSupplier) {
            updateMutation.mutate({ id: editingSupplier.id, data });
        } else {
            createMutation.mutate(data);
        }
    };

    const handleNumericInput = (e: React.ChangeEvent<HTMLInputElement>) => {
        const value = e.target.value;
        // Allow only integers
        if (value === '' || /^\d+$/.test(value)) {
            setFormData({ ...formData, creditDays: value });
        }
    };

    const columns = useMemo<ColumnDef<Supplier>[]>(() => [
        {
            header: 'Code',
            accessorKey: 'supplierCode',
            size: 80,
            cell: ({ row }) => (
                <span className="text-xs font-bold text-brand-600">{row.original.supplierCode || '-'}</span>
            )
        },
        {
            header: 'Supplier Name',
            accessorKey: 'supplierName',
            size: 200,
            cell: ({ row }) => (
                <span className="text-xs font-semibold text-neutral-900">{row.original.supplierName}</span>
            )
        },
        {
            header: 'Contact',
            accessorKey: 'contactPerson',
            size: 120,
            cell: ({ row }) => (
                <div className="flex flex-col">
                    <span className="text-xs text-neutral-900">{row.original.contactPerson || '-'}</span>
                    <span className="text-[10px] text-neutral-500">{row.original.mobile}</span>
                </div>
            )
        },
        {
            header: 'GST',
            accessorKey: 'gstNumber',
            size: 120,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-600">{row.original.gstNumber || '-'}</span>
            )
        },
        {
            header: 'Credit Days',
            accessorKey: 'creditDays',
            size: 80,
            cell: ({ row }) => (
                <span className="text-xs font-bold text-neutral-900">{row.original.creditDays || 0}</span>
            )
        },
        {
            header: 'Actions',
            size: 100,
            cell: ({ row }) => (
                <div className="flex gap-2">
                    <button
                        onClick={() => handleEdit(row.original)}
                        className="p-1 text-brand-600 hover:bg-brand-100 transition-colors"
                    >
                        <Edit size={16} />
                    </button>
                    <button
                        onClick={() => {
                            if (confirm('Delete this supplier?')) {
                                deleteMutation.mutate(row.original.id);
                            }
                        }}
                        className="p-1 text-danger-600 hover:bg-danger-100 transition-colors"
                    >
                        <Trash2 size={16} />
                    </button>
                </div>
            )
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent">
            <header className="mb-6 flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-3">
                        <div className="w-10 h-10 bg-white rounded-none shadow-soft flex items-center justify-center border border-neutral-200/60">
                            <Store size={22} className="text-brand-600" />
                        </div>
                        Suppliers Master
                    </h1>
                    <p className="text-sm text-neutral-500 mt-1">Manage supplier database and contacts</p>
                </div>
                <div className="flex gap-3">
                    <ExcelImportButton onImport={handleExcelImport} entityType="suppliers" />
                    <button
                        onClick={() => {
                            resetForm();
                            setEditingSupplier(null);
                            setIsModalOpen(true);
                        }}
                        className="btn-brand flex items-center gap-2"
                    >
                        <Plus size={18} />
                        Add Supplier
                    </button>
                </div>
            </header>

            <div className="mb-4">
                <input
                    type="text"
                    placeholder="Search by name, code, or contact..."
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className="w-full px-4 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                />
            </div>

            <div className="app-card overflow-hidden flex-1">
                <DataGrid data={suppliers || []} columns={columns} isLoading={isLoading} />
            </div>

            {isModalOpen && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-none shadow-xl max-w-2xl w-full p-6">
                        <h2 className="text-xl font-bold text-neutral-900 mb-4">
                            {editingSupplier ? 'Edit Supplier' : 'Add New Supplier'}
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">Supplier Code</label>
                                    <input
                                        type="text"
                                        value={formData.supplierCode}
                                        onChange={(e) => setFormData({ ...formData, supplierCode: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">Supplier Name *</label>
                                    <input
                                        type="text"
                                        required
                                        value={formData.supplierName}
                                        onChange={(e) => setFormData({ ...formData, supplierName: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">Contact Person</label>
                                    <input
                                        type="text"
                                        value={formData.contactPerson}
                                        onChange={(e) => setFormData({ ...formData, contactPerson: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">Mobile</label>
                                    <input
                                        type="tel"
                                        value={formData.mobile}
                                        onChange={(e) => setFormData({ ...formData, mobile: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">Email</label>
                                    <input
                                        type="email"
                                        value={formData.email}
                                        onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 mb-1">GST Number</label>
                                    <input
                                        type="text"
                                        value={formData.gstNumber}
                                        onChange={(e) => setFormData({ ...formData, gstNumber: e.target.value })}
                                        className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">Address</label>
                                <textarea
                                    value={formData.address}
                                    onChange={(e) => setFormData({ ...formData, address: e.target.value })}
                                    rows={2}
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">Credit Days</label>
                                <input
                                    type="text"
                                    value={formData.creditDays}
                                    onChange={handleNumericInput}
                                    placeholder="0"
                                    className="w-full px-3 py-2 border border-neutral-300 rounded-none focus:ring-2 focus:ring-brand-500"
                                />
                            </div>
                            <div className="flex gap-3 justify-end mt-6">
                                <button
                                    type="button"
                                    onClick={() => {
                                        setIsModalOpen(false);
                                        setEditingSupplier(null);
                                        resetForm();
                                    }}
                                    className="px-4 py-2 text-neutral-700 border border-neutral-300 rounded-none hover:bg-neutral-50"
                                >
                                    Cancel
                                </button>
                                <button type="submit" className="btn-brand">
                                    {editingSupplier ? 'Update' : 'Create'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\users\page.tsx
================================================================================
'use client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useState, useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { Users, Edit, Shield } from 'lucide-react';
import type { ColumnDef } from '@tanstack/react-table';
import { RoleBadge } from '../../components/RoleBadge';

interface User {
    id: string;
    email: string;
    name: string;
    role: string;
    active: boolean;
}

export default function UsersPage() {
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';
    const queryClient = useQueryClient();
    const [search, setSearch] = useState('');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingUser, setEditingUser] = useState<User | null>(null);
    const [formData, setFormData] = useState({ name: '', role: '', active: true });

    const { data: users, isLoading } = useQuery({
        queryKey: ['users', search],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/users?search=${search}`);
            if (!res.ok) throw new Error('Failed to fetch users');
            return res.json();
        }
    });

    const updateMutation = useMutation({
        mutationFn: async ({ id, data }: { id: string; data: any }) => {
            const res = await fetch(`${apiUrl}/users/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to update user');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['users'] });
            setIsModalOpen(false);
            setEditingUser(null);
        }
    });

    const handleEdit = (user: User) => {
        setEditingUser(user);
        setFormData({ name: user.name, role: user.role, active: user.active });
        setIsModalOpen(true);
    };

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        if (editingUser) {
            updateMutation.mutate({ id: editingUser.id, data: formData });
        }
    };

    const columns = useMemo<ColumnDef<User>[]>(() => [
        {
            header: 'Email',
            accessorKey: 'email',
            size: 220,
            cell: ({ row }) => (
                <span className="text-xs font-semibold text-neutral-900">{row.original.email}</span>
            )
        },
        {
            header: 'Name',
            accessorKey: 'name',
            size: 180,
            cell: ({ row }) => (
                <span className="text-xs text-neutral-900">{row.original.name}</span>
            )
        },
        {
            header: 'Role',
            accessorKey: 'role',
            size: 160,
            cell: ({ row }) => <RoleBadge role={row.original.role} />
        },
        {
            header: 'Status',
            accessorKey: 'active',
            size: 100,
            cell: ({ row }) => (
                <span className={`text-xs font-bold ${row.original.active ? 'text-success-600' : 'text-neutral-400'}`}>
                    {row.original.active ? 'Active' : 'Inactive'}
                </span>
            )
        },
        {
            header: 'Actions',
            size: 80,
            cell: ({ row }) => (
                <button
                    onClick={() => handleEdit(row.original)}
                    className="p-1 text-brand-600 hover:bg-brand-100"
                >
                    <Edit size={16} />
                </button>
            )
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent">
            <header className="mb-6 flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-bold text-neutral-900 flex items-center gap-3">
                        <div className="w-10 h-10 bg-white shadow-soft flex items-center justify-center border border-neutral-200/60">
                            <Users size={22} className="text-brand-600" />
                        </div>
                        User Management
                    </h1>
                    <p className="text-sm text-neutral-500 mt-1">Manage user accounts and permissions</p>
                </div>
            </header>

            <div className="mb-4">
                <input
                    type="text"
                    placeholder="Search by name or email..."
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className="w-full px-4 py-2 border border-neutral-300 focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                />
            </div>

            <div className="app-card overflow-hidden flex-1">
                <DataGrid data={users || []} columns={columns} isLoading={isLoading} />
            </div>

            {isModalOpen && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white shadow-xl max-w-lg w-full p-6">
                        <h2 className="text-xl font-bold text-neutral-900 mb-4">
                            Edit User: {editingUser?.email}
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">Name</label>
                                <input
                                    type="text"
                                    value={formData.name}
                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                    className="w-full px-3 py-2 border border-neutral-300 focus:ring-2 focus:ring-brand-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-neutral-700 mb-1">Role</label>
                                <select
                                    value={formData.role}
                                    onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                                    className="w-full px-3 py-2 border border-neutral-300 focus:ring-2 focus:ring-brand-500"
                                >
                                    <option value="SUPER_ADMIN">Super Admin</option>
                                    <option value="ADMIN">Admin</option>
                                    <option value="PROCUREMENT_HEAD">Procurement Head</option>
                                    <option value="PURCHASE_STAFF">Purchase Staff</option>
                                    <option value="BILLING_HEAD">Billing Head</option>
                                    <option value="BILLING_STAFF">Billing Staff</option>
                                </select>
                            </div>
                            <div className="flex items-center gap-2">
                                <input
                                    type="checkbox"
                                    checked={formData.active}
                                    onChange={(e) => setFormData({ ...formData, active: e.target.checked })}
                                    className="w-4 h-4"
                                />
                                <label className="text-sm font-medium text-neutral-700">Active</label>
                            </div>
                            <div className="flex gap-3 justify-end mt-6">
                                <button
                                    type="button"
                                    onClick={() => {
                                        setIsModalOpen(false);
                                        setEditingUser(null);
                                    }}
                                    className="px-4 py-2 text-neutral-700 border border-neutral-300 hover:bg-neutral-50"
                                >
                                    Cancel
                                </button>
                                <button type="submit" className="btn-brand">
                                    Update
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\warehouse\[id]\page.tsx
================================================================================



================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\warehouse\page.tsx
================================================================================
'use client';
import { useQuery } from '@tanstack/react-query';
import Link from 'next/link';
import { useMemo } from 'react';
import { DataGrid } from '../../components/DataGrid';
import { Box, Info, FileSearch } from 'lucide-react';
import { ColumnDef } from '@tanstack/react-table';

export default function WarehouseSlipsPage() {
    const { data: slips, isLoading } = useQuery({
        queryKey: ['order-slips'],
        queryFn: async () => {
            const res = await fetch('http://localhost:8080/order-slips');
            if (!res.ok) throw new Error('Failed to fetch warehouse slips');
            return res.json();
        },
    });

    const columns = useMemo<ColumnDef<any>[]>(() => [
        {
            header: 'Dispatch Ref',
            size: 150,
            cell: ({ row }) => (
                <div className="flex flex-col">
                    <span className="font-mono text-[10px] text-indigo-600 font-bold tracking-tight">#{row.original.id.substring(0, 8).toUpperCase()}</span>
                    <span className="text-[9px] text-gray-400 font-medium uppercase tracking-tighter">Inbound Slip</span>
                </div>
            )
        },
        {
            header: 'Courier/Supplier',
            accessorKey: 'supplier',
            size: 250,
            cell: (info) => <span className="font-bold text-gray-900 group-hover:text-indigo-600 transition-colors uppercase text-[11px] tracking-tight">{info.getValue() as string}</span>
        },
        {
            header: 'Timestamp',
            size: 120,
            cell: ({ row }) => (
                <span className="tabular-nums text-xs font-medium text-gray-600">
                    {new Date(row.original.slipDate).toLocaleDateString(undefined, { day: '2-digit', month: 'short' })}
                </span>
            )
        },
        {
            header: 'SKU Count',
            size: 100,
            cell: ({ row }) => (
                <div className="flex items-center gap-2">
                    <span className="tabular-nums font-bold text-gray-900">{row.original._count?.items || 0}</span>
                </div>
            )
        },
        {
            header: 'Actions',
            size: 150,
            cell: ({ row }) => (
                <Link
                    href={`/warehouse/${row.original.id}`}
                    className="inline-flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-none text-[10px] font-bold uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-sm"
                >
                    <Box className="w-3.5 h-3.5" /> Start Receiving
                </Link>
            )
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-[var(--background)]">
            <header className="bg-white border-b border-[var(--border)] px-8 py-5 sticky top-0 z-10">
                <div className="flex items-center justify-between">
                    <div>
                        <h1 className="text-xl font-bold text-gray-900 tracking-tight flex items-center gap-2 uppercase">
                            <Box className="w-6 h-6 text-indigo-600" />
                            Warehouse Receiving Deck
                        </h1>
                        <p className="text-[10px] text-gray-400 font-bold mt-1 uppercase tracking-widest">Inbound Logistics & Goods Reconciliation</p>
                    </div>
                </div>
            </header>

            <main className="flex-1 p-8 overflow-auto">
                <div className="bg-white rounded-none border border-[var(--border)] shadow-sm overflow-hidden">
                    <DataGrid
                        data={slips || []}
                        columns={columns}
                        isLoading={isLoading}
                    />
                </div>

                {!isLoading && slips?.length === 0 && (
                    <div className="mt-8 bg-gray-50 border border-dashed border-gray-200 rounded-none p-16 text-center">
                        <Info className="w-10 h-10 text-gray-200 mx-auto mb-3" />
                        <h3 className="text-sm font-bold text-gray-400 uppercase tracking-widest">No Incoming Consignments</h3>
                        <p className="text-xs text-gray-400 mt-1 italic font-medium">Generate order slips to initialize warehouse inbound data.</p>
                    </div>
                )}
            </main>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\globals.css
================================================================================
@import "tailwindcss";

@theme {
    /* System Palette (Vibrant & Modern) */
    --color-brand-950: #0F091F;
    --color-brand-900: #1E1B4B;
    --color-brand-800: #3730A3;
    --color-brand-700: #4338CA;
    --color-brand-600: #4F46E5;
    --color-brand-500: #6366F1;
    --color-brand-200: #C7D2FE;
    --color-brand-100: #E0E7FF;
    --color-brand-50: #EEF2FF;

    --color-success-600: #059669;
    --color-success-500: #10B981;
    --color-success-200: #A7F3D0;
    --color-success-100: #D1FAE5;
    --color-success-50: #ECFDF5;

    --color-warning-600: #D97706;
    --color-warning-500: #F59E0B;
    --color-warning-200: #FCD34D;
    --color-warning-100: #FEF3C7;
    --color-warning-50: #FFFBEB;

    --color-danger-600: #E11D48;
    --color-danger-500: #F43F5E;
    --color-danger-200: #FECDD3;
    --color-danger-100: #FFE4E6;
    --color-danger-50: #FFF1F2;

    --color-neutral-50: #F9FAFB;
    --color-neutral-100: #F3F4F6;
    --color-neutral-200: #E5E7EB;
    --color-neutral-400: #9CA3AF;
    --color-neutral-700: #374151;
    --color-neutral-900: #111827;

    --color-background: #F9FAFB;
    --color-surface: #FFFFFF;
    --color-border: #E5E7EB;

    /* Geometry */
    --radius-xl: 0.75rem;
    --radius-2xl: 1rem;
    --radius-3xl: 1.5rem;

    /* Shadows */
    --shadow-soft: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
    --shadow-hover: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

    /* Fonts */
    --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
}

@layer base {
    body {
        @apply antialiased bg-neutral-50 text-neutral-900;
        font-family: var(--font-sans);
        background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.03) 0px, transparent 50%),
            radial-gradient(at 100% 0%, rgba(16, 185, 129, 0.02) 0px, transparent 50%);
    }

    h1,
    h2,
    h3,
    h4 {
        @apply tracking-tight font-bold text-neutral-900;
    }
}

@layer components {
    .btn-brand {
        @apply px-5 py-2.5 bg-brand-600 text-white font-semibold uppercase tracking-wide text-xs hover:bg-brand-700 active:bg-brand-800 transition-all duration-300 ease-in-out shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed rounded-sm;
    }

    .btn-secondary {
        @apply px-5 py-2.5 bg-neutral-200 text-neutral-900 font-semibold uppercase tracking-wide text-xs hover:bg-neutral-300 active:bg-neutral-400 transition-all duration-300 ease-in-out shadow-sm disabled:opacity-50 disabled:cursor-not-allowed rounded-sm;
    }

    .app-card {
        @apply bg-white border border-neutral-200 shadow-soft;
    }

    .glass-card {
        @apply bg-white/80 backdrop-blur-xl border border-white/40 shadow-xl;
    }

    .glass-badge {
        @apply px-2.5 py-0.5 rounded-full text-[10px] font-bold tracking-wider uppercase border;
    }
}

@layer utilities {
    .smooth-transition {
        @apply transition-all duration-300 ease-in-out;
    }
}



================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\layout.tsx
================================================================================
import type { Metadata, Viewport } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import Providers from './providers';
import { AppShell } from '../components/AppShell';
import { UserRoleProvider } from '../context/UserRoleContext';
import { ToastProvider } from '../components/Toast';

const inter = Inter({
    subsets: ['latin'],
    display: 'swap',
    variable: '--font-inter'
});

// Next.js 16+ requires viewport config in separate export
export const viewport: Viewport = {
    width: 'device-width',
    initialScale: 1,
    maximumScale: 5,
    userScalable: true,
    viewportFit: 'cover',
    themeColor: '#4f46e5'
};

export const metadata: Metadata = {
    title: 'Sahakar PPO - Procurement Order Processing',
    description: 'Enterprise Procurement Order Processing System',
    manifest: '/manifest.json',
    appleWebApp: {
        capable: true,
        statusBarStyle: 'default',
        title: 'Sahakar PPO'
    },
    formatDetection: {
        telephone: false
    }
};

export default function RootLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <html lang="en">
            <body className={inter.className}>
                <Providers>
                    <UserRoleProvider>
                        <ToastProvider>
                            <AppShell>
                                {children}
                            </AppShell>
                        </ToastProvider>
                    </UserRoleProvider>
                </Providers>
            </body>
        </html>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\page.tsx
================================================================================
'use client';
import { useQuery } from '@tanstack/react-query';
import { useMemo } from 'react';
import { DataGrid } from '../components/DataGrid';
import { StatusBadge } from '../components/StatusBadge';
import { RoleBadge } from '../components/RoleBadge';
import { useUserRole } from '../context/UserRoleContext';
import {
    TrendingUp,
    Archive,
    CheckCircle,
    DatabaseZap,
    BarChart3,
    Timer,
    Activity
} from 'lucide-react';
import { ColumnDef } from '@tanstack/react-table';

export default function DashboardPage() {
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';

    const { data: stats, isLoading: statsLoading } = useQuery({
        queryKey: ['dashboard-stats'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/analysis/stats`);
            if (!res.ok) throw new Error('Failed to fetch stats');
            return res.json();
        }
    });

    const { role } = useUserRole();

    const { data: ledger, isLoading: ledgerLoading } = useQuery({
        queryKey: ['dashboard-ledger'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/analysis/ledger?limit=10`);
            if (!res.ok) throw new Error('Failed to fetch ledger');
            return res.json();
        }
    });

    const { data: gap, isLoading: gapLoading } = useQuery({
        queryKey: ['dashboard-gap'],
        queryFn: async () => {
            const res = await fetch(`${apiUrl}/analysis/gap`);
            if (!res.ok) throw new Error('Failed to fetch gap analysis');
            return res.json();
        }
    });

    const ledgerColumns = useMemo<ColumnDef<any>[]>(() => [
        {
            header: 'Timestamp',
            size: 140,
            cell: ({ row }) => (
                <span className="tabular-nums text-[10px] font-bold text-neutral-400 uppercase tracking-tighter">
                    {new Date(row.original.eventDatetime).toLocaleString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                </span>
            )
        },
        {
            header: 'Item Detail',
            size: 200,
            cell: ({ row }) => (
                <div className="flex flex-col">
                    <span className="text-[10px] font-bold text-neutral-900 uppercase truncate max-w-[180px]">{row.original.itemNew}</span>
                    <span className="text-[9px] text-neutral-400 font-bold uppercase tracking-tighter">{row.original.supplier}</span>
                </div>
            )
        },
        {
            header: 'Status Evolution',
            size: 150,
            cell: ({ row }) => (
                <div className="flex items-center gap-2">
                    <StatusBadge status={row.original.status} className="scale-90 origin-left" />
                </div>
            )
        },
        {
            header: 'Owner',
            size: 100,
            cell: ({ row }) => <span className="text-[10px] font-bold text-brand-600 uppercase tracking-tighter">{row.original.staff?.split('@')[0]}</span>
        }
    ], []);

    const gapColumns = useMemo<ColumnDef<any>[]>(() => [
        {
            header: 'Critical Item',
            size: 200,
            cell: ({ row }) => (
                <span className="font-bold text-[10px] text-neutral-900 uppercase truncate block">{row.original.itemName}</span>
            )
        },
        {
            header: 'Variance',
            size: 120,
            cell: ({ row }) => {
                const item = row.original;
                const isUnder = item.qtyReceived < item.qty;
                return (
                    <div className="flex items-center gap-1.5 tabular-nums">
                        <span className="text-[10px] font-bold text-neutral-400">{item.qty}</span>
                        <TrendingUp className="w-3 h-3 text-neutral-300" />
                        <span className={`text-[11px] font-bold ${isUnder ? 'text-danger-500' : 'text-success-600'}`}>
                            {item.qtyReceived || 0}
                        </span>
                    </div>
                );
            }
        },
        {
            header: 'State',
            size: 120,
            cell: ({ row }) => <StatusBadge status={row.original.status} className="scale-90 origin-left" />
        }
    ], []);

    return (
        <div className="flex flex-col h-full bg-transparent font-sans">
            <header className="mb-10 flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-extrabold text-neutral-900 tracking-tight flex items-center gap-4">
                        <div className="w-12 h-12 bg-white rounded-none shadow-soft flex items-center justify-center border border-neutral-200/60">
                            <Activity size={28} className="text-brand-600" />
                        </div>
                        Operations Command Center
                    </h1>
                    <p className="text-sm text-neutral-400 font-medium mt-2">Real-time supply chain intelligence and inventory reconciliation.</p>
                </div>
                <div className="flex items-center gap-3">
                    <span className="
                        text-[10px] 
                        font-bold 
                        uppercase 
                        tracking-widest
                        px-3 py-1
                        rounded-full
                        bg-success-50
                        text-success-700
                        border border-success-100
                        flex items-center gap-2
                    ">
                        <div className="w-1.5 h-1.5 bg-success-500 rounded-full animate-pulse shadow-glow shadow-success-500" />
                        System Operational
                    </span>
                </div>
            </header>

            <div className="space-y-10">
                {/* Dashboard Stats */}
                <div className="grid grid-cols-1 md:grid-cols-5 gap-6">
                    <StatCard
                        label="PO Ingestion"
                        value={stats?.raw}
                        icon={<Archive size={18} />}
                        trend="+12%"
                        variant="brand"
                        subtitle="Queue → Processing"
                    />
                    <StatCard
                        label="Review Queue"
                        value={stats?.pending}
                        icon={<Timer size={18} />}
                        trend="Critical"
                        variant="warning"
                        subtitle="Awaiting Validation"
                    />
                    <StatCard
                        label="Rep Capacity"
                        value={stats?.rep_allocation}
                        icon={<BarChart3 size={18} />}
                        trend="Optimal"
                        variant="brand"
                        subtitle="Fleet Utilization"
                    />
                    <StatCard
                        label="Billing Load"
                        value={stats?.slip_generated}
                        icon={<DatabaseZap size={18} />}
                        trend="Active"
                        variant="brand"
                        subtitle="Slips Generating"
                    />
                    <StatCard
                        label="Duty Complete"
                        value={stats?.executed}
                        icon={<CheckCircle size={18} />}
                        trend="Success"
                        variant="success"
                        subtitle="Shift Completion"
                    />
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
                {/* Live Ledger */}
                <section className="flex flex-col gap-4">
                    <div className="flex items-center justify-between px-2 mb-1">
                        <div className="flex items-center gap-3">
                            <h2 className="text-sm font-semibold text-neutral-800">Recent Activity</h2>
                            <span className="text-[10px] text-neutral-400 uppercase tracking-widest font-medium">Live Audit Trail</span>
                        </div>
                        <button className="text-[10px] font-bold text-brand-600 uppercase tracking-widest hover:underline">View Ledger</button>
                    </div>
                    <div className="app-card overflow-hidden">
                        <DataGrid
                            data={ledger || []}
                            columns={ledgerColumns}
                            isLoading={ledgerLoading}
                        />
                    </div>
                </section>

                {/* Gap Analysis */}
                <section className="flex flex-col gap-4">
                    <div className="flex items-center justify-between px-2 mb-1">
                        <div className="flex items-center gap-3">
                            <h2 className="text-sm font-semibold text-neutral-800">Inventory Discrepancies</h2>
                            <span className="text-[10px] text-neutral-400 uppercase tracking-widest font-medium">Discrepancy Audit</span>
                        </div>
                        <span className="
                                text-[9px] 
                                font-bold 
                                uppercase 
                                tracking-widest
                                px-2 py-0.5
                                rounded-full
                                bg-danger-50
                                text-danger-700
                                border border-danger-100
                            ">
                            Action Required
                        </span>
                    </div>
                    <div className="app-card overflow-hidden">
                        <DataGrid
                            data={gap || []}
                            columns={gapColumns}
                            isLoading={gapLoading}
                        />
                    </div>
                </section>
            </div>
        </div>
    );
}

function StatCard({
    label,
    value,
    icon,
    trend,
    variant,
    subtitle
}: {
    label: string,
    value: number | string,
    icon: React.ReactNode,
    trend?: string,
    variant: 'brand' | 'warning' | 'success',
    subtitle?: string
}) {
    const statusConfig = {
        brand: {
            badge: 'bg-brand-50 text-brand-700 border-brand-100',
            icon: 'text-brand-600'
        },
        success: {
            badge: 'bg-success-50 text-success-700 border-success-100',
            icon: 'text-success-600'
        },
        warning: {
            badge: 'bg-warning-50 text-warning-700 border-warning-100',
            icon: 'text-warning-600'
        },
    }[variant];

    return (
        <div className="app-card p-6 flex flex-col gap-4 group">
            <div className="flex items-start justify-between">
                <div className="w-10 h-10 rounded-none bg-neutral-100 border border-neutral-200 flex items-center justify-center smooth-transition group-hover:border-brand-200 group-hover:bg-brand-50/50">
                    <div className={statusConfig.icon}>
                        {icon}
                    </div>
                </div>
                {trend && (
                    <div className={`px-2 py-0.5 rounded-full text-[9px] font-bold uppercase tracking-widest border ${statusConfig.badge}`}>
                        {trend}
                    </div>
                )}
            </div>

            <div className="flex flex-col">
                <div className="text-[11px] font-semibold text-neutral-500 uppercase tracking-wider mb-1">
                    {label}
                </div>
                <div className="text-3xl font-extrabold text-neutral-900 tabular-nums tracking-tight">
                    {value || 0}
                </div>
                {subtitle && (
                    <div className="mt-1 text-[11px] text-neutral-400 font-medium whitespace-nowrap overflow-hidden text-ellipsis">
                        {subtitle}
                    </div>
                )}
            </div>
        </div>
    )
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\app\providers.tsx
================================================================================
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useState } from 'react';

export default function Providers({ children }: { children: React.ReactNode }) {
    const [queryClient] = useState(() => new QueryClient());

    return (
        <QueryClientProvider client={queryClient}>
            {children}
        </QueryClientProvider>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\AppShell.tsx
================================================================================
'use client';

import { Sidebar } from './Sidebar';
import { useUserRole } from '../context/UserRoleContext';
import { Bell, LogOut, ArrowLeft, Smartphone, RotateCcw } from 'lucide-react';
import { usePathname, useRouter } from 'next/navigation';
import { useState, useEffect } from 'react';
import { auth } from '../src/lib/firebase';
import { signOut } from 'firebase/auth';
import { DutyEndButton } from './DutyEndButton';
import { OfflineBadge } from './OfflineBadge';
import { useOfflineSync } from '../hooks/useOfflineSync';
import { RoleBadge } from './RoleBadge';
import { useDevicePolicy } from '../hooks/useDevicePolicy';

export function AppShell({ children }: { children: React.ReactNode }) {
    const { role, currentUser, isLoading } = useUserRole();
    const { isOnline, pendingSyncCount, processSyncQueue } = useOfflineSync();
    const { showReadOnlyOverlay } = useDevicePolicy();
    const [isCollapsed, setIsCollapsed] = useState(false);
    const pathname = usePathname();
    const router = useRouter();

    const isLoginPage = pathname === '/login';

    useEffect(() => {
        if (!isLoading && !currentUser && !isLoginPage) {
            router.push('/login');
        }
    }, [isLoading, currentUser, isLoginPage, router]);

    useEffect(() => {
        if (isOnline) {
            processSyncQueue();
        }
    }, [isOnline]);

    if (isLoginPage) {
        return <>{children}</>;
    }

    if (isLoading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-neutral-50">
                <div className="flex flex-col items-center gap-4">
                    <div className="w-10 h-10 border-2 border-primary-700 border-t-transparent rounded-full animate-spin"></div>
                    <p className="text-neutral-500 font-medium text-sm">Initializing Sahakar PPO...</p>
                </div>
            </div>
        );
    }

    if (!currentUser) return null;

    const handleLogout = async () => {
        await signOut(auth);
        router.push('/login');
    };

    return (
        <div className="min-h-screen bg-neutral-50 flex font-sans">
            {/* Portrait Policy Overlay */}
            {showReadOnlyOverlay && (
                <div className="fixed inset-0 z-[100] bg-neutral-900/90 backdrop-blur-xl flex flex-center p-10 text-center animate-in fade-in duration-300">
                    <div className="max-w-xs space-y-6">
                        <div className="w-20 h-20 bg-brand-500 rounded-3xl flex items-center justify-center mx-auto shadow-glow shadow-brand-500/40">
                            <Smartphone className="text-white w-10 h-10 animate-pulse" />
                        </div>
                        <h2 className="text-xl font-bold text-white tracking-tight">Optimal Experience in Landscape</h2>
                        <p className="text-sm text-neutral-400 font-medium">Please rotate your device to access the full operations command center.</p>
                    </div>
                </div>
            )}

            <Sidebar isCollapsed={isCollapsed} onToggle={() => setIsCollapsed(!isCollapsed)} />

            <div className={`flex-1 ${isCollapsed ? 'pl-20' : 'pl-64'} min-h-screen flex flex-col relative overflow-hidden transition-all duration-300`}>
                {/* Background Decor */}
                <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-brand-500/5 blur-[120px] -z-10 rounded-full" />
                <div className="absolute bottom-0 left-0 w-[400px] h-[400px] bg-success-500/5 blur-[100px] -z-10 rounded-full" />

                <header className="sticky top-0 z-40 bg-white/70 backdrop-blur-md border-b border-neutral-200/60 px-8 h-20 flex justify-between items-center">
                    <div className="flex items-center gap-6">
                        <button
                            onClick={() => router.back()}
                            className="w-10 h-10 flex items-center justify-center rounded-xl bg-white border border-neutral-200/60 text-neutral-400 hover:text-neutral-900 hover:border-neutral-300 smooth-transition shadow-sm"
                        >
                            <ArrowLeft size={18} />
                        </button>
                        <div className="h-8 w-px bg-neutral-200/60" />
                        <div className="flex flex-col">
                            <h2 className="text-sm font-bold text-neutral-900 tracking-tight uppercase">Operational Command</h2>
                            <p className="text-[10px] text-neutral-400 font-bold uppercase tracking-widest leading-tight">System Live • {isOnline ? 'Edge Node Sync' : 'Offline Operations'}</p>
                        </div>
                        <OfflineBadge isOnline={isOnline} pendingSyncCount={pendingSyncCount} />
                    </div>

                    <div className="flex items-center gap-6">
                        {(role === 'BILLING_STAFF' || role === 'BILLING_HEAD') && (
                            <DutyEndButton
                                onDutyEnd={async () => {
                                    console.log('Duty ended');
                                }}
                            />
                        )}

                        <div className="flex items-center gap-6 pr-6 border-r border-neutral-200/60">
                            <button className="w-10 h-10 flex items-center justify-center rounded-xl bg-neutral-50 text-neutral-400 hover:text-brand-600 hover:bg-brand-50 smooth-transition relative">
                                <Bell size={20} />
                                <span className="absolute top-2.5 right-2.5 w-2 h-2 bg-danger-500 rounded-full border-2 border-white"></span>
                            </button>

                            <div className="flex items-center gap-4">
                                <div className="text-right flex flex-col items-end">
                                    <span className="text-sm font-bold text-neutral-900 truncate max-w-[150px] leading-tight mb-1">{currentUser.email?.split('@')[0]}</span>
                                    <RoleBadge role={role || 'Authenticating...'} />
                                </div>
                                <div className="w-11 h-11 bg-gradient-to-br from-brand-100 to-brand-50 border border-brand-200/60 text-brand-700 rounded-xl flex items-center justify-center font-bold text-sm uppercase shadow-sm">
                                    {currentUser.email?.substring(0, 2) || 'U'}
                                </div>
                            </div>
                        </div>

                        <button
                            onClick={handleLogout}
                            className="flex items-center gap-2.5 px-4 py-2 rounded-xl text-neutral-500 hover:text-danger-600 hover:bg-danger-50 smooth-transition text-xs font-bold uppercase tracking-widest"
                        >
                            <LogOut size={18} />
                            <span>Sign Out</span>
                        </button>
                    </div>
                </header>

                <main className="flex-1 p-10 w-full overflow-y-auto">
                    {children}
                </main>
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\BackButton.tsx
================================================================================
'use client';

import { ArrowLeft } from 'lucide-react';
import { useRouter } from 'next/navigation';

interface BackButtonProps {
    label?: string;
    href?: string;
    className?: string;
}

export function BackButton({ label = 'Back', href, className = '' }: BackButtonProps) {
    const router = useRouter();

    const handleClick = () => {
        if (href) {
            router.push(href);
        } else {
            router.back();
        }
    };

    return (
        <button
            onClick={handleClick}
            className={`inline-flex items-center gap-2 text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors ${className}`}
        >
            <ArrowLeft className="w-4 h-4" />
            {label}
        </button>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\ConfirmModal.tsx
================================================================================
'use client';

import React from 'react';

interface ConfirmModalProps {
    isOpen: boolean;
    title: string;
    message: string;
    confirmLabel?: string;
    cancelLabel?: string;
    onConfirm: () => void;
    onCancel: () => void;
    variant?: 'danger' | 'primary' | 'accent';
    children?: React.ReactNode;
    showFooter?: boolean;
}

export function ConfirmModal({
    isOpen,
    title,
    message,
    confirmLabel = 'Confirm',
    cancelLabel = 'Cancel',
    onConfirm,
    onCancel,
    variant = 'primary',
    children,
    showFooter = true,
}: ConfirmModalProps) {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-primary-900/40 backdrop-blur-[2px] p-4 transition-all duration-300">
            <div
                className="bg-white rounded border border-neutral-200 shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in-95 duration-200"
                role="dialog"
                aria-modal="true"
            >
                <div className="p-8 pb-6">
                    <h3 className="text-lg font-bold text-primary-900 uppercase tracking-tight">
                        {title}
                    </h3>
                    <div className="mt-2">
                        <p className="text-[11px] text-neutral-400 font-bold uppercase tracking-widest leading-relaxed">
                            {message}
                        </p>
                    </div>
                </div>

                {children && (
                    <div className="px-8 pb-8">
                        {children}
                    </div>
                )}

                {showFooter && (
                    <div className="bg-neutral-50 px-8 py-5 flex flex-row-reverse gap-4 border-t border-neutral-200">
                        <button
                            type="button"
                            onClick={onConfirm}
                            className={`
                px-6 py-2.5 text-[11px] font-bold text-white rounded uppercase tracking-widest shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-offset-2
                ${variant === 'danger'
                                    ? 'bg-error-600 hover:bg-error-700 focus:ring-error-500/20'
                                    : variant === 'accent'
                                        ? 'bg-accent-600 hover:bg-accent-700 focus:ring-accent-500/20'
                                        : 'bg-primary-700 hover:bg-primary-900 focus:ring-primary-500/20'
                                }
              `}
                        >
                            {confirmLabel}
                        </button>
                        <button
                            type="button"
                            onClick={onCancel}
                            className="px-6 py-2.5 text-[11px] font-bold text-neutral-600 border border-neutral-200 rounded uppercase tracking-widest hover:bg-white hover:border-neutral-300 transition-all focus:outline-none"
                        >
                            {cancelLabel}
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\ConflictModal.tsx
================================================================================
'use client';

import React from 'react';
import { AlertTriangle } from 'lucide-react';

interface ConflictData {
    field: string;
    yourValue: any;
    systemValue: any;
}

interface ConflictModalProps {
    isOpen: boolean;
    entity: string;
    conflicts: ConflictData[];
    onKeepMine: () => void;
    onUseSystem: () => void;
    onCancel: () => void;
}

export function ConflictModal({
    isOpen,
    entity,
    conflicts,
    onKeepMine,
    onUseSystem,
    onCancel,
}: ConflictModalProps) {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-[var(--z-modal)] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
            <div
                className="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden"
                role="dialog"
                aria-modal="true"
            >
                <div className="p-6 border-b border-gray-200">
                    <div className="flex items-start gap-4">
                        <div className="flex-shrink-0">
                            <AlertTriangle className="h-6 w-6 text-amber-600" />
                        </div>
                        <div>
                            <h3 className="text-lg font-bold text-gray-900">
                                Conflict Detected
                            </h3>
                            <p className="mt-1 text-sm text-gray-500">
                                This {entity} was modified by another user. Choose which version to keep.
                            </p>
                        </div>
                    </div>
                </div>

                <div className="p-6 space-y-4">
                    {conflicts.map((conflict, index) => (
                        <div key={index} className="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
                                {conflict.field}
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <div className="text-xs font-semibold text-blue-700 mb-1">Your Change</div>
                                    <div className="text-sm font-mono bg-blue-50 border border-blue-200 rounded px-3 py-2">
                                        {String(conflict.yourValue)}
                                    </div>
                                </div>
                                <div>
                                    <div className="text-xs font-semibold text-gray-700 mb-1">Current System Value</div>
                                    <div className="text-sm font-mono bg-white border border-gray-300 rounded px-3 py-2">
                                        {String(conflict.systemValue)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                <div className="bg-gray-50 px-6 py-4 flex justify-end gap-3">
                    <button
                        type="button"
                        onClick={onCancel}
                        className="px-4 py-2 text-sm font-bold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-all"
                    >
                        Cancel
                    </button>
                    <button
                        type="button"
                        onClick={onUseSystem}
                        className="px-4 py-2 text-sm font-bold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-all"
                    >
                        Use System
                    </button>
                    <button
                        type="button"
                        onClick={onKeepMine}
                        className="px-4 py-2 text-sm font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-all"
                    >
                        Keep Mine
                    </button>
                </div>
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\DataGrid.tsx
================================================================================
'use client';

import React, { useMemo, useRef } from 'react';
import {
    useReactTable,
    getCoreRowModel,
    flexRender,
    ColumnDef,
    Row,
    ColumnResizeMode,
} from '@tanstack/react-table';
import { useVirtualizer } from '@tanstack/react-virtual';

interface DataGridProps<TData> {
    data: TData[];
    columns: ColumnDef<TData, any>[];
    isLoading?: boolean;
    onRowClick?: (row: TData) => void;
    stickyHeader?: boolean;
    frozenColumns?: number;
    enableColumnResizing?: boolean;
    isRowLocked?: (row: TData) => boolean;
    isRowHidden?: (row: TData) => boolean;
}

export function DataGrid<TData>({
    data,
    columns,
    isLoading,
    onRowClick,
    stickyHeader = true,
    frozenColumns = 0,
    enableColumnResizing = true,
    isRowLocked = () => false,
    isRowHidden = () => false,
}: DataGridProps<TData>) {
    const [columnResizeMode] = React.useState<ColumnResizeMode>('onChange');

    const table = useReactTable({
        data,
        columns,
        getCoreRowModel: getCoreRowModel(),
        columnResizeMode,
        enableColumnResizing,
    });

    const { rows } = table.getRowModel();

    const parentRef = useRef<HTMLDivElement>(null);

    const virtualizer = useVirtualizer({
        count: rows.length,
        getScrollElement: () => parentRef.current,
        estimateSize: () => 36, // Compact row height from spec
        overscan: 10,
    });

    const virtualRows = virtualizer.getVirtualItems();

    if (isLoading) {
        return (
            <div className="w-full space-y-2 p-4">
                {[...Array(5)].map((_, i) => (
                    <div key={i} className="h-9 w-full bg-neutral-50 animate-pulse rounded-sm" />
                ))}
            </div>
        );
    }

    return (
        <div
            ref={parentRef}
            className="spreadsheet-grid overflow-auto max-h-[calc(100vh-200px)] relative w-full rounded-md border-neutral-200 shadow-sm bg-white"
        >
            <div style={{ height: `${virtualizer.getTotalSize()}px`, width: '100%', position: 'relative' }}>
                <table className="w-full border-collapse text-[13px]">
                    <thead className={stickyHeader ? 'sticky top-0 z-20 bg-neutral-50 shadow-sm' : ''}>
                        {table.getHeaderGroups().map((headerGroup) => (
                            <tr key={headerGroup.id} className="border-b border-neutral-200/60">
                                {headerGroup.headers.map((header, index) => {
                                    const isFrozen = index < frozenColumns;
                                    return (
                                        <th
                                            key={header.id}
                                            className={`
                        px-6 py-4 text-[11px] font-bold text-neutral-500 uppercase tracking-widest
                        ${isFrozen ? 'sticky left-0 z-10 bg-neutral-50' : ''}
                      `}
                                            style={{
                                                width: header.getSize(),
                                                minWidth: header.column.columnDef.minSize,
                                            }}
                                        >
                                            {flexRender(header.column.columnDef.header, header.getContext())}
                                        </th>
                                    );
                                })}
                            </tr>
                        ))}
                    </thead>
                    <tbody className="relative">
                        {virtualRows.map((virtualRow) => {
                            const row = rows[virtualRow.index];
                            return (
                                <tr
                                    key={row.id}
                                    onClick={() => onRowClick?.(row.original)}
                                    className={`
                    border-b border-neutral-200 hover:bg-neutral-50 transition-colors cursor-default group
                    ${onRowClick ? 'cursor-pointer' : ''}
                  `}
                                    style={{
                                        position: 'absolute',
                                        top: 0,
                                        left: 0,
                                        width: '100%',
                                        height: `${virtualRow.size}px`,
                                        transform: `translateY(${virtualRow.start}px)`,
                                    }}
                                >
                                    {row.getVisibleCells().map((cell, index) => {
                                        const isFrozen = index < frozenColumns;
                                        return (
                                            <td
                                                key={cell.id}
                                                className={`
                          px-4 py-2 whitespace-nowrap overflow-hidden text-ellipsis text-neutral-700
                          ${isFrozen ? 'sticky left-0 z-10 bg-white group-hover:bg-neutral-50' : ''}
                        `}
                                            >
                                                {flexRender(cell.column.columnDef.cell, cell.getContext())}
                                            </td>
                                        );
                                    })}
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
            {data.length === 0 && !isLoading && (
                <div className="p-8 text-center text-neutral-400 italic text-sm">
                    No records found.
                </div>
            )}
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\DutyEndButton.tsx
================================================================================
'use client';

import { Power } from 'lucide-react';
import { useState } from 'react';
import { ConfirmModal } from './ConfirmModal';

interface DutyEndButtonProps {
    onDutyEnd: () => Promise<void>;
    disabled?: boolean;
}

export function DutyEndButton({ onDutyEnd, disabled = false }: DutyEndButtonProps) {
    const [showConfirm, setShowConfirm] = useState(false);
    const [isEnding, setIsEnding] = useState(false);

    const handleConfirm = async () => {
        setIsEnding(true);
        try {
            await onDutyEnd();
            setShowConfirm(false);
        } catch (error) {
            console.error('Duty end failed:', error);
        } finally {
            setIsEnding(false);
        }
    };

    return (
        <>
            <button
                onClick={() => setShowConfirm(true)}
                disabled={disabled || isEnding}
                className="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white text-sm font-bold rounded-md hover:bg-red-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <Power className="w-4 h-4" />
                End Duty
            </button>

            <ConfirmModal
                isOpen={showConfirm}
                title="End Duty?"
                message="All your changes will be locked. This action cannot be undone."
                confirmLabel="End Duty"
                cancelLabel="Cancel"
                variant="danger"
                onConfirm={handleConfirm}
                onCancel={() => setShowConfirm(false)}
            />
        </>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\ExcelImportButton.tsx
================================================================================
import React from 'react';
import { Upload } from 'lucide-react';
import * as XLSX from 'xlsx';

interface ExcelImportButtonProps {
    onImport: (data: any[]) => void;
    entityType: 'products' | 'suppliers' | 'rep-master';
    className?: string;
}

export function ExcelImportButton({ onImport, entityType, className = '' }: ExcelImportButtonProps) {
    const fileInputRef = React.useRef<HTMLInputElement>(null);

    const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target?.result as ArrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) {
                    alert('Excel file is empty. Please upload a file with data.');
                    return;
                }

                onImport(jsonData);

                // Reset file input
                if (fileInputRef.current) {
                    fileInputRef.current.value = '';
                }
            } catch (error) {
                console.error('Error parsing Excel file:', error);
                alert(`Error reading Excel file: ${error instanceof Error ? error.message : 'Please check the file format.'}`);
            }
        };
        reader.onerror = () => {
            alert('Failed to read file. Please try again.');
        };
        reader.readAsArrayBuffer(file);
    };

    return (
        <div className={className}>
            <input
                ref={fileInputRef}
                type="file"
                accept=".xlsx,.xls"
                onChange={handleFileUpload}
                className="hidden"
                id={`excel-import-${entityType}`}
            />
            <label
                htmlFor={`excel-import-${entityType}`}
                className="btn-secondary flex items-center gap-2 cursor-pointer inline-flex"
            >
                <Upload size={18} />
                Import Excel
            </label>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\FilterBar.tsx
================================================================================
'use client';

import { Search } from 'lucide-react';

interface FilterOption {
    label: string;
    value: string;
}

interface FilterConfig {
    key: string;
    label: string;
    options: FilterOption[];
}

interface FilterBarProps {
    filters: FilterConfig[];
    onFilterChange: (key: string, value: string) => void;
    onSearch: (term: string) => void;
    onReset: () => void;
}

export function FilterBar({ filters, onFilterChange, onSearch, onReset }: FilterBarProps) {
    return (
        <div className="sticky top-0 z-20 bg-[#F8F9FB] pt-4 pb-4 mb-4 border-b border-gray-200">
            <div className="flex flex-wrap items-center gap-3">
                {/* Search */}
                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <Search className="h-4 w-4 text-gray-400" />
                    </div>
                    <input
                        type="text"
                        placeholder="Search..."
                        className="pl-9 pr-4 py-2 border border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500 w-64"
                        onChange={(e) => onSearch(e.target.value)}
                    />
                </div>

                {/* Dynamic Filters */}
                {filters.map((filter) => (
                    <select
                        key={filter.key}
                        className="pl-3 pr-8 py-2 border border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white"
                        onChange={(e) => onFilterChange(filter.key, e.target.value)}
                    >
                        <option value="">{filter.label}</option>
                        {filter.options.map((opt) => (
                            <option key={opt.value} value={opt.value}>
                                {opt.label}
                            </option>
                        ))}
                    </select>
                ))}

                <div className="flex-1" />

                {/* Reset */}
                <button
                    onClick={onReset}
                    className="text-sm text-gray-500 hover:text-gray-700 font-medium px-3 py-2"
                >
                    Reset Filters
                </button>
            </div>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\Modal.tsx
================================================================================
'use client';
import { Fragment, ReactNode } from 'react';
import { X } from 'lucide-react';

interface ModalProps {
    isOpen: boolean;
    onClose: () => void;
    title: string;
    children: ReactNode;
    size?: 'sm' | 'md' | 'lg' | 'xl';
}

export function Modal({ isOpen, onClose, title, children, size = 'md' }: ModalProps) {
    if (!isOpen) return null;

    const sizeClasses = {
        sm: 'max-w-md',
        md: 'max-w-xl',
        lg: 'max-w-3xl',
        xl: 'max-w-5xl'
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            {/* Backdrop */}
            <div
                className="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
                onClick={onClose}
            />

            {/* Modal Panel */}
            <div className={`relative bg-white rounded-lg shadow-xl w-full ${sizeClasses[size]} flex flex-col max-h-[90vh] animate-in fade-in zoom-in-95 duration-200`}>
                <div className="flex items-center justify-between px-6 py-4 border-b">
                    <h3 className="text-lg font-semibold text-gray-900">{title}</h3>
                    <button
                        onClick={onClose}
                        className="text-gray-400 hover:text-gray-500 transition-colors"
                    >
                        <X className="w-5 h-5" />
                    </button>
                </div>

                <div className="flex-1 overflow-y-auto p-6">
                    {children}
                </div>
            </div>
        </div>
    );
}

interface ConfirmModalProps {
    isOpen: boolean;
    onClose: () => void;
    onConfirm: () => void;
    title: string;
    message: string;
    confirmText?: string;
    cancelText?: string;
    isDestructive?: boolean;
    isLoading?: boolean;
}

export function ConfirmModal({
    isOpen, onClose, onConfirm, title, message,
    confirmText = 'Confirm', cancelText = 'Cancel',
    isDestructive = false, isLoading = false
}: ConfirmModalProps) {
    return (
        <Modal isOpen={isOpen} onClose={onClose} title={title} size="sm">
            <div className="space-y-4">
                <p className="text-gray-600">{message}</p>

                <div className="flex justify-end gap-3 pt-4">
                    <button
                        onClick={onClose}
                        className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                        disabled={isLoading}
                    >
                        {cancelText}
                    </button>
                    <button
                        onClick={onConfirm}
                        className={`px-4 py-2 text-sm font-medium text-white rounded-md shadow-sm 
                            ${isDestructive
                                ? 'bg-red-600 hover:bg-red-700 focus:ring-red-500'
                                : 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-500'}
                            disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2`}
                        disabled={isLoading}
                    >
                        {isLoading && <span className="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin" />}
                        {confirmText}
                    </button>
                </div>
            </div>
        </Modal>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\OfflineBadge.tsx
================================================================================
'use client';

import { WifiOff } from 'lucide-react';

interface OfflineBadgeProps {
    isOnline: boolean;
    pendingSyncCount?: number;
}

export function OfflineBadge({ isOnline, pendingSyncCount = 0 }: OfflineBadgeProps) {
    if (isOnline && pendingSyncCount === 0) return null;

    if (!isOnline) {
        return (
            <div className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded bg-error-100 border border-error-100 text-error-600">
                <WifiOff size={14} className="stroke-[2.5px]" />
                <span className="text-[10px] font-bold uppercase tracking-widest italic">Offline Mode</span>
            </div>
        );
    }

    return (
        <div className="inline-flex items-center gap-2 px-2.5 py-1 rounded bg-accent-100 border border-accent-100 text-accent-600">
            <div className="w-1.5 h-1.5 rounded-full bg-accent-600 animate-pulse" />
            <span className="text-[10px] font-bold uppercase tracking-widest">Syncing ({pendingSyncCount})</span>
        </div>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\RoleBadge.tsx
================================================================================
'use client';

import React from 'react';

export type UserRole =
    | 'MASTER_ADMIN'
    | 'BILLING_HEAD'
    | 'BILLING_STAFF'
    | 'PURCHASE_HEAD'
    | 'PURCHASE_STAFF'
    | 'WAREHOUSE_STAFF'
    | 'REP';

interface RoleBadgeProps {
    role: UserRole | string;
    className?: string;
}

const roleStyles: Record<string, { bg: string, text: string, border: string, label: string }> = {
    'MASTER_ADMIN': { bg: 'bg-brand-900', text: 'text-white', border: 'border-brand-700/50', label: 'MASTER ADMIN' },
    'BILLING_HEAD': { bg: 'bg-brand-700/10', text: 'text-brand-700', border: 'border-brand-300/30', label: 'BILLING HEAD' },
    'BILLING_STAFF': { bg: 'bg-brand-50/50', text: 'text-brand-600', border: 'border-brand-200/50', label: 'BILLING STAFF' },
    'PURCHASE_HEAD': { bg: 'bg-brand-800', text: 'text-white', border: 'border-brand-600/50', label: 'PURCHASE HEAD' },
    'PURCHASE_STAFF': { bg: 'bg-indigo-50/50', text: 'text-indigo-600', border: 'border-indigo-200/50', label: 'PURCHASE' },
    'WAREHOUSE_STAFF': { bg: 'bg-neutral-100', text: 'text-neutral-700', border: 'border-neutral-200/50', label: 'WAREHOUSE' },
    'REP': { bg: 'bg-warning-50/50', text: 'text-warning-600', border: 'border-warning-200/50', label: 'REP' },
};

export const RoleBadge: React.FC<RoleBadgeProps> = ({ role, className = '' }) => {
    const style = roleStyles[role] || { bg: 'bg-neutral-100', text: 'text-neutral-500', border: 'border-neutral-200/50', label: role.replace('_', ' ') };

    return (
        <span
            className={`inline-flex items-center px-2 py-0.5 rounded-lg text-[9px] font-bold tracking-widest uppercase border border-transparent shadow-sm ${style.bg} ${style.text} ${style.border} ${className}`}
        >
            {style.label}
        </span>
    );
};




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\Sidebar.tsx
================================================================================
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import {
    LayoutDashboard,
    Upload,
    ClipboardList,
    Truck,
    FileText,
    Archive,
    Receipt,
    ListChecks,
    BarChart3,
    Factory,
    Package,
    RefreshCw,
    Users,
    Shield,
    Settings,
    ScrollText,
    Clock,
    LogOut,
    ChevronLeft,
    ChevronRight,
    ArrowLeft
} from 'lucide-react';
import { useUserRole } from '../context/UserRoleContext';

interface SidebarProps {
    isCollapsed: boolean;
    onToggle: () => void;
}

const MENU_GROUPS = [
    {
        title: 'Operations',
        items: [
            { label: 'Dashboard', href: '/', icon: LayoutDashboard },
            { label: 'PPO Input', href: '/order-import', icon: Upload },
            { label: 'Pending POs', href: '/pending-orders', icon: ClipboardList },
            { label: 'REP Orders', href: '/rep-allocation', icon: Truck },
        ]
    },
    {
        title: 'Billing',
        items: [
            { label: "Today's Slips", href: '/order-slips', icon: FileText },
            { label: 'Slip History', href: '/order-slips/history', icon: Archive },
            { label: 'Billing Execution', href: '/billing', icon: Receipt },
        ]
    },
    {
        title: 'Analysis',
        items: [
            { label: 'Status Ledger', href: '/ledger', icon: ListChecks },
            { label: 'Analysis', href: '/analysis', icon: BarChart3 },
        ]
    },
    {
        title: 'Masters',
        items: [
            { label: 'Suppliers', href: '/suppliers', icon: Factory },
            { label: 'Products', href: '/products', icon: Package },
            { label: 'Name Changes', href: '/name-changes', icon: RefreshCw },
            { label: 'REP Master', href: '/rep-master', icon: Users },
        ]
    },
    {
        title: 'System',
        items: [
            { label: 'Users & Roles', href: '/users', icon: Shield },
            { label: 'Settings', href: '/settings', icon: Settings },
            { label: 'Audit Logs', href: '/logs', icon: ScrollText },
            { label: 'Duty Sessions', href: '/duty-sessions', icon: Clock },
        ]
    }
];

export function Sidebar({ isCollapsed, onToggle }: SidebarProps) {
    const pathname = usePathname();
    const { role } = useUserRole();

    return (
        <aside className={`${isCollapsed ? 'w-20' : 'w-64'} h-screen bg-white border-r border-neutral-200/60 fixed left-0 top-0 flex flex-col z-50 smooth-transition shadow-sm`}>
            <div className="h-20 flex items-center justify-between px-6 border-b border-neutral-100/50">
                {!isCollapsed && (
                    <div className="flex items-center gap-3 animate-in fade-in slide-in-from-left-2 duration-300">
                        <div className="w-9 h-9 bg-brand-600 rounded-xl flex items-center justify-center shadow-lg shadow-brand-500/30">
                            <Package className="text-white w-5 h-5" />
                        </div>
                        <span className="text-xl font-bold text-neutral-900 tracking-tight">Sahakar <span className="text-brand-600">PPO</span></span>
                    </div>
                )}
                <button
                    onClick={onToggle}
                    className={`w-8 h-8 rounded-lg bg-neutral-50 text-neutral-400 hover:text-brand-600 hover:bg-brand-50 smooth-transition flex items-center justify-center ${isCollapsed ? 'mx-auto' : ''}`}
                >
                    {isCollapsed ? <ChevronRight size={18} /> : <ChevronLeft size={18} />}
                </button>
            </div>

            <nav className="flex-1 overflow-y-auto px-3 py-6 space-y-8 scrollbar-hide">
                {MENU_GROUPS.map((group) => (
                    <div key={group.title} className="space-y-1">
                        {!isCollapsed && (
                            <div className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest px-4 mb-3 animate-in fade-in slide-in-from-left-1 duration-300">{group.title}</div>
                        )}
                        {group.items.map((item) => {
                            const isActive = pathname === item.href || (item.href !== '/' && pathname.startsWith(item.href));
                            const Icon = item.icon;

                            return (
                                <Link
                                    key={item.href}
                                    href={item.href}
                                    title={isCollapsed ? item.label : undefined}
                                    className={`
                                        flex items-center px-4 py-3 rounded-xl text-sm font-semibold transition-all duration-200 group relative
                                        ${isActive
                                            ? 'bg-brand-50 text-brand-700'
                                            : 'text-neutral-500 hover:bg-neutral-50 hover:text-brand-600'}
                                        ${isCollapsed ? 'justify-center' : 'justify-between'}
                                    `}
                                >
                                    <div className="flex items-center gap-3">
                                        <Icon size={20} className={`smooth-transition ${isActive ? 'text-brand-600' : 'text-neutral-400 group-hover:text-brand-500'}`} />
                                        {!isCollapsed && <span className="truncate max-w-[140px]">{item.label}</span>}
                                    </div>
                                    {!isCollapsed && isActive && <div className="w-1.5 h-1.5 rounded-full bg-brand-600 shadow-glow shadow-brand-500/50" />}
                                    {isCollapsed && isActive && (
                                        <div className="absolute right-0 top-1/2 -translate-y-1/2 w-1 h-6 bg-brand-600 rounded-l-full shadow-glow shadow-brand-500/50" />
                                    )}
                                </Link>
                            );
                        })}
                    </div>
                ))}
            </nav>

            <div className="p-4 border-t border-neutral-100/50">
                <div className={`w-full flex items-center gap-3 p-3 rounded-xl text-neutral-500 group ${isCollapsed ? 'justify-center' : ''}`}>
                    <div className="w-8 h-8 rounded-lg bg-neutral-100 flex items-center justify-center text-neutral-400 group-hover:bg-brand-50 group-hover:text-brand-600 smooth-transition">
                        <Users size={16} />
                    </div>
                    {!isCollapsed && (
                        <div className="flex flex-col">
                            <span className="text-xs font-bold text-neutral-900">Support Hub</span>
                            <span className="text-[10px] text-neutral-400 font-medium tracking-tight">Sahakar Desk</span>
                        </div>
                    )}
                </div>
            </div>
        </aside>
    );
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\StatusBadge.tsx
================================================================================
'use client';

import React from 'react';

export type StatusType =
    | 'BILLED'
    | 'NOT BILLED'
    | 'PARTIALLY BILLED'
    | 'PRODUCT CHANGED'
    | 'DAMAGED'
    | 'MISSING'
    | 'DONE'
    | 'LOCKED'
    | 'PENDING'
    | 'REP_ALLOCATION'
    | 'SLIP_GENERATED'
    | 'EXECUTED';

interface StatusBadgeProps {
    status: StatusType;
    className?: string;
}

const statusMap: Record<StatusType, { bg: string, text: string, border: string, label: string }> = {
    'BILLED': { bg: 'bg-success-100/40', text: 'text-success-600', border: 'border-success-200/50', label: 'BILLED' },
    'NOT BILLED': { bg: 'bg-neutral-100', text: 'text-neutral-500', border: 'border-neutral-200/50', label: 'NOT BILLED' },
    'PARTIALLY BILLED': { bg: 'bg-warning-100/40', text: 'text-warning-600', border: 'border-warning-200/50', label: 'PARTIAL' },
    'PRODUCT CHANGED': { bg: 'bg-warning-100/40', text: 'text-warning-600', border: 'border-warning-200/50', label: 'CHANGED' },
    'DAMAGED': { bg: 'bg-danger-100/40', text: 'text-danger-600', border: 'border-danger-200/50', label: 'DAMAGED' },
    'MISSING': { bg: 'bg-danger-100/40', text: 'text-danger-600', border: 'border-danger-200/50', label: 'MISSING' },
    'DONE': { bg: 'bg-brand-100/40', text: 'text-brand-600', border: 'border-brand-200/50', label: 'DONE' },
    'LOCKED': { bg: 'bg-neutral-100', text: 'text-neutral-400', border: 'border-neutral-200/50', label: 'LOCKED' },
    'PENDING': { bg: 'bg-warning-100/40', text: 'text-warning-600', border: 'border-warning-200/50', label: 'PENDING' },
    'REP_ALLOCATION': { bg: 'bg-brand-50', text: 'text-brand-600', border: 'border-brand-200/50', label: 'REP ALLOC' },
    'SLIP_GENERATED': { bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-200/50', label: 'SLIP GEN' },
    'EXECUTED': { bg: 'bg-success-100/40', text: 'text-success-600', border: 'border-success-200/50', label: 'EXECUTED' },
};

export const StatusBadge: React.FC<StatusBadgeProps> = ({ status, className = '' }) => {
    const config = statusMap[status] || { bg: 'bg-neutral-100', text: 'text-neutral-600', border: 'border-neutral-200', label: status };

    return (
        <span
            className={`inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold tracking-wider uppercase border smooth-transition ${config.bg} ${config.text} ${config.border} ${className}`}
        >
            {status === 'DONE' && <span className="w-1.5 h-1.5 rounded-full bg-current mr-2 animate-pulse" />}
            {config.label}
        </span>
    );
};




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\components\Toast.tsx
================================================================================
'use client';
import { createContext, useContext, useState, ReactNode, useCallback } from 'react';
import { CheckCircle, Info, AlertTriangle, X } from 'lucide-react';

type ToastType = 'success' | 'error' | 'info' | 'warning';

interface Toast {
    id: string;
    type: ToastType;
    message: string;
}

interface ToastContextType {
    showToast: (message: string, type?: ToastType) => void;
}

const ToastContext = createContext<ToastContextType | undefined>(undefined);

export function ToastProvider({ children }: { children: ReactNode }) {
    const [toasts, setToasts] = useState<Toast[]>([]);

    const showToast = useCallback((message: string, type: ToastType = 'info') => {
        const id = Math.random().toString(36).substring(2, 9);
        setToasts(prev => [...prev, { id, type, message }]);

        // Auto dismiss
        setTimeout(() => {
            setToasts(prev => prev.filter(t => t.id !== id));
        }, 5000);
    }, []);

    const removeToast = (id: string) => {
        setToasts(prev => prev.filter(t => t.id !== id));
    };

    return (
        <ToastContext.Provider value={{ showToast }}>
            {children}
            {/* Toast Container */}
            <div className="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
                {toasts.map(toast => (
                    <div
                        key={toast.id}
                        className={`pointer-events-auto flex items-start gap-3 min-w-[300px] max-w-md p-4 rounded-lg shadow-lg border animate-in slide-in-from-right-full duration-300
                            ${toast.type === 'success' ? 'bg-white border-green-200 text-green-800' : ''}
                            ${toast.type === 'error' ? 'bg-white border-red-200 text-red-800' : ''}
                            ${toast.type === 'info' ? 'bg-white border-blue-200 text-blue-800' : ''}
                            ${toast.type === 'warning' ? 'bg-white border-yellow-200 text-yellow-800' : ''}
                        `}
                    >
                        <div className="mt-0.5 shrink-0">
                            {toast.type === 'success' && <CheckCircle className="w-5 h-5 text-green-500" />}
                            {toast.type === 'error' && <AlertTriangle className="w-5 h-5 text-red-500" />}
                            {toast.type === 'info' && <Info className="w-5 h-5 text-blue-500" />}
                            {toast.type === 'warning' && <AlertTriangle className="w-5 h-5 text-yellow-500" />}
                        </div>
                        <p className="flex-1 text-sm font-medium text-gray-800">{toast.message}</p>
                        <button
                            onClick={() => removeToast(toast.id)}
                            className="text-gray-400 hover:text-gray-600 transition-colors"
                        >
                            <X className="w-4 h-4" />
                        </button>
                    </div>
                ))}
            </div>
        </ToastContext.Provider>
    );
}

export function useToast() {
    const context = useContext(ToastContext);
    if (!context) throw new Error('useToast must be used within ToastProvider');
    return context;
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\lib\db.ts
================================================================================
import Dexie, { Table } from 'dexie';

// Offline data models
export interface CachedProduct {
    id: string;
    legacyId?: string;
    productCode?: string;
    itemName: string;
    packing?: string;
    category?: string;
    subcategory?: string;
    mrp?: number;
    active: boolean;
    cachedAt: number;
}

export interface CachedSupplier {
    id: string;
    supplierCode?: string;
    supplierName: string;
    contactPerson?: string;
    mobile?: string;
    email?: string;
    active: boolean;
    cachedAt: number;
}

export interface SyncQueueItem {
    id?: number;
    endpoint: string;
    method: 'POST' | 'PUT' | 'DELETE';
    payload: any;
    createdAt: number;
    retryCount: number;
    status: 'pending' | 'syncing' | 'failed';
}

export interface OrderSlipCache {
    id: string;
    supplierId: string;
    slipDate: string;
    generatedBy: string;
    items: any[];
    cachedAt: number;
}

export class SahakarDB extends Dexie {
    products!: Table<CachedProduct, string>;
    suppliers!: Table<CachedSupplier, string>;
    syncQueue!: Table<SyncQueueItem, number>;
    orderSlips!: Table<OrderSlipCache, string>;

    constructor() {
        super('SahakarPPO');

        this.version(1).stores({
            products: 'id, legacyId, itemName, category, cachedAt',
            suppliers: 'id, supplierCode, supplierName, cachedAt',
            syncQueue: '++id, endpoint, status, createdAt',
            orderSlips: 'id, supplierId, slipDate, cachedAt'
        });
    }
}

export const db = new SahakarDB();




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\lib\sync-queue.ts
================================================================================
import { db } from './db';

export class SyncQueue {
    /**
     * Add an API call to the sync queue
     */
    static async enqueue(endpoint: string, method: 'POST' | 'PUT' | 'DELETE', payload: any) {
        await db.syncQueue.add({
            endpoint,
            method,
            payload,
            createdAt: Date.now(),
            retryCount: 0,
            status: 'pending'
        });
    }

    /**
     * Process all pending items in the sync queue
     */
    static async processPending() {
        const pendingItems = await db.syncQueue
            .where('status')
            .equals('pending')
            .toArray();

        for (const item of pendingItems) {
            await this.syncItem(item);
        }
    }

    /**
     * Sync a single item
     */
    private static async syncItem(item: any) {
        if (!item.id) return;

        try {
            // Update status to syncing
            await db.syncQueue.update(item.id, { status: 'syncing' });

            const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'https://asia-south1-sahakar-ppo.cloudfunctions.net/api';
            const response = await fetch(`${apiUrl}${item.endpoint}`, {
                method: item.method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(item.payload)
            });

            if (response.ok) {
                // Successfully synced, remove from queue
                await db.syncQueue.delete(item.id);
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.error(`Failed to sync item ${item.id}:`, error);

            // Increment retry count
            await db.syncQueue.update(item.id, {
                status: 'failed',
                retryCount: item.retryCount + 1
            });

            // If too many retries, mark as permanently failed
            if (item.retryCount >= 5) {
                console.error(`Item ${item.id} failed after 5 retries`);
            }
        }
    }

    /**
     * Get count of pending items
     */
    static async getPendingCount(): Promise<number> {
        return await db.syncQueue
            .where('status')
            .equals('pending')
            .count();
    }

    /**
     * Clear all synced items
     */
    static async clearSynced() {
        await db.syncQueue.where('status').equals('pending').delete();
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\hooks\useDevicePolicy.ts
================================================================================
'use client';

import { useState, useEffect } from 'react';

export function useDevicePolicy() {
    const [orientation, setOrientation] = useState<'portrait' | 'landscape'>('landscape');
    const [isMobile, setIsMobile] = useState(false);

    useEffect(() => {
        const checkPolicy = () => {
            const isPortrait = window.innerHeight > window.innerWidth;
            const mobileCheck = window.innerWidth < 768;

            setOrientation(isPortrait ? 'portrait' : 'landscape');
            setIsMobile(mobileCheck);
        };

        checkPolicy();
        window.addEventListener('resize', checkPolicy);
        return () => window.removeEventListener('resize', checkPolicy);
    }, []);

    return {
        orientation,
        isMobile,
        isPortrait: orientation === 'portrait',
        isLandscape: orientation === 'landscape',
        canEdit: orientation === 'landscape' || !isMobile,
        showReadOnlyOverlay: orientation === 'portrait' && isMobile
    };
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\hooks\useKeyboardShortcuts.ts
================================================================================
'use client';

import { useEffect } from 'react';

export interface KeyboardShortcutConfig {
    key: string;
    ctrlKey?: boolean;
    shiftKey?: boolean;
    action: () => void;
    description: string;
}

export function useKeyboardShortcuts(shortcuts: KeyboardShortcutConfig[], enabled: boolean = true) {
    useEffect(() => {
        if (!enabled) return;

        const handleKeyDown = (e: KeyboardEvent) => {
            for (const shortcut of shortcuts) {
                const ctrlMatch = shortcut.ctrlKey !== undefined ? shortcut.ctrlKey === e.ctrlKey : true;
                const shiftMatch = shortcut.shiftKey !== undefined ? shortcut.shiftKey === e.shiftKey : true;
                const keyMatch = e.key.toLowerCase() === shortcut.key.toLowerCase();

                if (ctrlMatch && shiftMatch && keyMatch) {
                    e.preventDefault();
                    shortcut.action();
                    break;
                }
            }
        };

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [shortcuts, enabled]);
}

// Common shortcuts for the application
export const COMMON_SHORTCUTS: KeyboardShortcutConfig[] = [
    {
        key: 'f',
        ctrlKey: true,
        action: () => {
            const searchInput = document.querySelector<HTMLInputElement>('input[type="text"]');
            searchInput?.focus();
        },
        description: 'Focus search'
    },
    {
        key: 'Escape',
        action: () => {
            const activeElement = document.activeElement as HTMLElement;
            activeElement?.blur();
        },
        description: 'Cancel/Close'
    },
];




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\hooks\useNetworkStatus.ts
================================================================================
'use client';
import { useEffect, useState } from 'react';
import { SyncQueue } from '../lib/sync-queue';

export function useNetworkStatus() {
    const [isOnline, setIsOnline] = useState(true);
    const [pendingSync, setPendingSync] = useState(0);

    useEffect(() => {
        // Check initial online status
        setIsOnline(navigator.onLine);

        // Update pending count
        const updatePendingCount = async () => {
            const count = await SyncQueue.getPendingCount();
            setPendingSync(count);
        };

        // Handle online event
        const handleOnline = async () => {
            setIsOnline(true);
            console.log('🌐 Back online - processing sync queue');

            // Process pending sync items
            await SyncQueue.processPending();
            await updatePendingCount();
        };

        // Handle offline event
        const handleOffline = () => {
            setIsOnline(false);
            console.log('📡 Offline - mutations will queue');
        };

        // Add event listeners
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);

        // Update pending count on mount
        updatePendingCount();

        // Poll for pending count updates
        const interval = setInterval(updatePendingCount, 10000);

        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
            clearInterval(interval);
        };
    }, []);

    return { isOnline, pendingSync };
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\web\hooks\useOfflineSync.ts
================================================================================
import { useState, useEffect } from 'react';
import { db, SyncOperation } from '../src/lib/dexie';

export function useOfflineSync() {
    const [isOnline, setIsOnline] = useState(true);
    const [pendingSyncCount, setPendingSyncCount] = useState(0);

    useEffect(() => {
        // Monitor online status
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);

        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        setIsOnline(navigator.onLine);

        // Monitor sync queue count
        const updateSyncCount = async () => {
            const count = await db.syncQueue.count();
            setPendingSyncCount(count);
        };

        updateSyncCount();
        const interval = setInterval(updateSyncCount, 5000); // Check every 5s

        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
            clearInterval(interval);
        };
    }, []);

    const addToSyncQueue = async (operation: Omit<SyncOperation, 'id' | 'createdAt'>) => {
        await db.syncQueue.add({
            ...operation,
            createdAt: Date.now()
        });
        const count = await db.syncQueue.count();
        setPendingSyncCount(count);
    };

    const processSyncQueue = async () => {
        if (!isOnline) return;

        const operations = await db.syncQueue.orderBy('priority').reverse().toArray();
        if (operations.length === 0) return;

        console.log(`Processing ${operations.length} sync operations...`);

        for (const op of operations) {
            try {
                // Here we would call the actual API
                // For now, let's simulate a successful sync
                console.log(`Syncing operation: ${op.type} ${op.action}`);

                // await api.post('/sync', op.data); 

                await db.syncQueue.delete(op.id!);
            } catch (error) {
                console.error('Sync failed for operation', op.id, error);
                // Keep in queue for retry
                break;
            }
        }
    };

    return {
        isOnline,
        pendingSyncCount,
        addToSyncQueue,
        processSyncQueue
    };
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\common\middleware\raw-body.middleware.ts
================================================================================

import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';
import { Readable } from 'stream';

@Injectable()
export class RawBodyMiddleware implements NestMiddleware {
    use(req: any, res: Response, next: NextFunction) {
        // Firebase Cloud Functions pre-parses the body.
        // If it's a multipart request and rawBody exists, we need to restore the stream for Multer.
        if (req.rawBody && req.headers['content-type']?.includes('multipart/form-data')) {
            const stream = new Readable();
            stream.push(req.rawBody);
            stream.push(null);

            // Monkey-patch the request object to behave like the stream
            req.read = stream.read.bind(stream);
            req.pipe = stream.pipe.bind(stream);
            req.on = stream.on.bind(stream);
            req.resume = stream.resume.bind(stream);
            req.pause = stream.pause.bind(stream);
            req.unshift = stream.unshift.bind(stream);
        }
        next();
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\audit-logs\audit-logs.controller.ts
================================================================================
import { Controller, Get, Query } from '@nestjs/common';
import { AuditLogsService } from './audit-logs.service';

@Controller('audit-events')
export class AuditLogsController {
    constructor(private readonly service: AuditLogsService) { }

    @Get()
    async findAll(
        @Query('entityType') entityType?: string,
        @Query('action') action?: string,
        @Query('actor') actor?: string
    ) {
        return await this.service.findAll({ entityType, action, actor });
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\audit-logs\audit-logs.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { AuditLogsController } from './audit-logs.controller';
import { AuditLogsService } from './audit-logs.service';

@Module({
    controllers: [AuditLogsController],
    providers: [AuditLogsService],
    exports: [AuditLogsService]
})
export class AuditLogsModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\audit-logs\audit-logs.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, auditEvents } from '@sahakar/database';
import { eq, like, and } from 'drizzle-orm';

@Injectable()
export class AuditLogsService {
    async findAll(filters?: {
        entityType?: string;
        action?: string;
        actor?: string;
    }) {
        let query = db.select().from(auditEvents);

        if (filters) {
            const conditions = [];
            if (filters.entityType) {
                conditions.push(eq(auditEvents.entityType, filters.entityType));
            }
            if (filters.action) {
                conditions.push(like(auditEvents.action, `%${filters.action}%`));
            }
            if (filters.actor) {
                conditions.push(like(auditEvents.actor, `%${filters.actor}%`));
            }
            if (conditions.length > 0) {
                query = query.where(and(...conditions)) as any;
            }
        }

        return await query;
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\auth\auth.controller.ts
================================================================================
import { Controller, Get, UseGuards, Req } from '@nestjs/common';
import { FirebaseAuthGuard } from './firebase-auth.guard';
import { db, users } from '@sahakar/database';
import { eq } from 'drizzle-orm';

@Controller('auth')
export class AuthController {
    constructor() { }

    @Get('me')
    @UseGuards(FirebaseAuthGuard)
    async getMe(@Req() req: any) {
        // req.user contains the decoded Firebase token
        const email = req.user.email;
        const user = await db.select().from(users).where(eq(users.email, email)).limit(1);
        return user[0] || { role: null };
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\auth\auth.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { PassportModule } from '@nestjs/passport';
import { FirebaseService } from './firebase.service';
import { FirebaseAuthStrategy } from './firebase-auth.strategy';
import { AuthController } from './auth.controller';

@Module({
    imports: [PassportModule.register({ defaultStrategy: 'firebase-auth' })],
    controllers: [AuthController],
    providers: [FirebaseService, FirebaseAuthStrategy],
    exports: [FirebaseService],
})
export class AuthModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\auth\firebase-auth.guard.ts
================================================================================
import { Injectable, ExecutionContext } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class FirebaseAuthGuard extends AuthGuard('firebase-auth') {
    // Optionally override to skip auth for public routes (e.g. health check)
    async canActivate(context: ExecutionContext): Promise<boolean> {
        return (await super.canActivate(context)) as boolean;
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\auth\firebase-auth.strategy.ts
================================================================================
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { Strategy, ExtractJwt } from 'passport-jwt';
import { FirebaseService } from './firebase.service';

@Injectable()
export class FirebaseAuthStrategy extends PassportStrategy(Strategy, 'firebase-auth') {
    constructor(private readonly firebaseService: FirebaseService) {
        super({
            jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
            ignoreExpiration: false,
            // We use a dummy secret because the actual verification is done in the validate method via Firebase Admin
            secretOrKey: 'DUMMY_SECRET',
        });
    }

    async validate(payload: any, done: (err: any, user: any) => void) {
        // The Passport-JWT strategy normally verifies the signature using the secretOrKey.
        // However, for Firebase, we need to verify the token via the Firebase Admin SDK.
        // Because Passport-JWT already parsed it, we can re-verify or just trust the payload if verified.
        // A better approach often is a custom strategy, but we can override the verification logic.
        return payload;
    }

    // Overriding the default JWT verification to use Firebase Admin
    async authenticate(req: any, options?: any) {
        const idToken = ExtractJwt.fromAuthHeaderAsBearerToken()(req);
        if (!idToken) {
            return this.fail(new UnauthorizedException('Missing token'), 401);
        }

        try {
            const decodedToken = await this.firebaseService.verifyToken(idToken);
            req.user = decodedToken;
            this.success(decodedToken);
        } catch (error) {
            this.fail(new UnauthorizedException('Invalid token'), 401);
        }
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\auth\firebase.service.ts
================================================================================
import { Injectable, OnModuleInit } from '@nestjs/common';
import * as admin from 'firebase-admin';

@Injectable()
export class FirebaseService implements OnModuleInit {
    onModuleInit() {
        if (admin.apps.length === 0) {
            // In production, Firebase Admin uses service account from environment or IAM
            // For local dev, ensure GOOGLE_APPLICATION_CREDENTIALS is set
            admin.initializeApp({
                credential: admin.credential.applicationDefault()
            });
        }
    }

    async verifyToken(idToken: string) {
        try {
            return await admin.auth().verifyIdToken(idToken);
        } catch (error) {
            throw error;
        }
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\billing\billing.controller.ts
================================================================================
import { Controller, Put, Post, Body, Param, Request } from '@nestjs/common';
import { BillingService } from './billing.service';

@Controller('billing')
export class BillingController {
    constructor(private readonly service: BillingService) { }

    @Put('slip-items/:id')
    async updateStatus(
        @Param('id') id: string,
        @Body() data: {
            status: string;
            qtyReceived?: number;
            qtyDamaged?: number;
            qtyPending?: number;
            invoiceId?: string;
            notes?: string;
        },
        @Request() req: any
    ) {
        const userEmail = req.user?.email || 'system@sahakar.local';
        return await this.service.updateBillingStatus(id, data, userEmail);
    }

    @Post('duty/start')
    async startDuty(@Request() req: any) {
        const userEmail = req.user?.email || 'system@sahakar.local';
        return await this.service.startDutySession(userEmail);
    }

    @Post('duty/end')
    async endDuty(@Request() req: any) {
        const userEmail = req.user?.email || 'system@sahakar.local';
        return await this.service.endDutySession(userEmail);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\billing\billing.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { BillingService } from './billing.service';
import { BillingController } from './billing.controller';

@Module({
    controllers: [BillingController],
    providers: [BillingService],
    exports: [BillingService]
})
export class BillingModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\billing\billing.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, orderSlipItems, statusEvents, auditEvents, dutySessions, users } from '@sahakar/database';
import { sql, eq, and } from 'drizzle-orm';

@Injectable()
export class BillingService {
    /**
     * Workflow 5: Billing Status Update
     * 
     * Rules:
     * - Status enum enforcement
     * - Duty session validation
     * - Append-only status_events
     * - BILLING_HEAD override capability
     */
    async updateBillingStatus(
        orderSlipItemId: string,
        data: {
            status: string;
            qtyReceived?: number;
            qtyDamaged?: number;
            qtyPending?: number;
            invoiceId?: string;
            notes?: string;
        },
        userEmail: string
    ) {
        return await db.transaction(async (tx) => {
            // Get user
            const usersResult = await tx.select().from(users).where(eq(users.email, userEmail)).limit(1);

            if (!usersResult.length) {
                throw new Error('User not found');
            }

            const user = usersResult[0];

            // Check duty session for BILLING_STAFF
            if (user.role === 'BILLING_STAFF') {
                const activeSessions = await tx
                    .select()
                    .from(dutySessions)
                    .where(
                        and(
                            eq(dutySessions.userId, user.id),
                            eq(dutySessions.active, true)
                        )
                    );

                if (!activeSessions.length) {
                    throw new Error('No active duty session - BILLING_STAFF must clock in');
                }
            }

            // BILLING_HEAD can override without duty session

            // Get current slip item
            const items = await tx.select().from(orderSlipItems).where(eq(orderSlipItems.id, orderSlipItemId)).limit(1);

            if (!items.length) {
                throw new Error('Order slip item not found');
            }

            const item = items[0];

            // Update slip item status
            await tx.update(orderSlipItems)
                .set({
                    status: data.status as any,
                    invoiceId: data.invoiceId
                })
                .where(eq(orderSlipItems.id, orderSlipItemId));

            // Append-only status event
            await tx.insert(statusEvents).values({
                orderSlipItemId: orderSlipItemId,
                status: data.status,
                qtyReceived: data.qtyReceived,
                qtyDamaged: data.qtyDamaged,
                qtyPending: data.qtyPending,
                invoiceId: data.invoiceId,
                notes: data.notes,
                staffEmail: userEmail
            });

            // Audit event
            await tx.insert(auditEvents).values({
                entityType: 'ORDER_SLIP_ITEM',
                entityId: orderSlipItemId,
                action: 'UPDATE_BILLING_STATUS',
                beforeState: JSON.stringify(item),
                afterState: JSON.stringify({ ...item, status: data.status }),
                actor: userEmail
            });

            return { success: true };
        });
    }

    /**
     * Start duty session for billing staff
     */
    async startDutySession(userEmail: string) {
        return await db.transaction(async (tx) => {
            const usersResult = await tx.select().from(users).where(eq(users.email, userEmail)).limit(1);

            if (!usersResult.length) {
                throw new Error('User not found');
            }

            const user = usersResult[0];

            if (user.role !== 'BILLING_STAFF' && user.role !== 'BILLING_HEAD') {
                throw new Error('Only billing staff can start duty sessions');
            }

            // End any active sessions first
            await tx.update(dutySessions)
                .set({ active: false, endTime: new Date() })
                .where(
                    and(
                        eq(dutySessions.userId, user.id),
                        eq(dutySessions.active, true)
                    )
                );

            // Start new session
            await tx.insert(dutySessions).values({
                userId: user.id,
                active: true
            });

            return { success: true };
        });
    }

    async endDutySession(userEmail: string) {
        return await db.transaction(async (tx) => {
            const usersResult = await tx.select().from(users).where(eq(users.email, userEmail)).limit(1);

            if (!usersResult.length) {
                throw new Error('User not found');
            }

            const user = usersResult[0];

            await tx.update(dutySessions)
                .set({ active: false, endTime: new Date() })
                .where(
                    and(
                        eq(dutySessions.userId, user.id),
                        eq(dutySessions.active, true)
                    )
                );

            return { success: true };
        });
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\conflict\conflict.controller.ts
================================================================================
import { Controller, Post, Body, Request } from '@nestjs/common';
import { ConflictService, ConflictResolution } from './conflict.service';

@Controller('conflict')
export class ConflictController {
    constructor(private readonly service: ConflictService) { }

    @Post('resolve')
    async resolveConflict(
        @Body() conflict: ConflictResolution,
        @Request() req: any
    ) {
        const userEmail = req.user?.email || 'system@sahakar.local';
        return await this.service.resolveConflict(conflict, userEmail);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\conflict\conflict.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { ConflictService } from './conflict.service';
import { ConflictController } from './conflict.controller';

@Module({
    controllers: [ConflictController],
    providers: [ConflictService],
    exports: [ConflictService]
})
export class ConflictModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\conflict\conflict.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, auditEvents } from '@sahakar/database';
import { sql } from 'drizzle-orm';

export interface ConflictResolution {
    entityType: string;
    entityId: string;
    localVersion: any;
    serverVersion: any;
    resolution: 'KEEP_LOCAL' | 'KEEP_SERVER' | 'MANUAL_MERGE';
    resolvedBy: string;
    reason: string;
}

@Injectable()
export class ConflictService {
    /**
     * Workflow 6: Offline Conflict Resolution
     * 
     * Rules:
     * - Row version mismatch detection
     * - Head-only resolution UI
     * - Mandatory reason logging
     */
    async resolveConflict(
        conflict: ConflictResolution,
        userEmail: string
    ) {
        return await db.transaction(async (tx) => {
            // Verify user is HEAD role
            const user = await tx.execute(
                sql`SELECT role FROM users WHERE email = ${userEmail}`
            );

            if (!user.rows.length) {
                throw new Error('User not found');
            }

            const userRole = (user.rows[0] as any).role;

            if (!['PROCUREMENT_HEAD', 'BILLING_HEAD', 'ADMIN', 'SUPER_ADMIN'].includes(userRole)) {
                throw new Error('Only HEAD roles can resolve conflicts');
            }

            if (!conflict.reason || conflict.reason.trim().length < 10) {
                throw new Error('Conflict resolution requires a detailed reason (min 10 characters)');
            }

            // Log conflict resolution as audit event
            await tx.insert(auditEvents).values({
                entityType: `CONFLICT_${conflict.entityType}`,
                entityId: conflict.entityId,
                action: `RESOLVE_${conflict.resolution}`,
                beforeState: JSON.stringify({
                    local: conflict.localVersion,
                    server: conflict.serverVersion
                }),
                afterState: JSON.stringify({
                    resolution: conflict.resolution,
                    reason: conflict.reason
                }),
                actor: userEmail
            });

            // Apply resolution based on strategy
            // (Actual application logic would be in specific entity services)

            return {
                success: true,
                message: 'Conflict resolved successfully'
            };
        });
    }

    /**
     * Detect conflicts for offline sync
     */
    async detectConflicts(
        entityType: string,
        entityId: string,
        localTimestamp: Date,
        serverTimestamp: Date
    ) {
        if (localTimestamp.getTime() !== serverTimestamp.getTime()) {
            return {
                hasConflict: true,
                message: 'Version mismatch detected - requires HEAD resolution'
            };
        }

        return {
            hasConflict: false
        };
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\duty-sessions\duty-sessions.controller.ts
================================================================================
import { Controller, Get } from '@nestjs/common';
import { DutySessionsService } from './duty-sessions.service';

@Controller('duty-sessions')
export class DutySessionsController {
    constructor(private readonly service: DutySessionsService) { }

    @Get()
    async findAll() {
        return await this.service.findAll();
    }

    @Get('active')
    async findActive() {
        return await this.service.findActive();
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\duty-sessions\duty-sessions.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { DutySessionsController } from './duty-sessions.controller';
import { DutySessionsService } from './duty-sessions.service';

@Module({
    controllers: [DutySessionsController],
    providers: [DutySessionsService],
    exports: [DutySessionsService]
})
export class DutySessionsModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\duty-sessions\duty-sessions.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, dutySessions } from '@sahakar/database';
import { eq } from 'drizzle-orm';

@Injectable()
export class DutySessionsService {
    async findAll() {
        return await db.select().from(dutySessions);
    }

    async findActive() {
        return await db
            .select()
            .from(dutySessions)
            .where(eq(dutySessions.active, true));
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\name-changes\name-changes.controller.ts
================================================================================
import { Controller, Get, Param } from '@nestjs/common';
import { NameChangesService } from './name-changes.service';

@Controller('name-changes')
export class NameChangesController {
    constructor(private readonly service: NameChangesService) { }

    @Get()
    async findAll() {
        return await this.service.findAll();
    }

    @Get('product/:productId')
    async findByProduct(@Param('productId') productId: string) {
        return await this.service.findByProduct(productId);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\name-changes\name-changes.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { NameChangesController } from './name-changes.controller';
import { NameChangesService } from './name-changes.service';

@Module({
    controllers: [NameChangesController],
    providers: [NameChangesService],
    exports: [NameChangesService]
})
export class NameChangesModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\name-changes\name-changes.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, productNameChanges, products, suppliers } from '@sahakar/database';
import { eq } from 'drizzle-orm';

@Injectable()
export class NameChangesService {
    async findAll() {
        const result = await db
            .select({
                id: productNameChanges.id,
                productId: productNameChanges.productId,
                supplierId: productNameChanges.supplierId,
                oldName: productNameChanges.oldName,
                newName: productNameChanges.newName,
                reason: productNameChanges.reason,
                effectiveFrom: productNameChanges.effectiveFrom,
                effectiveTo: productNameChanges.effectiveTo,
                active: productNameChanges.active,
                createdAt: productNameChanges.createdAt,
                productName: products.itemName,
                supplierName: suppliers.supplierName
            })
            .from(productNameChanges)
            .leftJoin(products, eq(productNameChanges.productId, products.id))
            .leftJoin(suppliers, eq(productNameChanges.supplierId, suppliers.id))
            .orderBy(productNameChanges.createdAt);

        return result;
    }

    async findByProduct(productId: string) {
        return await db
            .select()
            .from(productNameChanges)
            .where(eq(productNameChanges.productId, productId));
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\order-slips\order-slips.controller.ts
================================================================================
import { Controller, Post, Body, Request } from '@nestjs/common';
import { OrderSlipsService } from './order-slips.service';

@Controller('order-slips')
export class OrderSlipsController {
    constructor(private readonly service: OrderSlipsService) { }

    @Post('generate')
    async generateSlips(
        @Body() data: {
            supplierIds: string[];
            slipDate: string;
            regenerate?: boolean;
        },
        @Request() req: any
    ) {
        const userEmail = req.user?.email || 'system@sahakar.local';
        return await this.service.generateSlips(
            data.supplierIds,
            data.slipDate,
            userEmail,
            data.regenerate || false
        );
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\order-slips\order-slips.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { OrderSlipsService } from './order-slips.service';
import { OrderSlipsController } from './order-slips.controller';

@Module({
    controllers: [OrderSlipsController],
    providers: [OrderSlipsService],
    exports: [OrderSlipsService]
})
export class OrderSlipsModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\order-slips\order-slips.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, pendingItems, repItems, orderSlips, orderSlipItems, auditEvents } from '@sahakar/database';
import { sql, eq, and } from 'drizzle-orm';

@Injectable()
export class OrderSlipsService {
    /**
     * Workflow 4: Order Slip Generation
     * 
     * Rules:
     * - Idempotency key: SLIP_{supplier}_{date}
     * - Aggregate from pending_po + rep_orders
     * - Only done=true items
     * - Regeneration control flag
     */
    async generateSlips(
        supplierIds: string[],
        slipDate: string,
        userEmail: string,
        regenerate: boolean = false
    ) {
        return await db.transaction(async (tx) => {
            const results = [];

            for (const supplierId of supplierIds) {
                // Idempotency check
                const lockKey = `SLIP_${supplierId}_${slipDate}`;
                const existingSlips = await tx
                    .select()
                    .from(orderSlips)
                    .where(
                        and(
                            eq(orderSlips.supplierId, supplierId),
                            sql`DATE(${orderSlips.slipDate}) = DATE(${slipDate})`
                        )
                    );

                if (existingSlips.length > 0 && !regenerate) {
                    results.push({ supplierId, skipped: true, reason: 'Slip already exists' });
                    continue;
                }

                // Delete existing if regenerating
                if (existingSlips.length > 0 && regenerate) {
                    for (const slip of existingSlips) {
                        await tx.delete(orderSlipItems).where(eq(orderSlipItems.orderSlipId, slip.id));
                        await tx.delete(orderSlips).where(eq(orderSlips.id, slip.id));
                    }
                }

                // Get pending items (stock + offer quantities)
                const pendingItemsForSlip = await tx
                    .select()
                    .from(pendingItems)
                    .where(
                        and(
                            eq(pendingItems.decidedSupplierId, supplierId),
                            eq(pendingItems.done, true),
                            eq(pendingItems.locked, false)
                        )
                    );

                // Get REP items
                const repItemsForSlip = await tx
                    .select()
                    .from(repItems)
                    .where(
                        and(
                            eq(repItems.orderedSupplierId, supplierId),
                            eq(repItems.done, true),
                            eq(repItems.state, 'READY_FOR_SLIP')
                        )
                    );

                const totalItems = pendingItemsForSlip.length + repItemsForSlip.length;

                if (totalItems === 0) {
                    results.push({ supplierId, skipped: true, reason: 'No items ready for slip' });
                    continue;
                }

                // Create order slip (slipDate is already a string from parameter)
                const slipResult = await tx.insert(orderSlips).values({
                    supplierId,
                    slipDate,
                    generatedBy: userEmail
                }).returning({ id: orderSlips.id });

                const slipId = slipResult[0].id;

                // Add pending items (stock + offer)
                for (const item of pendingItemsForSlip) {
                    const qty = (item.stockQty || 0) + (item.offerQty || 0);
                    if (qty > 0 && item.productId) {
                        await tx.insert(orderSlipItems).values({
                            orderSlipId: slipId,
                            productId: item.productId,
                            qty: qty,
                            status: 'PENDING'
                        });
                    }
                }

                // Add REP items
                for (const item of repItemsForSlip) {
                    if (item.productId) {
                        await tx.insert(orderSlipItems).values({
                            orderSlipId: slipId,
                            productId: item.productId,
                            qty: item.reqQty,
                            status: 'PENDING'
                        });
                    }

                    // Update REP item state
                    await tx.update(repItems)
                        .set({ state: 'SLIPPED' })
                        .where(eq(repItems.id, item.id));
                }

                // Lock pending items
                for (const item of pendingItemsForSlip) {
                    await tx.update(pendingItems)
                        .set({ locked: true, state: 'SLIPPED' })
                        .where(eq(pendingItems.id, item.id));
                }

                // Audit event
                await tx.insert(auditEvents).values({
                    entityType: 'ORDER_SLIP',
                    entityId: slipId,
                    action: 'GENERATE',
                    beforeState: null,
                    afterState: JSON.stringify({
                        supplierId,
                        slipDate,
                        pendingItems: pendingItemsForSlip.length,
                        repItems: repItemsForSlip.length
                    }),
                    actor: userEmail
                });

                results.push({ supplierId, slipId, itemCount: totalItems });
            }

            return { success: true, results };
        });
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\pending-po\pending-po.controller.ts
================================================================================
import { Controller, Put, Post, Body, Param, Request } from '@nestjs/common';
import { PendingPoService } from './pending-po.service';

@Controller('pending-po')
export class PendingPoController {
    constructor(private readonly service: PendingPoService) { }

    @Put(':id/allocate')
    async updateAllocation(
        @Param('id') id: string,
        @Body() data: {
            orderedQty: number;
            stockQty: number;
            offerQty: number;
            decidedSupplierId: string;
            allocatorNotes?: string;
            done: boolean;
        },
        @Request() req: any
    ) {
        const userEmail = req.user?.email || 'system@sahakar.local';
        return await this.service.updateAllocation(id, data, userEmail);
    }

    @Post(':id/move-to-rep')
    async moveToRep(@Param('id') id: string, @Request() req: any) {
        const userEmail = req.user?.email || 'system@sahakar.local';
        return await this.service.moveToRep(id, userEmail);
    }

    @Post('rep/:id/return')
    async returnFromRep(@Param('id') id: string, @Request() req: any) {
        const userEmail = req.user?.email || 'system@sahakar.local';
        return await this.service.returnFromRep(id, userEmail);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\pending-po\pending-po.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { PendingPoService } from './pending-po.service';
import { PendingPoController } from './pending-po.controller';

@Module({
    controllers: [PendingPoController],
    providers: [PendingPoService],
    exports: [PendingPoService]
})
export class PendingPoModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\pending-po\pending-po.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, pendingItems, repItems, auditEvents } from '@sahakar/database';
import { sql, eq, and } from 'drizzle-orm';

@Injectable()
export class PendingPoService {
    /**
     * Workflow 2: Pending PO Allocator
     * 
     * Rules:
     * - ordered_qty + stock_qty + offer_qty ≤ req_qty
     * - Must select supplier
     * - Lock after slip generation
     */
    async updateAllocation(
        pendingItemId: string,
        data: {
            orderedQty: number;
            stockQty: number;
            offerQty: number;
            decidedSupplierId: string;
            allocatorNotes?: string;
            done: boolean;
        },
        userEmail: string
    ) {
        return await db.transaction(async (tx) => {
            // Get current item
            const items = await tx.select().from(pendingItems).where(eq(pendingItems.id, pendingItemId)).limit(1);

            if (!items.length) {
                throw new Error('Pending item not found');
            }

            const item = items[0];

            // Validation: Cannot edit if locked
            if (item.locked) {
                throw new Error('Item is locked - already moved to REP or slipped');
            }

            // Validation: Quantity constraint
            const totalAllocated = data.orderedQty + data.stockQty + data.offerQty;
            if (totalAllocated > item.reqQty) {
                throw new Error(`Total allocation (${totalAllocated}) exceeds required quantity (${item.reqQty})`);
            }

            // Update pending item
            await tx.update(pendingItems)
                .set({
                    orderedQty: data.orderedQty,
                    stockQty: data.stockQty,
                    offerQty: data.offerQty,
                    decidedSupplierId: data.decidedSupplierId,
                    allocatorNotes: data.allocatorNotes,
                    done: data.done,
                    updatedAt: new Date()
                })
                .where(eq(pendingItems.id, pendingItemId));

            // Audit event
            await tx.insert(auditEvents).values({
                entityType: 'PENDING_PO',
                entityId: pendingItemId,
                action: 'ALLOCATE',
                beforeState: JSON.stringify(item),
                afterState: JSON.stringify({ ...item, ...data }),
                actor: userEmail
            });

            return { success: true };
        });
    }

    /**
     * Workflow 3: Move to REP
     * 
     * Rules:
     * - Atomic migration
     * - Lock pending item
     * - Create REP item
     * - Advisory lock: MOVE_TO_REP_{id}
     */
    async moveToRep(
        pendingItemId: string,
        userEmail: string
    ) {
        return await db.transaction(async (tx) => {
            // Advisory lock
            const lockHash = this.hashLockKey(`MOVE_TO_REP_${pendingItemId}`);
            await tx.execute(sql`SELECT pg_advisory_xact_lock(${lockHash})`);

            // Get pending item
            const items = await tx.select().from(pendingItems).where(eq(pendingItems.id, pendingItemId)).limit(1);

            if (!items.length) {
                throw new Error('Pending item not found');
            }

            const item = items[0];

            if (item.locked) {
                throw new Error('Item already locked');
            }

            if (!item.done) {
                throw new Error('Item must be marked done before moving to REP');
            }

            // Lock pending item
            await tx.update(pendingItems)
                .set({
                    locked: true,
                    state: 'MOVED_TO_REP',
                    updatedAt: new Date()
                })
                .where(eq(pendingItems.id, pendingItemId));

            // Create REP item
            const repItemId = await tx.insert(repItems).values({
                pendingItemId: pendingItemId,
                productId: item.productId,
                reqQty: item.orderedQty, // Only ordered quantity goes to REP
                notes: item.allocatorNotes || null,
                orderedSupplierId: item.decidedSupplierId,
                done: false,
                state: 'REP_ACTIVE'
            }).returning({ id: repItems.id });

            // Audit event
            await tx.insert(auditEvents).values({
                entityType: 'PENDING_PO',
                entityId: pendingItemId,
                action: 'MOVE_TO_REP',
                beforeState: JSON.stringify(item),
                afterState: JSON.stringify({ locked: true, state: 'MOVED_TO_REP', repItemId: repItemId[0].id }),
                actor: userEmail
            });

            return { success: true, repItemId: repItemId[0].id };
        });
    }

    /**
     * Return from REP to Pending
     */
    async returnFromRep(
        repItemId: string,
        userEmail: string
    ) {
        return await db.transaction(async (tx) => {
            // Get REP item
            const reps = await tx.select().from(repItems).where(eq(repItems.id, repItemId)).limit(1);

            if (!reps.length) {
                throw new Error('REP item not found');
            }

            const repItem = reps[0];

            if (!repItem.pendingItemId) {
                throw new Error('No associated pending item');
            }

            // Unlock pending item
            await tx.update(pendingItems)
                .set({
                    locked: false,
                    state: 'PENDING',
                    updatedAt: new Date()
                })
                .where(eq(pendingItems.id, repItem.pendingItemId));

            // Delete REP item
            await tx.delete(repItems).where(eq(repItems.id, repItemId));

            // Audit event
            await tx.insert(auditEvents).values({
                entityType: 'REP_ITEM',
                entityId: repItemId,
                action: 'RETURN_TO_PENDING',
                beforeState: JSON.stringify(repItem),
                afterState: null,
                actor: userEmail
            });

            return { success: true };
        });
    }

    private hashLockKey(key: string): number {
        const crypto = require('crypto');
        const hash = crypto.createHash('sha256').update(key).digest();
        return hash.readInt32BE(0);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\ppo-import\ppo-import.controller.ts
================================================================================
import {
    Controller,
    Post,
    Body,
    HttpCode,
    HttpStatus,
    UseGuards,
    Request,
    UseInterceptors,
    UploadedFile
} from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { Express } from 'express';
import { PpoImportService, ProcessOrdersResult } from './ppo-import.service';

interface ProcessOrdersDto {
    rows: Array<{
        acceptDatetime: string;
        customerId?: string;
        orderId?: string;
        productId?: string;
        legacyProductId?: string;
        productName?: string;
        packing?: string;
        category?: string;
        subcategory?: string;
        primarySupplier?: string;
        secondarySupplier?: string;
        rep?: string;
        mobile?: string;
        mrp?: number;
        reqQty: number;
        customerName?: string;
        acceptedTime?: string;
        oQty?: number;
        cQty?: number;
        modification?: string;
        stage?: string;
    }>;
}

@Controller('ppo/import')
export class PpoImportController {
    constructor(private readonly ppoImportService: PpoImportService) { }

    /**
     * POST /ppo/import/process
     * 
     * Endpoint to process PPO import rows
     * Requires: PROCUREMENT_HEAD or ADMIN role
     */
    @Post('process')
    @HttpCode(HttpStatus.OK)
    async processOrders(
        @Body() dto: ProcessOrdersDto,
        @Request() req: any
    ): Promise<{ success: boolean; message: string; data: ProcessOrdersResult }> {
        // Convert string dates to Date objects
        const rows = dto.rows.map(row => ({
            ...row,
            acceptDatetime: new Date(row.acceptDatetime)
        }));

        const userEmail = req.user?.email || 'system@sahakar.local';

        const result = await this.ppoImportService.processOrders(rows, userEmail);

        return {
            success: true,
            message: 'Orders processed successfully',
            data: result
        };
    }
    /**
     * POST /ppo/import/upload
     * 
     * Upload an Excel file for processing
     */
    @Post('upload')
    @UseInterceptors(FileInterceptor('file'))
    @HttpCode(HttpStatus.OK)
    async uploadFile(
        @UploadedFile() file: Express.Multer.File,
        @Request() req: any
    ): Promise<{ success: boolean; message: string; data: ProcessOrdersResult }> {
        if (!file) {
            throw new Error('No file uploaded');
        }

        const userEmail = req.user?.email || 'system@sahakar.local';
        const result = await this.ppoImportService.parseAndProcessOrders(file.buffer, userEmail);

        return {
            success: true,
            message: 'File processed successfully',
            data: result
        };
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\ppo-import\ppo-import.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { PpoImportService } from './ppo-import.service';
import { PpoImportController } from './ppo-import.controller';

@Module({
    controllers: [PpoImportController],
    providers: [PpoImportService],
    exports: [PpoImportService]
})
export class PpoImportModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\ppo-import\ppo-import.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db } from '@sahakar/database';
import { orderRequests, pendingItems, auditEvents, products } from '@sahakar/database';
import { sql, eq } from 'drizzle-orm';
import * as crypto from 'crypto';

interface OrderRow {
    acceptDatetime: Date;
    customerId?: string;
    orderId?: string;
    productId?: string; // UUID from system, optional if finding by legacy
    legacyProductId?: string; // ID from Excel
    productName?: string;
    packing?: string;
    category?: string;
    subcategory?: string;
    primarySupplier?: string;
    secondarySupplier?: string;
    rep?: string;
    mobile?: string;
    mrp?: number;
    reqQty: number;
    customerName?: string;
    acceptedTime?: string;
    oQty?: number;
    cQty?: number;
    modification?: string;
    stage?: string;
}

export interface ProcessOrdersResult {
    totalIngested: number;
    totalAggregated: number;
    pendingItemsCreated: number;
    pendingItemsUpdated: number;
    duplicatesSkipped: number;
}

@Injectable()
export class PpoImportService {
    /**
     * PPO Import → Process Orders Workflow
     * 
     * Canonical Spec Implementation:
     * - Product-level aggregation
     * - Append-only pending_po creation
     * - Advisory locks for concurrency
     * - Audit trail generation
     * - Hash-based deduplication
     */
    async processOrders(
        rows: OrderRow[],
        userEmail: string
    ): Promise<ProcessOrdersResult> {
        const result: ProcessOrdersResult = {
            totalIngested: rows.length,
            totalAggregated: 0,
            pendingItemsCreated: 0,
            pendingItemsUpdated: 0,
            duplicatesSkipped: 0
        };

        // Start transaction with advisory lock
        await db.transaction(async (tx) => {
            // 1. Acquire advisory lock for this date
            const acceptDate = rows[0]?.acceptDatetime;
            if (!acceptDate) {
                throw new Error('No accept date provided');
            }

            const lockKey = `PROCESS_ORDERS_${acceptDate.toISOString().split('T')[0]}`;
            const lockHash = this.hashLockKey(lockKey);

            await tx.execute(sql`SELECT pg_advisory_xact_lock(${lockHash})`);

            // 1a. Build Product Lookup Map (Legacy ID -> UUID)
            const legacyIds = rows.map(r => r.legacyProductId).filter(id => !!id);
            const productMap = new Map<string, string>(); // legacyId -> uuid

            if (legacyIds.length > 0) {
                const foundProducts = await tx
                    .select({ id: products.id, legacyId: products.legacyId })
                    .from(products)
                    .where(sql`${products.legacyId} IN ${legacyIds}`);

                foundProducts.forEach(p => {
                    if (p.legacyId) productMap.set(p.legacyId, p.id);
                });
            }

            // 2. Insert into order_requests (immutable, append-only)
            for (const row of rows) {
                // Resolve UUID from Legacy ID if possible
                const resolvedProductId = row.productId || (row.legacyProductId ? productMap.get(row.legacyProductId) : null);

                // Generate hash for deduplication
                const rowHash = this.generateRowHash({ ...row, productId: resolvedProductId || row.legacyProductId });

                try {
                    await tx.insert(orderRequests).values({
                        acceptDatetime: row.acceptDatetime,
                        customerId: row.customerId,
                        orderId: row.orderId,
                        productId: resolvedProductId, // Can be null
                        legacyProductId: row.legacyProductId,
                        productName: row.productName,
                        packing: row.packing,
                        category: row.category,
                        subcategory: row.subcategory,
                        primarySupplier: row.primarySupplier,
                        secondarySupplier: row.secondarySupplier,
                        rep: row.rep,
                        mobile: row.mobile,
                        mrp: row.mrp ? row.mrp.toString() : null,
                        reqQty: row.reqQty,
                        customerName: row.customerName,
                        acceptedTime: row.acceptedTime,
                        oQty: row.oQty,
                        cQty: row.cQty,
                        modification: row.modification,
                        stage: row.stage,
                        hash: rowHash
                    });
                } catch (error) {
                    // Hash conflict = duplicate, skip
                    if (error.code === '23505') {
                        result.duplicatesSkipped++;
                        continue;
                    }
                    console.error('Error processing row:', row, error);
                    // Don't throw for individual row errors, maybe? Or throw strictly?
                    // Canonical spec says skip duplicates, throw others.
                    throw error;
                }
            }

            // 3. Aggregate by product_id and accept_date
            const aggregated = await tx
                .select({
                    productId: orderRequests.productId,
                    acceptDate: orderRequests.acceptDatetime,
                    totalQty: sql<number>`SUM(${orderRequests.reqQty})`.as('total_qty'),
                    remarks: sql<string>`string_agg(
            CONCAT('Ord:', ${orderRequests.orderId}, ' Cust:', ${orderRequests.customerId}, ' Qty:', ${orderRequests.reqQty}),
            ', ' ORDER BY ${orderRequests.createdAt}
          )`.as('remarks')
                })
                .from(orderRequests)
                .where(
                    sql`DATE(${orderRequests.acceptDatetime}) = DATE(${acceptDate})`
                )
                .groupBy(orderRequests.productId, sql`DATE(${orderRequests.acceptDatetime})`);

            result.totalAggregated = aggregated.length;

            // 4. Upsert into pending_items
            for (const agg of aggregated) {
                if (!agg.productId) continue;

                // Check if pending item exists for this product
                const existing = await tx
                    .select()
                    .from(pendingItems)
                    .where(eq(pendingItems.productId, agg.productId))
                    .limit(1);

                if (existing.length > 0 && existing[0].state === 'PENDING' && !existing[0].locked) {
                    // Update existing (append remarks, add quantity)
                    await tx
                        .update(pendingItems)
                        .set({
                            reqQty: sql`${pendingItems.reqQty} + ${agg.totalQty}`,
                            allocatorNotes: sql`COALESCE(${pendingItems.allocatorNotes}, '') || '\n' || ${agg.remarks}`,
                            updatedAt: new Date()
                        })
                        .where(eq(pendingItems.id, existing[0].id));

                    result.pendingItemsUpdated++;
                } else {
                    // Create new pending item
                    await tx.insert(pendingItems).values({
                        productId: agg.productId,
                        reqQty: agg.totalQty,
                        orderedQty: 0,
                        stockQty: 0,
                        offerQty: 0,
                        allocatorNotes: agg.remarks,
                        decidedSupplierId: null,
                        done: false,
                        locked: false,
                        state: 'PENDING'
                    });

                    result.pendingItemsCreated++;
                }
            }

            // 5. Create audit event
            await tx.insert(auditEvents).values({
                entityType: 'PPO_IMPORT',
                entityId: null,
                action: 'PROCESS_ORDERS',
                beforeState: null,
                afterState: JSON.stringify({
                    acceptDate: acceptDate.toISOString(),
                    rowsProcessed: rows.length,
                    pendingItemsCreated: result.pendingItemsCreated,
                    pendingItemsUpdated: result.pendingItemsUpdated
                }),
                actor: userEmail,
                createdAt: new Date()
            });
        });

        return result;
    }



    /**
     * Parse Excel file and process orders
     */
    async parseAndProcessOrders(
        fileBuffer: Buffer,
        userEmail: string
    ): Promise<ProcessOrdersResult> {
        const XLSX = require('xlsx');
        const workbook = XLSX.read(fileBuffer, { type: 'buffer' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];

        // Convert to JSON
        const rawRows = XLSX.utils.sheet_to_json(sheet);

        // Map to OrderRow
        const rows: OrderRow[] = rawRows.map((row: any) => ({
            acceptDatetime: new Date(), // Will be set below
            customerId: row['Customer id']?.toString(),
            customerName: row['Customer Name']?.toString(),
            orderId: row['order_id']?.toString(),
            legacyProductId: row['Product id']?.toString(),
            productId: undefined, // Will be looked up
            productName: row['product_name']?.toString(),
            packing: row['Packing']?.toString(),
            category: undefined, // Not in Excel
            subcategory: row['Subcategory']?.toString(),
            primarySupplier: row['Primary Sup']?.toString(),
            secondarySupplier: row['Secondary Sup']?.toString(),
            rep: row['Rep']?.toString(),
            mobile: row['Mobile']?.toString(),
            mrp: parseFloat(row['mrp'] || '0'),
            reqQty: parseInt(row['Req Qty'] || '0', 10),
            acceptedTime: row['Accepted Time']?.toString(),
            oQty: parseInt(row['O.Qty'] || '0', 10),
            cQty: parseInt(row['C.Qty'] || '0', 10),
            modification: row['Modification']?.toString(),
            stage: row['Stage']?.toString()
        }));

        // Validation: Must have at least a product ID (legacy or uuid) and qty
        const validRows = rows.filter(r => (r.productId || r.legacyProductId) && r.reqQty > 0);

        if (validRows.length === 0) {
            throw new Error('No valid rows found in Excel file');
        }

        // Use acceptDatetime from Excel 'Accept date' column
        const firstRowDate = rawRows[0]?.['Accept date'];
        let importDate = new Date();

        if (firstRowDate) {
            // Handle date parsing - could be Date object or string like "3-1-2026"
            if (firstRowDate instanceof Date) {
                importDate = firstRowDate;
            } else {
                // Parse string format "d-m-yyyy" or similar
                const parts = firstRowDate.toString().split('-');
                if (parts.length === 3) {
                    // Assume d-m-yyyy format
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1; // JS months are 0-indexed
                    const year = parseInt(parts[2], 10);
                    importDate = new Date(year, month, day);
                }
            }
        }

        validRows.forEach(r => r.acceptDatetime = importDate);

        return this.processOrders(validRows, userEmail);
    }

    /**
     * Generate hash for row deduplication
     */
    private generateRowHash(row: OrderRow): string {
        const hashInput = `${row.acceptDatetime.toISOString()}|${row.orderId}|${row.productId}|${row.reqQty}`;
        return crypto.createHash('sha256').update(hashInput).digest('hex');
    }

    /**
     * Generate numeric hash for PostgreSQL advisory lock
     */
    private hashLockKey(key: string): number {
        const hash = crypto.createHash('sha256').update(key).digest();
        return hash.readInt32BE(0);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\products\products.controller.ts
================================================================================
import { Controller, Get, Post, Put, Delete, Body, Param, Query } from '@nestjs/common';
import { ProductsService } from './products.service';

@Controller('products')
export class ProductsController {
    constructor(private readonly service: ProductsService) { }

    @Get()
    async findAll(@Query('search') search?: string) {
        return await this.service.findAll(search);
    }

    @Get(':id')
    async findOne(@Param('id') id: string) {
        return await this.service.findOne(id);
    }

    @Post()
    async create(
        @Body()
        data: {
            legacyId?: string;
            productCode?: string;
            itemName: string;
            packing?: string;
            category?: string;
            subcategory?: string;
            mrp?: number;
        }
    ) {
        return await this.service.create(data);
    }

    @Put(':id')
    async update(
        @Param('id') id: string,
        @Body()
        data: {
            legacyId?: string;
            productCode?: string;
            itemName?: string;
            packing?: string;
            category?: string;
            subcategory?: string;
            mrp?: number;
            active?: boolean;
        }
    ) {
        return await this.service.update(id, data);
    }

    @Delete(':id')
    async delete(@Param('id') id: string) {
        return await this.service.delete(id);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\products\products.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { ProductsController } from './products.controller';
import { ProductsService } from './products.service';

@Module({
    controllers: [ProductsController],
    providers: [ProductsService],
    exports: [ProductsService]
})
export class ProductsModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\products\products.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, products } from '@sahakar/database';
import { eq, like, or } from 'drizzle-orm';

@Injectable()
export class ProductsService {
    async findAll(search?: string) {
        if (search) {
            return await db
                .select()
                .from(products)
                .where(
                    or(
                        like(products.itemName, `%${search}%`),
                        like(products.productCode, `%${search}%`),
                        like(products.legacyId, `%${search}%`)
                    )
                );
        }
        return await db.select().from(products);
    }

    async findOne(id: string) {
        const result = await db
            .select()
            .from(products)
            .where(eq(products.id, id));
        return result[0] || null;
    }

    async create(data: {
        legacyId?: string;
        productCode?: string;
        itemName: string;
        packing?: string;
        category?: string;
        subcategory?: string;
        mrp?: number | string;
    }) {
        const createData: any = { ...data };
        if (typeof createData.mrp === 'string') {
            createData.mrp = parseFloat(createData.mrp);
        }
        const result = await db.insert(products).values(createData).returning();
        return result[0];
    }

    async update(id: string, data: {
        legacyId?: string;
        productCode?: string;
        itemName?: string;
        packing?: string;
        category?: string;
        subcategory?: string;
        mrp?: number | string;
        active?: boolean;
    }) {
        const updateData: any = { ...data, updatedAt: new Date() };
        if (typeof updateData.mrp === 'string') {
            updateData.mrp = parseFloat(updateData.mrp);
        }
        const result = await db
            .update(products)
            .set(updateData)
            .where(eq(products.id, id))
            .returning();
        return result[0] || null;
    }

    async delete(id: string) {
        // Soft delete by setting active = false
        return await this.update(id, { active: false });
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\rep-master\rep-master.controller.ts
================================================================================
import { Controller, Get, Post, Put, Delete, Body, Param, Query } from '@nestjs/common';
import { RepMasterService } from './rep-master.service';

@Controller('rep-master')
export class RepMasterController {
    constructor(private readonly service: RepMasterService) { }

    @Get()
    async findAll(@Query('search') search?: string) {
        return await this.service.findAll(search);
    }

    @Get(':id')
    async findOne(@Param('id') id: string) {
        return await this.service.findOne(id);
    }

    @Post()
    async create(
        @Body()
        data: {
            name: string;
            mobile?: string;
            email?: string;
            designation?: string;
        }
    ) {
        return await this.service.create(data);
    }

    @Put(':id')
    async update(
        @Param('id') id: string,
        @Body()
        data: {
            name?: string;
            mobile?: string;
            email?: string;
            designation?: string;
            active?: boolean;
        }
    ) {
        return await this.service.update(id, data);
    }

    @Delete(':id')
    async delete(@Param('id') id: string) {
        return await this.service.delete(id);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\rep-master\rep-master.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { RepMasterController } from './rep-master.controller';
import { RepMasterService } from './rep-master.service';

@Module({
    controllers: [RepMasterController],
    providers: [RepMasterService],
    exports: [RepMasterService]
})
export class RepMasterModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\rep-master\rep-master.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, repMaster } from '@sahakar/database';
import { eq, like, or } from 'drizzle-orm';

@Injectable()
export class RepMasterService {
    async findAll(search?: string) {
        if (search) {
            return await db
                .select()
                .from(repMaster)
                .where(
                    or(
                        like(repMaster.name, `%${search}%`),
                        like(repMaster.mobile, `%${search}%`),
                        like(repMaster.designation, `%${search}%`)
                    )
                );
        }
        return await db.select().from(repMaster);
    }

    async findOne(id: string) {
        const result = await db
            .select()
            .from(repMaster)
            .where(eq(repMaster.id, id));
        return result[0] || null;
    }

    async create(data: {
        name: string;
        mobile?: string;
        email?: string;
        designation?: string;
    }) {
        const result = await db.insert(repMaster).values(data).returning();
        return result[0];
    }

    async update(id: string, data: {
        name?: string;
        mobile?: string;
        email?: string;
        designation?: string;
        active?: boolean;
    }) {
        const result = await db
            .update(repMaster)
            .set({ ...data, updatedAt: new Date() })
            .where(eq(repMaster.id, id))
            .returning();
        return result[0] || null;
    }

    async delete(id: string) {
        return await this.update(id, { active: false });
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\settings\settings.controller.ts
================================================================================
import { Controller, Get, Put, Body } from '@nestjs/common';
import { SettingsService } from './settings.service';

@Controller('settings')
export class SettingsController {
    constructor(private readonly service: SettingsService) { }

    @Get()
    async getSettings() {
        return await this.service.getSettings();
    }

    @Put()
    async updateSettings(
        @Body() data: {
            dateFormat?: string;
            currency?: string;
            timezone?: string;
            autoBackup?: boolean;
            notificationsEnabled?: boolean;
        }
    ) {
        return await this.service.updateSettings(data);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\settings\settings.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { SettingsController } from './settings.controller';
import { SettingsService } from './settings.service';

@Module({
    controllers: [SettingsController],
    providers: [SettingsService],
    exports: [SettingsService]
})
export class SettingsModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\settings\settings.service.ts
================================================================================
import { Injectable } from '@nestjs/common';

export interface AppSettings {
    dateFormat: string;
    currency: string;
    timezone: string;
    autoBackup: boolean;
    notificationsEnabled: boolean;
}

@Injectable()
export class SettingsService {
    // In-memory storage (replace with database in production)
    private settings: AppSettings = {
        dateFormat: 'DD/MM/YYYY',
        currency: 'INR',
        timezone: 'Asia/Kolkata',
        autoBackup: true,
        notificationsEnabled: true
    };

    async getSettings(): Promise<AppSettings> {
        return this.settings;
    }

    async updateSettings(data: Partial<AppSettings>): Promise<AppSettings> {
        this.settings = { ...this.settings, ...data };
        return this.settings;
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\suppliers\suppliers.controller.ts
================================================================================
import { Controller, Get, Post, Put, Delete, Body, Param, Query } from '@nestjs/common';
import { SuppliersService } from './suppliers.service';

@Controller('suppliers')
export class SuppliersController {
    constructor(private readonly service: SuppliersService) { }

    @Get()
    async findAll(@Query('search') search?: string) {
        return await this.service.findAll(search);
    }

    @Get(':id')
    async findOne(@Param('id') id: string) {
        return await this.service.findOne(id);
    }

    @Post()
    async create(
        @Body()
        data: {
            supplierCode?: string;
            supplierName: string;
            contactPerson?: string;
            mobile?: string;
            email?: string;
            gstNumber?: string;
            address?: string;
            creditDays?: number;
        }
    ) {
        return await this.service.create(data);
    }

    @Put(':id')
    async update(
        @Param('id') id: string,
        @Body()
        data: {
            supplierCode?: string;
            supplierName?: string;
            contactPerson?: string;
            mobile?: string;
            email?: string;
            gstNumber?: string;
            address?: string;
            creditDays?: number;
            active?: boolean;
        }
    ) {
        return await this.service.update(id, data);
    }

    @Delete(':id')
    async delete(@Param('id') id: string) {
        return await this.service.delete(id);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\suppliers\suppliers.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { SuppliersController } from './suppliers.controller';
import { SuppliersService } from './suppliers.service';

@Module({
    controllers: [SuppliersController],
    providers: [SuppliersService],
    exports: [SuppliersService]
})
export class SuppliersModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\suppliers\suppliers.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, suppliers } from '@sahakar/database';
import { eq, like, or } from 'drizzle-orm';

@Injectable()
export class SuppliersService {
    async findAll(search?: string) {
        if (search) {
            return await db
                .select()
                .from(suppliers)
                .where(
                    or(
                        like(suppliers.supplierName, `%${search}%`),
                        like(suppliers.supplierCode, `%${search}%`),
                        like(suppliers.contactPerson, `%${search}%`)
                    )
                );
        }
        return await db.select().from(suppliers);
    }

    async findOne(id: string) {
        const result = await db
            .select()
            .from(suppliers)
            .where(eq(suppliers.id, id));
        return result[0] || null;
    }

    async create(data: {
        supplierCode?: string;
        supplierName: string;
        contactPerson?: string;
        mobile?: string;
        email?: string;
        gstNumber?: string;
        address?: string;
        creditDays?: number | string;
    }) {
        const createData: any = { ...data };
        if (typeof createData.creditDays === 'string') {
            createData.creditDays = parseInt(createData.creditDays);
        }
        const result = await db.insert(suppliers).values(createData).returning();
        return result[0];
    }

    async update(id: string, data: {
        supplierCode?: string;
        supplierName?: string;
        contactPerson?: string;
        mobile?: string;
        email?: string;
        gstNumber?: string;
        address?: string;
        creditDays?: number | string;
        active?: boolean;
    }) {
        const updateData: any = { ...data, updatedAt: new Date() };
        if (typeof updateData.creditDays === 'string') {
            updateData.creditDays = parseInt(updateData.creditDays);
        }
        const result = await db
            .update(suppliers)
            .set(updateData)
            .where(eq(suppliers.id, id))
            .returning();
        return result[0] || null;
    }

    async delete(id: string) {
        return await this.update(id, { active: false });
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\users\users.controller.ts
================================================================================
import { Controller, Get, Put, Param, Body, Query } from '@nestjs/common';
import { UsersService } from './users.service';

@Controller('users')
export class UsersController {
    constructor(private readonly service: UsersService) { }

    @Get()
    async findAll(@Query('search') search?: string) {
        return await this.service.findAll(search);
    }

    @Get(':id')
    async findOne(@Param('id') id: string) {
        return await this.service.findOne(id);
    }

    @Put(':id')
    async update(
        @Param('id') id: string,
        @Body() data: {
            name?: string;
            role?: 'SUPER_ADMIN' | 'ADMIN' | 'PROCUREMENT_HEAD' | 'PURCHASE_STAFF' | 'BILLING_HEAD' | 'BILLING_STAFF';
            active?: boolean;
        }
    ) {
        return await this.service.update(id, data);
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\users\users.module.ts
================================================================================
import { Module } from '@nestjs/common';
import { UsersController } from './users.controller';
import { UsersService } from './users.service';

@Module({
    controllers: [UsersController],
    providers: [UsersService],
    exports: [UsersService]
})
export class UsersModule { }




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\modules\users\users.service.ts
================================================================================
import { Injectable } from '@nestjs/common';
import { db, users } from '@sahakar/database';
import { eq, like, or } from 'drizzle-orm';

@Injectable()
export class UsersService {
    async findAll(search?: string) {
        if (search) {
            return await db
                .select()
                .from(users)
                .where(
                    or(
                        like(users.name, `%${search}%`),
                        like(users.email, `%${search}%`)
                    )
                );
        }
        return await db.select().from(users);
    }

    async findOne(id: string) {
        const result = await db.select().from(users).where(eq(users.id, id));
        return result[0] || null;
    }

    async update(id: string, data: {
        name?: string;
        role?: 'SUPER_ADMIN' | 'ADMIN' | 'PROCUREMENT_HEAD' | 'PURCHASE_STAFF' | 'BILLING_HEAD' | 'BILLING_STAFF';
        active?: boolean;
    }) {
        const result = await db
            .update(users)
            .set({ ...data, updatedAt: new Date() })
            .where(eq(users.id, id))
            .returning();
        return result[0] || null;
    }
}




================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\app.module.ts
================================================================================
import { Module, NestModule, MiddlewareConsumer, RequestMethod } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { AuthModule } from './modules/auth/auth.module';
import { PpoImportModule } from './modules/ppo-import/ppo-import.module';
import { PendingPoModule } from './modules/pending-po/pending-po.module';
import { OrderSlipsModule } from './modules/order-slips/order-slips.module';
import { BillingModule } from './modules/billing/billing.module';
import { ConflictModule } from './modules/conflict/conflict.module';
import { ProductsModule } from './modules/products/products.module';
import { SuppliersModule } from './modules/suppliers/suppliers.module';
import { RepMasterModule } from './modules/rep-master/rep-master.module';
import { UsersModule } from './modules/users/users.module';
import { DutySessionsModule } from './modules/duty-sessions/duty-sessions.module';
import { AuditLogsModule } from './modules/audit-logs/audit-logs.module';
import { NameChangesModule } from './modules/name-changes/name-changes.module';
import { SettingsModule } from './modules/settings/settings.module';
import { RawBodyMiddleware } from './common/middleware/raw-body.middleware';

@Module({
    imports: [
        ConfigModule.forRoot({
            isGlobal: true,
            envFilePath: '.env',
        }),
        AuthModule,
        PpoImportModule,
        PendingPoModule,
        OrderSlipsModule,
        BillingModule,
        ConflictModule,
        ProductsModule,
        SuppliersModule,
        RepMasterModule,
        UsersModule,
        DutySessionsModule,
        AuditLogsModule,
        NameChangesModule,
        SettingsModule
    ],
    controllers: [],
    providers: [],
})
export class AppModule implements NestModule {
    configure(consumer: MiddlewareConsumer) {
        consumer
            .apply(RawBodyMiddleware)
            .forRoutes({ path: 'ppo/import/upload', method: RequestMethod.POST });
    }
}





================================================================================
FILE: D:\K4NN4N\Sahakar-PPO\apps\api\src\main.ts
================================================================================
import { NestFactory } from '@nestjs/core';
import { ExpressAdapter } from '@nestjs/platform-express';
import { AppModule } from './app.module';
import * as express from 'express';
import * as functions from 'firebase-functions/v1';

const server = express();
let appInitialized = false;

const bootstrap = async (expressInstance) => {
    const app = await NestFactory.create(
        AppModule,
        new ExpressAdapter(expressInstance),
    );
    app.enableCors({
        origin: true,
        methods: 'GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS',
        credentials: true,
    });
    await app.init();
    appInitialized = true;
};

export const api = functions
    .region('asia-south1')
    .runWith({ timeoutSeconds: 300, memory: '512MB' })
    .https.onRequest(async (req, res) => {
        if (!appInitialized) {
            await bootstrap(server);
        }
        server(req, res);
    });

// Local bootstrap removed to prevent deployment analysis side-effects




